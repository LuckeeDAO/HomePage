<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>IPFS存储策略设计说明书</title>
    <style>
        body {
            max-width: 860px;
            margin: 32px auto;
            padding: 0 16px;
            font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            line-height: 1.6;
            color: #1f2937;
        }
        pre { background:#f8fafc; padding:12px; overflow:auto; border-radius:6px; }
        code { background:#f1f5f9; padding:2px 4px; border-radius:4px; }
        h1,h2,h3,h4,h5,h6 { line-height:1.25; }
        a { color:#2563eb; text-decoration:none; }
        a:hover { text-decoration:underline; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #e5e7eb; padding: 8px; }
        blockquote { margin: 0; padding-left: 1em; border-left: 4px solid #e5e7eb; color:#6b7280; }
    </style>
</head>
<body>
<h1 id="ipfs">IPFS存储策略设计说明书</h1>
<blockquote>
<p>用词规范：请参阅《<a href="../项目术语表.html">项目术语表</a>》以确保术语统一。</p>
</blockquote>
<h2 id="1">1. 概述</h2>
<h3 id="11">1.1 设计目标</h3>
<p>本系统采用<strong>IPFS（InterPlanetary File System）</strong>作为主要存储方案，完全替代传统的"链下存储"概念。通过IPFS的去中心化特性，实现数据的高可用性、不可篡改性和成本效益的完美平衡。</p>
<h3 id="12-ipfs">1.2 为什么选择IPFS替代链下存储？</h3>
<h4 id="123-nft">1.2.3 与NFT类型驱动的集成优势与边界</h4>
<ul>
<li><strong>投票项目属性接口</strong>：投票项目管理作为NFT管理的属性接口，其配置均为NFT类型的全局参数；完整配置/版本明细写入IPFS，链上仅保存CID/哈希</li>
<li><strong>NFT元数据存储</strong>：每个NFT类型的元数据与相关配置存储在IPFS上</li>
<li><strong>状态变量同步</strong>：NFT状态变量的变更以CID/哈希形式同步至链上进行完整性验证</li>
<li><strong>数据边界清晰</strong>：详细投票数据（承诺/揭示、参与者、计算过程与证明）位于IPFS；链上仅保留账户-NFT关联与结果摘要</li>
<li><strong>去中心化一致性</strong>：IPFS与区块链双重验证确保数据一致性</li>
</ul>
<h4 id="121">1.2.1 传统链下存储的问题</h4>
<ul>
<li><strong>中心化风险</strong>：依赖单一存储服务提供商</li>
<li><strong>成本控制</strong>：存储费用难以预测和控制</li>
<li><strong>数据主权</strong>：数据控制权不完全在用户手中</li>
<li><strong>可用性风险</strong>：服务中断导致数据不可访问</li>
</ul>
<h4 id="122-ipfs">1.2.2 IPFS的优势</h4>
<ul>
<li><strong>完全去中心化</strong>：数据分布在全球节点网络中</li>
<li><strong>零成本存储</strong>：无需支付存储费用</li>
<li><strong>数据主权</strong>：用户完全控制自己的数据</li>
<li><strong>高可用性</strong>：多节点冗余，避免单点故障</li>
<li><strong>内容寻址</strong>：通过哈希确保数据完整性</li>
</ul>
<h2 id="2-ipfs">2. IPFS存储架构设计</h2>
<h3 id="21">2.1 整体架构</h3>
<div class="codehilite"><pre><span></span><code>┌─────────────────────────────────────────────────────────────┐
│                    客户端应用层                              │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                   IPFS存储适配层                             │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │ 本地IPFS节点│ │ 公共网关    │ │ 固定服务    │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                   IPFS网络层                                 │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │ 内容寻址    │ │ 分布式哈希表│ │ 块交换协议  │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────┬───────────────────────────────────────┘
                      │
┌─────────────────────▼───────────────────────────────────────┐
│                   区块链验证层                               │
│  ┌─────────────┐ ┌─────────────┐ ┌─────────────┐          │
│  │ 数据哈希    │ │ 存储证明    │ │ 访问控制    │          │
│  └─────────────┘ └─────────────┘ └─────────────┘          │
└─────────────────────────────────────────────────────────────┘
</code></pre></div>

<h3 id="22">2.2 存储层次结构</h3>
<h4 id="221-ipfs">2.2.1 主要存储层（IPFS）</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">IPFSStorageLayer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">LocalNode</span><span class="p">,</span><span class="w">      </span><span class="c1">// 本地IPFS节点</span>
<span class="w">    </span><span class="n">PublicGateway</span><span class="p">,</span><span class="w">  </span><span class="c1">// 公共网关</span>
<span class="w">    </span><span class="n">PinningService</span><span class="p">,</span><span class="w"> </span><span class="c1">// 固定服务</span>
<span class="w">    </span><span class="n">Distributed</span><span class="p">,</span><span class="w">    </span><span class="c1">// 分布式网络</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="222">2.2.2 验证层（区块链）</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">BlockchainVerification</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">DataHash</span><span class="p">,</span><span class="w">       </span><span class="c1">// 数据哈希存储</span>
<span class="w">    </span><span class="n">StorageProof</span><span class="p">,</span><span class="w">   </span><span class="c1">// 存储证明</span>
<span class="w">    </span><span class="n">AccessControl</span><span class="p">,</span><span class="w">  </span><span class="c1">// 访问控制</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="3">3. 核心数据结构</h2>
<h3 id="31-ipfs">3.1 IPFS配置结构</h3>
<div class="codehilite"><pre><span></span><code><span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">IPFSConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">gateway_urls</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w">           </span><span class="c1">// 公共网关列表</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">local_node</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">LocalIPFSNode</span><span class="o">&gt;</span><span class="p">,</span><span class="w">   </span><span class="c1">// 本地节点配置</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">pinning_services</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">PinningService</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 固定服务配置</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">redundancy_factor</span>: <span class="kt">u32</span><span class="p">,</span><span class="w">              </span><span class="c1">// 冗余因子</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">data_retention_days</span>: <span class="kt">u32</span><span class="p">,</span><span class="w">            </span><span class="c1">// 数据保留天数</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">compression_enabled</span>: <span class="kt">bool</span><span class="p">,</span><span class="w">           </span><span class="c1">// 是否启用压缩</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">encryption_enabled</span>: <span class="kt">bool</span><span class="p">,</span><span class="w">            </span><span class="c1">// 是否启用加密</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LocalIPFSNode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">api_url</span>: <span class="nb">String</span><span class="p">,</span><span class="w">                     </span><span class="c1">// API端点</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">data_path</span>: <span class="nb">String</span><span class="p">,</span><span class="w">                   </span><span class="c1">// 数据存储路径</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">max_storage_gb</span>: <span class="kt">u64</span><span class="p">,</span><span class="w">                 </span><span class="c1">// 最大存储容量</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">auto_gc</span>: <span class="kt">bool</span><span class="p">,</span><span class="w">                       </span><span class="c1">// 自动垃圾回收</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">gc_interval_hours</span>: <span class="kt">u32</span><span class="p">,</span><span class="w">              </span><span class="c1">// 垃圾回收间隔</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">PinningService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span><span class="w">                        </span><span class="c1">// 服务名称</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">api_key</span>: <span class="nb">String</span><span class="p">,</span><span class="w">                     </span><span class="c1">// API密钥</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">endpoint</span>: <span class="nb">String</span><span class="p">,</span><span class="w">                    </span><span class="c1">// 服务端点</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">cost_per_gb</span>: <span class="kt">f64</span><span class="p">,</span><span class="w">                   </span><span class="c1">// 每GB成本</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">max_file_size_gb</span>: <span class="kt">u64</span><span class="p">,</span><span class="w">              </span><span class="c1">// 最大文件大小</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">retention_policy</span>: <span class="nc">RetentionPolicy</span><span class="p">,</span><span class="w">  </span><span class="c1">// 保留策略</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">RetentionPolicy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Permanent</span><span class="p">,</span><span class="w">                               </span><span class="c1">// 永久保留</span>
<span class="w">    </span><span class="n">TimeBased</span><span class="p">(</span><span class="n">Duration</span><span class="p">),</span><span class="w">                     </span><span class="c1">// 基于时间</span>
<span class="w">    </span><span class="n">UsageBased</span><span class="p">(</span><span class="kt">u32</span><span class="p">),</span><span class="w">                        </span><span class="c1">// 基于使用量</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="32">3.2 存储结果结构</h3>
<div class="codehilite"><pre><span></span><code><span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">IPFSStorageResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">content_id</span>: <span class="nb">String</span><span class="p">,</span><span class="w">                  </span><span class="c1">// IPFS CID</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">storage_locations</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">StorageLocation</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 存储位置</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">metadata</span>: <span class="nc">StorageMetadata</span><span class="p">,</span><span class="w">           </span><span class="c1">// 存储元数据</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">verification</span>: <span class="nc">StorageVerification</span><span class="p">,</span><span class="w">   </span><span class="c1">// 验证信息</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">StorageLocation</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">provider</span>: <span class="nc">StorageProvider</span><span class="p">,</span><span class="w">           </span><span class="c1">// 存储提供商</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">url</span>: <span class="nb">String</span><span class="p">,</span><span class="w">                         </span><span class="c1">// 访问URL</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">status</span>: <span class="nc">StorageStatus</span><span class="p">,</span><span class="w">               </span><span class="c1">// 存储状态</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">last_verified</span>: <span class="kt">u64</span><span class="p">,</span><span class="w">                  </span><span class="c1">// 最后验证时间</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">StorageProvider</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">LocalIPFS</span><span class="p">,</span><span class="w">                               </span><span class="c1">// 本地IPFS节点</span>
<span class="w">    </span><span class="n">PublicGateway</span><span class="p">(</span><span class="nb">String</span><span class="p">),</span><span class="w">                   </span><span class="c1">// 公共网关</span>
<span class="w">    </span><span class="n">PinningService</span><span class="p">(</span><span class="nb">String</span><span class="p">),</span><span class="w">                  </span><span class="c1">// 固定服务</span>
<span class="w">    </span><span class="n">Distributed</span><span class="p">,</span><span class="w">                             </span><span class="c1">// 分布式网络</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">StorageStatus</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Available</span><span class="p">,</span><span class="w">                               </span><span class="c1">// 可用</span>
<span class="w">    </span><span class="n">Pending</span><span class="p">,</span><span class="w">                                 </span><span class="c1">// 待处理</span>
<span class="w">    </span><span class="n">Failed</span><span class="p">,</span><span class="w">                                  </span><span class="c1">// 失败</span>
<span class="w">    </span><span class="n">Unavailable</span><span class="p">,</span><span class="w">                             </span><span class="c1">// 不可用</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="4">4. 存储策略实现</h2>
<h3 id="41">4.1 主要存储策略</h3>
<div class="codehilite"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">StorageStrategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">store_to_ipfs_with_redundancy</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">data</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">],</span>
<span class="w">        </span><span class="n">data_type</span>: <span class="nc">DataType</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">IPFSStorageResult</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">storage_locations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 1. 数据预处理</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">processed_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">preprocess_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">data_type</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 2. 存储到本地IPFS节点</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">local_node</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">ipfs_config</span><span class="p">.</span><span class="n">local_node</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">local_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">store_to_local_ipfs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">processed_data</span><span class="p">,</span><span class="w"> </span><span class="n">local_node</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">storage_locations</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">local_result</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 3. 存储到公共网关</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">gateway</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">ipfs_config</span><span class="p">.</span><span class="n">gateway_urls</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">gateway_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">store_to_public_gateway</span><span class="p">(</span><span class="o">&amp;</span><span class="n">processed_data</span><span class="p">,</span><span class="w"> </span><span class="n">gateway</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">storage_locations</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">gateway_result</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 4. 使用固定服务</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">ipfs_config</span><span class="p">.</span><span class="n">pinning_services</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">service_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">pin_to_service</span><span class="p">(</span><span class="o">&amp;</span><span class="n">processed_data</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">storage_locations</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">service_result</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 5. 分布式存储</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">distributed_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">store_to_distributed_network</span><span class="p">(</span><span class="o">&amp;</span><span class="n">processed_data</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">storage_locations</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">distributed_result</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 6. 生成存储结果</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">IPFSStorageResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">content_id</span>: <span class="nc">processed_data</span><span class="p">.</span><span class="n">cid</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">storage_locations</span><span class="p">,</span>
<span class="w">            </span><span class="n">metadata</span>: <span class="nc">processed_data</span><span class="p">.</span><span class="n">metadata</span><span class="p">,</span>
<span class="w">            </span><span class="n">verification</span>: <span class="nc">self</span><span class="p">.</span><span class="n">generate_verification</span><span class="p">(</span><span class="o">&amp;</span><span class="n">processed_data</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="42">4.2 数据预处理</h3>
<div class="codehilite"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">StorageStrategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">preprocess_data</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">data</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">],</span>
<span class="w">        </span><span class="n">data_type</span>: <span class="nc">DataType</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">ProcessedData</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">processed_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">to_vec</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 1. 数据压缩</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ipfs_config</span><span class="p">.</span><span class="n">compression_enabled</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">processed_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">compress_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">processed_data</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 2. 数据加密（可选）</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ipfs_config</span><span class="p">.</span><span class="n">encryption_enabled</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">processed_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">encrypt_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">processed_data</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 3. 生成IPFS CID</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">cid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_ipfs_cid</span><span class="p">(</span><span class="o">&amp;</span><span class="n">processed_data</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 4. 创建元数据</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StorageMetadata</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">original_size</span>: <span class="nc">data</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span>
<span class="w">            </span><span class="n">compressed_size</span>: <span class="nc">processed_data</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span>
<span class="w">            </span><span class="n">compression_ratio</span>: <span class="nc">data</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">processed_data</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">f64</span><span class="p">,</span>
<span class="w">            </span><span class="n">encryption_enabled</span>: <span class="nc">self</span><span class="p">.</span><span class="n">ipfs_config</span><span class="p">.</span><span class="n">encryption_enabled</span><span class="p">,</span>
<span class="w">            </span><span class="n">data_type</span><span class="p">,</span>
<span class="w">            </span><span class="n">created_at</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">ProcessedData</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">data</span>: <span class="nc">processed_data</span><span class="p">,</span>
<span class="w">            </span><span class="n">cid</span><span class="p">,</span>
<span class="w">            </span><span class="n">metadata</span><span class="p">,</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="43-ipfs">4.3 本地IPFS节点存储</h3>
<div class="codehilite"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">StorageStrategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">store_to_local_ipfs</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">data</span>: <span class="kp">&amp;</span><span class="nc">ProcessedData</span><span class="p">,</span>
<span class="w">        </span><span class="n">local_node</span>: <span class="kp">&amp;</span><span class="nc">LocalIPFSNode</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">StorageLocation</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 1. 检查存储容量</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">available_space</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">check_available_space</span><span class="p">(</span><span class="n">local_node</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">available_space</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Insufficient storage space&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 2. 存储到IPFS</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">cid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ipfs_client</span><span class="p">.</span><span class="n">add_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 3. 固定数据（防止垃圾回收）</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">ipfs_client</span><span class="p">.</span><span class="n">pin_add</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cid</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 4. 验证存储</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">stored_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ipfs_client</span><span class="p">.</span><span class="n">cat</span><span class="p">(</span><span class="o">&amp;</span><span class="n">cid</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">stored_data</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">data</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Data integrity check failed&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">StorageLocation</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">provider</span>: <span class="nc">StorageProvider</span>::<span class="n">LocalIPFS</span><span class="p">,</span>
<span class="w">            </span><span class="n">url</span>: <span class="nc">format</span><span class="o">!</span><span class="p">(</span><span class="s">&quot;ipfs://{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cid</span><span class="p">),</span>
<span class="w">            </span><span class="n">status</span>: <span class="nc">StorageStatus</span>::<span class="n">Available</span><span class="p">,</span>
<span class="w">            </span><span class="n">last_verified</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="44">4.4 公共网关存储</h3>
<div class="codehilite"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">StorageStrategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">store_to_public_gateway</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">data</span>: <span class="kp">&amp;</span><span class="nc">ProcessedData</span><span class="p">,</span>
<span class="w">        </span><span class="n">gateway</span>: <span class="kp">&amp;</span><span class="kt">str</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">StorageLocation</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 1. 通过网关上传数据</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">http_client</span>
<span class="w">            </span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="o">&amp;</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{}/api/v0/add&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gateway</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="n">multipart</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">create_multipart_form</span><span class="p">(</span><span class="n">data</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="n">send</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 2. 解析响应</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span>: <span class="nc">IPFSResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">cid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="p">.</span><span class="n">hash</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 3. 验证上传</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">verification_url</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{}/ipfs/{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">gateway</span><span class="p">,</span><span class="w"> </span><span class="n">cid</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">verification_response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">http_client</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">verification_url</span><span class="p">).</span><span class="n">send</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">verification_response</span><span class="p">.</span><span class="n">status</span><span class="p">().</span><span class="n">is_success</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">StorageLocation</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">provider</span>: <span class="nc">StorageProvider</span>::<span class="n">PublicGateway</span><span class="p">(</span><span class="n">gateway</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">                </span><span class="n">url</span>: <span class="nc">verification_url</span><span class="p">,</span>
<span class="w">                </span><span class="n">status</span>: <span class="nc">StorageStatus</span>::<span class="n">Available</span><span class="p">,</span>
<span class="w">                </span><span class="n">last_verified</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Gateway storage verification failed&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">())</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="5">5. 数据验证和完整性</h2>
<h3 id="51">5.1 区块链验证机制</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">BlockchainVerifier</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">contract_client</span>: <span class="nc">ContractClient</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">verification_contract</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">BlockchainVerifier</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">store_verification</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">cid</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">data_hash</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span>
<span class="w">        </span><span class="n">metadata</span>: <span class="kp">&amp;</span><span class="nc">StorageMetadata</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 1. 存储数据哈希到区块链</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">tx_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">contract_client</span><span class="p">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">            </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">verification_contract</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;store_data_verification&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">json</span><span class="o">!</span><span class="p">({</span>
<span class="w">                </span><span class="s">&quot;cid&quot;</span>: <span class="nc">cid</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;data_hash&quot;</span>: <span class="nc">hex</span>::<span class="n">encode</span><span class="p">(</span><span class="n">data_hash</span><span class="p">),</span>
<span class="w">                </span><span class="s">&quot;metadata&quot;</span>: <span class="nc">metadata</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;timestamp&quot;</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">        </span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">verify_data_integrity</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">cid</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">data</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 1. 从区块链获取存储的哈希</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">stored_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">contract_client</span><span class="p">.</span><span class="n">query</span><span class="p">(</span>
<span class="w">            </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">verification_contract</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;get_data_hash&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">json</span><span class="o">!</span><span class="p">({</span><span class="w"> </span><span class="s">&quot;cid&quot;</span>: <span class="nc">cid</span><span class="w"> </span><span class="p">})</span>
<span class="w">        </span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 2. 计算当前数据的哈希</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">current_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">calculate_hash</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 3. 比较哈希值</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">stored_hash</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">hex</span>::<span class="n">encode</span><span class="p">(</span><span class="n">current_hash</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="52">5.2 数据可用性监控</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">DataAvailabilityMonitor</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">check_interval</span>: <span class="nc">Duration</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">alert_threshold</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">notification_service</span>: <span class="nc">NotificationService</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">DataAvailabilityMonitor</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">start_monitoring</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">interval</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">interval</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">check_interval</span><span class="p">);</span>

<span class="w">        </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">interval</span><span class="p">.</span><span class="n">tick</span><span class="p">().</span><span class="k">await</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// 检查所有存储位置的数据可用性</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">availability_report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">check_all_storage_locations</span><span class="p">().</span><span class="k">await</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// 处理不可用的数据</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">handle_unavailable_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">availability_report</span><span class="p">).</span><span class="k">await</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// 发送通知</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">availability_report</span><span class="p">.</span><span class="n">unavailable_count</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">alert_threshold</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">notification_service</span><span class="p">.</span><span class="n">send_alert</span><span class="p">(</span><span class="o">&amp;</span><span class="n">availability_report</span><span class="p">).</span><span class="k">await</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">check_all_storage_locations</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">AvailabilityReport</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现数据可用性检查逻辑</span>
<span class="w">        </span><span class="fm">todo!</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">handle_unavailable_data</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">report</span>: <span class="kp">&amp;</span><span class="nc">AvailabilityReport</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">unavailable_location</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="n">report</span><span class="p">.</span><span class="n">unavailable_locations</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 尝试从其他位置恢复数据</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">recovered_data</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">recover_data</span><span class="p">(</span><span class="n">unavailable_location</span><span class="p">).</span><span class="k">await</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 重新存储到可用位置</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">restore_data</span><span class="p">(</span><span class="o">&amp;</span><span class="n">recovered_data</span><span class="p">).</span><span class="k">await</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="6">6. 性能优化策略</h2>
<h3 id="61">6.1 缓存策略</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">IPFSCache</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">memory_cache</span>: <span class="nc">LruCache</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">CachedData</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">disk_cache</span>: <span class="nc">DiskCache</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">cache_ttl</span>: <span class="nc">Duration</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">IPFSCache</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_or_fetch</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">cid</span>: <span class="kp">&amp;</span><span class="kt">str</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 1. 检查内存缓存</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">cached_data</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">memory_cache</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">cid</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">cached_data</span><span class="p">.</span><span class="n">is_expired</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">cached_data</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 2. 检查磁盘缓存</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">cached_data</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">disk_cache</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">cid</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">cached_data</span><span class="p">.</span><span class="n">is_expired</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 更新内存缓存</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">memory_cache</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">cid</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">cached_data</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">cached_data</span><span class="p">.</span><span class="n">data</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 3. 从IPFS获取数据</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">fetch_from_ipfs</span><span class="p">(</span><span class="n">cid</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 4. 更新缓存</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">cached_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CachedData</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">data</span>: <span class="nc">data</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">created_at</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ttl</span>: <span class="nc">self</span><span class="p">.</span><span class="n">cache_ttl</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">memory_cache</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">cid</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">cached_data</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">disk_cache</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">cid</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cached_data</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="62">6.2 并行处理</h3>
<div class="codehilite"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">StorageStrategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">store_parallel</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">data</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">],</span>
<span class="w">        </span><span class="n">data_type</span>: <span class="nc">DataType</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">IPFSStorageResult</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">processed_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">preprocess_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">data_type</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 并行存储到多个位置</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">storage_tasks</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">store_to_local_ipfs_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">processed_data</span><span class="p">),</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">store_to_public_gateways_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">processed_data</span><span class="p">),</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">store_to_pinning_services_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">processed_data</span><span class="p">),</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">store_to_distributed_network_task</span><span class="p">(</span><span class="o">&amp;</span><span class="n">processed_data</span><span class="p">),</span>
<span class="w">        </span><span class="p">];</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">futures</span>::<span class="n">future</span>::<span class="n">join_all</span><span class="p">(</span><span class="n">storage_tasks</span><span class="p">).</span><span class="k">await</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 收集成功的结果</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">storage_locations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">location</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">storage_locations</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">location</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">IPFSStorageResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">content_id</span>: <span class="nc">processed_data</span><span class="p">.</span><span class="n">cid</span><span class="p">,</span>
<span class="w">            </span><span class="n">storage_locations</span><span class="p">,</span>
<span class="w">            </span><span class="n">metadata</span>: <span class="nc">processed_data</span><span class="p">.</span><span class="n">metadata</span><span class="p">,</span>
<span class="w">            </span><span class="n">verification</span>: <span class="nc">self</span><span class="p">.</span><span class="n">generate_verification</span><span class="p">(</span><span class="o">&amp;</span><span class="n">processed_data</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">,</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="7">7. 配置和部署</h2>
<h3 id="71">7.1 配置文件示例</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># config/ipfs-storage.yaml</span>
<span class="nt">ipfs_storage</span><span class="p">:</span>
<span class="w">  </span><span class="c1"># 本地节点配置</span>
<span class="w">  </span><span class="nt">local_node</span><span class="p">:</span>
<span class="w">    </span><span class="nt">enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">api_url</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;http://localhost:5001&quot;</span>
<span class="w">    </span><span class="nt">data_path</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;/var/lib/ipfs&quot;</span>
<span class="w">    </span><span class="nt">max_storage_gb</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">100</span>
<span class="w">    </span><span class="nt">auto_gc</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">    </span><span class="nt">gc_interval_hours</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">24</span>

<span class="w">  </span><span class="c1"># 公共网关配置</span>
<span class="w">  </span><span class="nt">public_gateways</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;https://ipfs.io&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;https://gateway.pinata.cloud&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;https://cloudflare-ipfs.com&quot;</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;https://dweb.link&quot;</span>

<span class="w">  </span><span class="c1"># 固定服务配置</span>
<span class="w">  </span><span class="nt">pinning_services</span><span class="p">:</span>
<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Pinata&quot;</span>
<span class="w">      </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;${PINATA_API_KEY}&quot;</span>
<span class="w">      </span><span class="nt">endpoint</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://api.pinata.cloud&quot;</span>
<span class="w">      </span><span class="nt">cost_per_gb</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
<span class="w">      </span><span class="nt">max_file_size_gb</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
<span class="w">      </span><span class="nt">retention_policy</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;permanent&quot;</span>

<span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">name</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;Infura&quot;</span>
<span class="w">      </span><span class="nt">api_key</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;${INFURA_API_KEY}&quot;</span>
<span class="w">      </span><span class="nt">endpoint</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;https://ipfs.infura.io&quot;</span>
<span class="w">      </span><span class="nt">cost_per_gb</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0.0</span>
<span class="w">      </span><span class="nt">max_file_size_gb</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">5</span>
<span class="w">      </span><span class="nt">retention_policy</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;permanent&quot;</span>

<span class="w">  </span><span class="c1"># 存储策略配置</span>
<span class="w">  </span><span class="nt">redundancy_factor</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">3</span>
<span class="w">  </span><span class="nt">data_retention_days</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">365</span>
<span class="w">  </span><span class="nt">compression_enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
<span class="w">  </span><span class="nt">encryption_enabled</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">false</span>
</code></pre></div>

<h3 id="72-docker">7.2 Docker部署配置</h3>
<div class="codehilite"><pre><span></span><code><span class="c"># Dockerfile.ipfs</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">ipfs/kubo:latest</span>

<span class="c"># 安装必要的工具</span>
<span class="k">RUN</span><span class="w"> </span>apk<span class="w"> </span>add<span class="w"> </span>--no-cache<span class="w"> </span>curl<span class="w"> </span>jq

<span class="c"># 配置IPFS</span>
<span class="k">COPY</span><span class="w"> </span>ipfs-config.json<span class="w"> </span>/root/.ipfs/config

<span class="c"># 暴露API端口</span>
<span class="k">EXPOSE</span><span class="w"> </span><span class="s">5001</span>

<span class="c"># 启动IPFS守护进程</span>
<span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;ipfs&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;daemon&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;--migrate=true&quot;</span><span class="p">]</span>
</code></pre></div>

<div class="codehilite"><pre><span></span><code><span class="c1"># docker-compose.ipfs.yml</span>
<span class="nt">version</span><span class="p">:</span><span class="w"> </span><span class="s">&#39;3.8&#39;</span>
<span class="nt">services</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ipfs-node</span><span class="p">:</span>
<span class="w">    </span><span class="nt">build</span><span class="p">:</span>
<span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
<span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.ipfs</span>
<span class="w">    </span><span class="nt">ports</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;5001:5001&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;4001:4001&quot;</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="s">&quot;8080:8080&quot;</span>
<span class="w">    </span><span class="nt">volumes</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ipfs-data:/data/ipfs</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ipfs-staging:/export</span>
<span class="w">    </span><span class="nt">environment</span><span class="p">:</span>
<span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">IPFS_PROFILE=server</span>
<span class="w">    </span><span class="nt">restart</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">unless-stopped</span>

<span class="nt">volumes</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ipfs-data</span><span class="p">:</span>
<span class="w">  </span><span class="nt">ipfs-staging</span><span class="p">:</span>
</code></pre></div>

<h2 id="8">8. 监控和维护</h2>
<h3 id="81">8.1 性能指标</h3>
<div class="codehilite"><pre><span></span><code><span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">IPFSMetrics</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">storage_operations</span>: <span class="nc">StorageMetrics</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">retrieval_operations</span>: <span class="nc">RetrievalMetrics</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">network_metrics</span>: <span class="nc">NetworkMetrics</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">cache_metrics</span>: <span class="nc">CacheMetrics</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">StorageMetrics</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">total_stored_bytes</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">total_files</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">average_storage_time_ms</span>: <span class="kt">f64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">storage_success_rate</span>: <span class="kt">f64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">redundancy_level</span>: <span class="kt">f64</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">RetrievalMetrics</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">total_retrieved_bytes</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">total_requests</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">average_retrieval_time_ms</span>: <span class="kt">f64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">cache_hit_rate</span>: <span class="kt">f64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">availability_rate</span>: <span class="kt">f64</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="82">8.2 健康检查</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">IPFSHealthChecker</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">check_interval</span>: <span class="nc">Duration</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">health_checks</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">HealthCheck</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">IPFSHealthChecker</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">perform_health_check</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">HealthReport</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">report</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HealthReport</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">health_check</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">health_checks</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">health_check</span><span class="p">.</span><span class="n">check</span><span class="p">().</span><span class="k">await</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="n">status</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">report</span><span class="p">.</span><span class="n">add_check_result</span><span class="p">(</span><span class="n">status</span><span class="p">),</span>
<span class="w">                </span><span class="nb">Err</span><span class="p">(</span><span class="n">error</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="n">report</span><span class="p">.</span><span class="n">add_error</span><span class="p">(</span><span class="n">error</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">report</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">HealthCheck</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">check</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">CheckStatus</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LocalNodeHealthCheck</span><span class="p">;</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">GatewayHealthCheck</span><span class="p">;</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">PinningServiceHealthCheck</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">HealthCheck</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">LocalNodeHealthCheck</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">check</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">CheckStatus</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 检查本地IPFS节点状态</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reqwest</span>::<span class="n">get</span><span class="p">(</span><span class="s">&quot;http://localhost:5001/api/v0/version&quot;</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">status</span><span class="p">().</span><span class="n">is_success</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">CheckStatus</span>::<span class="n">Healthy</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="n">CheckStatus</span>::<span class="n">Unhealthy</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="9">9. 总结</h2>
<h3 id="91">9.1 技术优势</h3>
<p>通过采用IPFS作为主要存储方案，系统实现了以下优势：</p>
<ol>
<li><strong>完全去中心化</strong>：数据分布在全球节点网络中，避免单点故障</li>
<li><strong>零成本存储</strong>：无需支付存储费用，降低运营成本</li>
<li><strong>数据主权</strong>：用户完全控制自己的数据，符合去中心化理念</li>
<li><strong>高可用性</strong>：多节点冗余，确保数据始终可访问</li>
<li><strong>内容寻址</strong>：通过哈希确保数据完整性和不可篡改性</li>
</ol>
<h3 id="92">9.2 实施建议</h3>
<ol>
<li><strong>渐进式部署</strong>：先部署本地IPFS节点，再集成公共网关和固定服务</li>
<li><strong>监控和告警</strong>：建立完善的监控体系，及时发现和处理问题</li>
<li><strong>性能优化</strong>：通过缓存、并行处理等技术提升用户体验</li>
<li><strong>数据备份</strong>：建立多重备份机制，确保数据安全</li>
</ol>
<h3 id="93">9.3 未来扩展</h3>
<ol>
<li><strong>多链支持</strong>：集成更多区块链平台，提升验证的多样性</li>
<li><strong>智能路由</strong>：根据网络状况自动选择最优的存储路径</li>
<li><strong>存储市场</strong>：与IPFS存储提供商建立合作关系，提供增值服务</li>
<li><strong>生态建设</strong>：参与IPFS社区建设，推动技术发展</li>
</ol>
<p>通过本设计，系统成功实现了从传统"链下存储"向"IPFS去中心化存储"的转变，为用户提供了更加安全、可靠、经济的存储解决方案。</p>
<h2 id="_1">评估标准与结论</h2>
<h3 id="_2">评估标准（统一口径）</h3>
<ul>
<li>SoT：以 IPFS 的 CID/版本 为唯一真实源；链上仅保留摘要/索引。</li>
<li>可用性：多网关、多Pin服务、本地节点冗余与健康检查。</li>
<li>经济性：链上最小化显著降低Gas与状态膨胀。</li>
<li>可验证性：Merkle/哈希 + CID 交叉校验链路完备。</li>
</ul>
<h3 id="_3">结论</h3>
<p>该方案满足可用性、经济性与可验证性需求，建议按冗余与监控配置上线实施。</p>
</body>
</html>