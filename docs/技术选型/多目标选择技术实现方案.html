<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>多目标选择技术实现方案</title>
    <style>
        body {
            max-width: 860px;
            margin: 32px auto;
            padding: 0 16px;
            font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            line-height: 1.6;
            color: #1f2937;
        }
        pre { background:#f8fafc; padding:12px; overflow:auto; border-radius:6px; }
        code { background:#f1f5f9; padding:2px 4px; border-radius:4px; }
        h1,h2,h3,h4,h5,h6 { line-height:1.25; }
        a { color:#2563eb; text-decoration:none; }
        a:hover { text-decoration:underline; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #e5e7eb; padding: 8px; }
        blockquote { margin: 0; padding-left: 1em; border-left: 4px solid #e5e7eb; color:#6b7280; }
    </style>
</head>
<body>
<h1 id="_1">多目标选择技术实现方案（抽奖/彩票类型下的选择模式）</h1>
<blockquote>
<p>用词规范：请参阅《<a href="../项目术语表.html">项目术语表</a>》以确保术语统一。</p>
</blockquote>
<h2 id="1">1. 功能概述</h2>
<h3 id="11">1.1 功能描述</h3>
<p>多目标选择并非独立NFT类型，而是抽奖决策或彩票决策类型中的一种选择模式。它是一个基于比特承诺模型的公平选择机制，用于从n个参与者中选出k个不同的中奖序号。系统通过iAgent自动化处理承诺和揭示过程，确保公平性和不可篡改性。系统基于NFT类型控制不同的应用场景，每个NFT类型都有其对应的全局状态变量，用于控制比特承诺功能的执行状态。</p>
<h3 id="12">1.2 核心特性</h3>
<ul>
<li><strong>公平性</strong>：每个参与者的选择都会影响最终结果</li>
<li><strong>不可篡改性</strong>：基于比特承诺协议确保数据完整性</li>
<li><strong>自动化</strong>：iAgent处理所有通信和计算过程</li>
<li><strong>透明性</strong>：选择过程完全透明可验证</li>
<li><strong>防作弊</strong>：通过密码学技术防止参与者操纵结果</li>
<li><strong>NFT类型驱动</strong>：通过NFT类型控制不同的多目标选择应用场景</li>
<li><strong>NFT状态控制</strong>：NFT全局状态变量控制比特承诺功能的执行</li>
</ul>
<h2 id="2">2. 系统参数</h2>
<h3 id="21">2.1 基础参数</h3>
<ul>
<li><strong>n</strong>: 参与者数量（n &gt; k）</li>
<li><strong>k</strong>: 中奖序号数量（k ≤ n）</li>
<li><strong>H</strong>: 密码学哈希函数（如SHA-256等）</li>
<li><strong>iAgent</strong>: 每个参与者有一个iAgent，负责执行所有步骤</li>
<li><strong>NFT类型</strong>: 控制多目标选择应用场景的NFT类型标识</li>
<li><strong>NFT状态</strong>: 控制比特承诺功能执行状态的全局状态变量</li>
</ul>
<h3 id="22">2.2 技术约束</h3>
<ul>
<li>参与者编号范围：1到n</li>
<li>中奖序号范围：1到n</li>
<li>所有中奖序号必须互不相同</li>
<li>系统必须支持大规模参与者（n可达百万级）</li>
<li>每个NFT类型必须定义其对应的状态模式</li>
<li>NFT状态变更必须通过智能合约验证</li>
</ul>
<blockquote>
<p>关系与偏好组：唯一中奖= n 选 1；多等级=多个 n 选 k；单个 n 选 k 使用 1 组偏好值，多个 n 选 k 使用多组偏好值。</p>
</blockquote>
<h2 id="3">3. 算法设计</h2>
<h3 id="30">3.0 与其他模块的集成</h3>
<p>多目标选择系统与以下模块深度集成：</p>
<h4 id="301-nft">3.0.1 NFT类型管理集成</h4>
<ul>
<li><strong>状态同步</strong>：多目标选择的状态变更实时同步到NFT状态变量</li>
<li><strong>权限控制</strong>：基于NFT类型和状态控制多目标选择的执行权限</li>
<li><strong>元数据管理</strong>：多目标选择的配置和结果通过IPFS存储</li>
</ul>
<h4 id="302-iagent">3.0.2 iAgent自动化集成</h4>
<ul>
<li><strong>自动承诺</strong>：iAgent自动处理多目标选择的承诺流程</li>
<li><strong>智能揭示</strong>：基于NFT状态的智能揭示触发</li>
<li><strong>批量操作</strong>：支持大规模多目标选择的批量自动化处理</li>
</ul>
<h4 id="303-ipfs">3.0.3 IPFS存储集成</h4>
<ul>
<li><strong>配置存储</strong>：多目标选择的配置参数存储在IPFS上</li>
<li><strong>结果存储</strong>：选择结果和证明数据通过IPFS分布式存储</li>
<li><strong>哈希验证</strong>：区块链上存储IPFS哈希，确保数据完整性</li>
</ul>
<h3 id="31">3.1 值选择阶段</h3>
<h4 id="311">3.1.1 参与者值选择</h4>
<p>每个参与者i精心选择k个值：v_{i1}, v_{i2}, ..., v_{ik}</p>
<p><strong>值选择策略</strong>：
- 参与者可以根据自己的策略选择整数值
- 值的选择范围没有限制
- 最终通过取模运算规范化到1到n的范围
- 支持负数和正数
- <strong>基于NFT状态控制值选择权限</strong></p>
<h4 id="312-iagent">3.1.2 iAgent配置</h4>
<div class="codehilite"><pre><span></span><code><span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MultiTargetConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">target_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">values</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">strategy</span>: <span class="nc">ValueSelectionStrategy</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">auto_commit</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">auto_reveal</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span><span class="w">                    </span><span class="c1">// NFT类型标识</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_state</span>: <span class="nc">NFTState</span><span class="p">,</span><span class="w">                 </span><span class="c1">// NFT状态信息</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTState</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span><span class="w">                    </span><span class="c1">// NFT类型</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state_variables</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">StateValue</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 状态变量</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">current_state</span>: <span class="nb">String</span><span class="p">,</span><span class="w">                </span><span class="c1">// 当前状态</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">last_updated</span>: <span class="kt">u64</span><span class="p">,</span><span class="w">                    </span><span class="c1">// 最后更新时间</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">version</span>: <span class="kt">u32</span><span class="p">,</span><span class="w">                         </span><span class="c1">// 状态版本</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">is_active</span>: <span class="kt">bool</span><span class="p">,</span><span class="w">                      </span><span class="c1">// 是否激活</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">ValueSelectionStrategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Random</span><span class="p">,</span><span class="w">         </span><span class="c1">// 随机选择</span>
<span class="w">    </span><span class="n">Strategic</span><span class="p">,</span><span class="w">      </span><span class="c1">// 策略性选择</span>
<span class="w">    </span><span class="n">Balanced</span><span class="p">,</span><span class="w">       </span><span class="c1">// 平衡选择</span>
<span class="w">    </span><span class="n">Custom</span><span class="p">,</span><span class="w">         </span><span class="c1">// 自定义选择</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">StateValue</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">String</span><span class="p">(</span><span class="nb">String</span><span class="p">),</span>
<span class="w">    </span><span class="n">Number</span><span class="p">(</span><span class="kt">i64</span><span class="p">),</span>
<span class="w">    </span><span class="n">Boolean</span><span class="p">(</span><span class="kt">bool</span><span class="p">),</span>
<span class="w">    </span><span class="n">Array</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">StateValue</span><span class="o">&gt;</span><span class="p">),</span>
<span class="w">    </span><span class="n">Object</span><span class="p">(</span><span class="n">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">StateValue</span><span class="o">&gt;</span><span class="p">),</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="32">3.2 承诺阶段</h3>
<h4 id="321">3.2.1 承诺计算</h4>
<p>每个iAgent为所属参与者计算承诺值c_i：</p>
<div class="codehilite"><pre><span></span><code>c_i = H(v_{i1} || v_{i2} || ... || v_{ik})
</code></pre></div>

<p>其中：
- || 表示拼接操作
- H是哈希函数
- v_{ij}是参与者i的第j个选择值</p>
<p><strong>NFT状态验证</strong>：承诺计算前必须验证NFT状态是否允许承诺操作</p>
<h4 id="322">3.2.2 承诺存储</h4>
<ul>
<li>iAgent将承诺值存储在第三方IPFS之上</li>
<li>承诺值包含时间戳和参与者标识</li>
<li>支持批量承诺操作</li>
<li><strong>承诺存储后更新NFT状态变量</strong></li>
</ul>
<h4 id="323">3.2.3 承诺验证</h4>
<div class="codehilite"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">MultiTargetCommitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">create_commitment</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">values</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">i64</span><span class="p">],</span><span class="w"> </span><span class="n">nft_state</span>: <span class="kp">&amp;</span><span class="nc">NFTState</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">CommitmentData</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 验证NFT状态是否允许承诺</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">validate_commitment_state</span><span class="p">(</span><span class="n">nft_state</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Commitment not allowed by current NFT state&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 拼接所有值</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">.</span><span class="n">to_be_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 添加参与者ID和时间戳</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">participant_id</span><span class="p">.</span><span class="n">to_be_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">timestamp</span><span class="p">.</span><span class="n">to_be_bytes</span><span class="p">());</span>

<span class="w">        </span><span class="c1">// 添加NFT状态信息</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nft_state</span><span class="p">.</span><span class="n">current_state</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nft_state</span><span class="p">.</span><span class="n">last_updated</span><span class="p">.</span><span class="n">to_be_bytes</span><span class="p">());</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">CommitmentData</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">commitment</span>: <span class="nc">commitment_hash</span><span class="p">.</span><span class="n">into</span><span class="p">(),</span>
<span class="w">            </span><span class="n">participant_id</span>: <span class="nc">self</span><span class="p">.</span><span class="n">participant_id</span><span class="p">,</span>
<span class="w">            </span><span class="n">timestamp</span>: <span class="nc">self</span><span class="p">.</span><span class="n">timestamp</span><span class="p">,</span>
<span class="w">            </span><span class="n">nft_type</span>: <span class="nc">nft_state</span><span class="p">.</span><span class="n">nft_type</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">nft_state_hash</span>: <span class="nc">self</span><span class="p">.</span><span class="n">hash_nft_state</span><span class="p">(</span><span class="n">nft_state</span><span class="p">)</span><span class="o">?</span><span class="p">,</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">validate_commitment_state</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">nft_state</span>: <span class="kp">&amp;</span><span class="nc">NFTState</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 检查NFT状态是否允许承诺</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">commitment_enabled</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nft_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;commitment_enabled&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Boolean</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">commitment_enabled</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="o">*</span><span class="n">enabled</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 检查参与者状态</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">participant_state</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nft_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;participant_{}_state&quot;</span><span class="p">,</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">participant_id</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">StateValue</span>::<span class="nb">String</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">participant_state</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;active&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="c1">// 默认允许</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">hash_nft_state</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">nft_state</span>: <span class="kp">&amp;</span><span class="nc">NFTState</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">nft_state</span><span class="p">.</span><span class="n">nft_type</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">nft_state</span><span class="p">.</span><span class="n">current_state</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">nft_state</span><span class="p">.</span><span class="n">last_updated</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>

<span class="w">        </span><span class="c1">// 哈希状态变量</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nft_state</span><span class="p">.</span><span class="n">state_variables</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">            </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">serialize_state_value</span><span class="p">(</span><span class="n">value</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">().</span><span class="n">into</span><span class="p">())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">serialize_state_value</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="kp">&amp;</span><span class="nc">StateValue</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">StateValue</span>::<span class="nb">String</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">s</span><span class="p">.</span><span class="n">clone</span><span class="p">()),</span>
<span class="w">            </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">n</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">            </span><span class="n">StateValue</span>::<span class="n">Boolean</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">b</span><span class="p">.</span><span class="n">to_string</span><span class="p">()),</span>
<span class="w">            </span><span class="n">StateValue</span>::<span class="n">Array</span><span class="p">(</span><span class="n">arr</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">serialized</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">arr</span><span class="p">.</span><span class="n">iter</span><span class="p">()</span>
<span class="w">                    </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">v</span><span class="o">|</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">serialize_state_value</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
<span class="w">                    </span><span class="p">.</span><span class="n">collect</span>::<span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;&gt;</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;[{}]&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">serialized</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)))</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">StateValue</span>::<span class="n">Object</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">serialized</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">obj</span><span class="p">.</span><span class="n">iter</span><span class="p">()</span>
<span class="w">                    </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="kd">let</span><span class="w"> </span><span class="n">v_serialized</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">serialize_state_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">                        </span><span class="nb">Ok</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{}:{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">k</span><span class="p">,</span><span class="w"> </span><span class="n">v_serialized</span><span class="p">))</span>
<span class="w">                    </span><span class="p">})</span>
<span class="w">                    </span><span class="p">.</span><span class="n">collect</span>::<span class="o">&lt;</span><span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;&gt;</span><span class="p">()</span><span class="o">?</span><span class="p">;</span>
<span class="w">                </span><span class="nb">Ok</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{{{}}}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">serialized</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)))</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="33">3.3 揭示阶段</h3>
<h4 id="331">3.3.1 揭示条件</h4>
<p>iAgent根据NFT状态自动判断是否满足揭示条件：</p>
<p><strong>基于NFT状态的揭示条件</strong>：
- 时间条件：基于NFT状态中的时间变量
- 参与者数量条件：基于NFT状态中的参与者计数
- 承诺完成度条件：基于NFT状态中的承诺统计
- 手动触发条件：基于NFT状态中的手动触发标志</p>
<h4 id="332">3.3.2 揭示执行</h4>
<div class="codehilite"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">MultiTargetReveal</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_reveal</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">commitment_data</span>: <span class="kp">&amp;</span><span class="nc">CommitmentData</span><span class="p">,</span>
<span class="w">        </span><span class="n">values</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">i64</span><span class="p">],</span>
<span class="w">        </span><span class="n">nft_state</span>: <span class="kp">&amp;</span><span class="nc">NFTState</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">RevealResult</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 验证NFT状态是否允许揭示</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">validate_reveal_state</span><span class="p">(</span><span class="n">nft_state</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Reveal not allowed by current NFT state&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 验证承诺的正确性</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">computed_commitment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">compute_commitment</span><span class="p">(</span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="n">nft_state</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">computed_commitment</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">commitment_data</span><span class="p">.</span><span class="n">commitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Invalid commitment&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 执行揭示</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">reveal_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RevealResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">participant_id</span>: <span class="nc">commitment_data</span><span class="p">.</span><span class="n">participant_id</span><span class="p">,</span>
<span class="w">            </span><span class="n">values</span>: <span class="nc">values</span><span class="p">.</span><span class="n">to_vec</span><span class="p">(),</span>
<span class="w">            </span><span class="n">timestamp</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">            </span><span class="n">nft_type</span>: <span class="nc">commitment_data</span><span class="p">.</span><span class="n">nft_type</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">nft_state_hash</span>: <span class="nc">commitment_data</span><span class="p">.</span><span class="n">nft_state_hash</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// 更新NFT状态</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">update_nft_state_after_reveal</span><span class="p">(</span><span class="n">nft_state</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">reveal_result</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">reveal_result</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">validate_reveal_state</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">nft_state</span>: <span class="kp">&amp;</span><span class="nc">NFTState</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 检查NFT状态是否允许揭示</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">reveal_enabled</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nft_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;reveal_enabled&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Boolean</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reveal_enabled</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="o">*</span><span class="n">enabled</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 检查揭示条件</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">reveal_condition</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nft_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;reveal_condition&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">evaluate_reveal_condition</span><span class="p">(</span><span class="n">reveal_condition</span><span class="p">,</span><span class="w"> </span><span class="n">nft_state</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="c1">// 默认允许</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">evaluate_reveal_condition</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">condition</span>: <span class="kp">&amp;</span><span class="nc">StateValue</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_state</span>: <span class="kp">&amp;</span><span class="nc">NFTState</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">condition</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">StateValue</span>::<span class="nb">String</span><span class="p">(</span><span class="n">condition_type</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">match</span><span class="w"> </span><span class="n">condition_type</span><span class="p">.</span><span class="n">as_str</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="s">&quot;time_based&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">evaluate_time_condition</span><span class="p">(</span><span class="n">nft_state</span><span class="p">),</span>
<span class="w">                    </span><span class="s">&quot;participant_count&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">evaluate_participant_condition</span><span class="p">(</span><span class="n">nft_state</span><span class="p">),</span>
<span class="w">                    </span><span class="s">&quot;commitment_completion&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">evaluate_completion_condition</span><span class="p">(</span><span class="n">nft_state</span><span class="p">),</span>
<span class="w">                    </span><span class="s">&quot;manual_trigger&quot;</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">evaluate_manual_trigger</span><span class="p">(</span><span class="n">nft_state</span><span class="p">),</span>
<span class="w">                    </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="kc">false</span><span class="p">),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">update_nft_state_after_reveal</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_state</span>: <span class="kp">&amp;</span><span class="nc">NFTState</span><span class="p">,</span>
<span class="w">        </span><span class="n">reveal_result</span>: <span class="kp">&amp;</span><span class="nc">RevealResult</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 更新揭示统计</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">revealed_count_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;total_revealed&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">current_revealed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nft_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">revealed_count_key</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">and_then</span><span class="p">(</span><span class="o">|</span><span class="n">v</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">None</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 更新NFT状态</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">updated_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nft_state</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>
<span class="w">        </span><span class="n">updated_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span>
<span class="w">            </span><span class="n">revealed_count_key</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="n">current_revealed</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">);</span>
<span class="w">        </span><span class="n">updated_state</span><span class="p">.</span><span class="n">last_updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">();</span>
<span class="w">        </span><span class="n">updated_state</span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 保存更新后的状态</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">save_nft_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">updated_state</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="34">3.4 中奖序号计算</h3>
<h4 id="341">3.4.1 计算算法</h4>
<p>基于所有参与者的值计算k个不同的中奖序号：</p>
<p><strong>基准序号计算</strong>：</p>
<div class="codehilite"><pre><span></span><code>A1 = (∑v_{i1}) mod n + 1
</code></pre></div>

<p><strong>偏移序号计算</strong>：</p>
<div class="codehilite"><pre><span></span><code>Aj = (A_{j-1} + Δj) mod n
</code></pre></div>

<p>其中Δj确保唯一性：</p>
<div class="codehilite"><pre><span></span><code>Δj = (∑v_{ij}) mod (n - j + 1) + 1
</code></pre></div>

<p><strong>NFT状态集成</strong>：算法执行过程中实时更新NFT状态变量</p>
<h4 id="342">3.4.2 状态更新</h4>
<div class="codehilite"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">MultiTargetWinnerCalculation</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">calculate_winners</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participants</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">ParticipantData</span><span class="p">],</span>
<span class="w">        </span><span class="n">nft_state</span>: <span class="kp">&amp;</span><span class="nc">NFTState</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Winner</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 验证NFT状态是否允许计算</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">validate_calculation_state</span><span class="p">(</span><span class="n">nft_state</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Calculation not allowed by current NFT state&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">participants</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">target_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">k</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Target count cannot exceed participant count&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">used_indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashSet</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 计算基准序号</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">base_sum</span>: <span class="kt">i64</span> <span class="o">=</span><span class="w"> </span><span class="n">participants</span><span class="p">.</span><span class="n">iter</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">p</span><span class="o">|</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
<span class="w">            </span><span class="p">.</span><span class="n">sum</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">base_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">base_sum</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">used_indices</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">base_index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">used_indices</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">base_index</span><span class="p">);</span>
<span class="w">            </span><span class="n">winners</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">Winner</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">participant_index</span>: <span class="nc">base_index</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">                </span><span class="n">winning_number</span>: <span class="nc">base_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                </span><span class="n">position</span>: <span class="mi">1</span><span class="p">,</span>
<span class="w">                </span><span class="n">nft_type</span>: <span class="nc">nft_state</span><span class="p">.</span><span class="n">nft_type</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 计算偏移序号</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">2</span><span class="o">..=</span><span class="n">k</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">offset_sum</span>: <span class="kt">i64</span> <span class="o">=</span><span class="w"> </span><span class="n">participants</span><span class="p">.</span><span class="n">iter</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">p</span><span class="o">|</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">values</span><span class="p">[(</span><span class="n">j</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">])</span>
<span class="w">                </span><span class="p">.</span><span class="n">sum</span><span class="p">();</span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">available_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">used_indices</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">;</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">offset_sum</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">available_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">available_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">available_count</span><span class="p">;</span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">candidate_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base_index</span><span class="p">;</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">offset_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// 寻找可用的索引</span>
<span class="w">            </span><span class="k">while</span><span class="w"> </span><span class="n">offset_count</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">candidate_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">candidate_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">used_indices</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">candidate_index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">offset_count</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">used_indices</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">candidate_index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">used_indices</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">candidate_index</span><span class="p">);</span>
<span class="w">                </span><span class="n">winners</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">Winner</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">participant_index</span>: <span class="nc">candidate_index</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">                    </span><span class="n">winning_number</span>: <span class="nc">candidate_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span>
<span class="w">                    </span><span class="n">position</span>: <span class="nc">j</span><span class="p">,</span>
<span class="w">                    </span><span class="n">nft_type</span>: <span class="nc">nft_state</span><span class="p">.</span><span class="n">nft_type</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">                </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 更新NFT状态</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">update_nft_state_after_calculation</span><span class="p">(</span><span class="n">nft_state</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">winners</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">validate_calculation_state</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">nft_state</span>: <span class="kp">&amp;</span><span class="nc">NFTState</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 检查NFT状态是否允许计算</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">calculation_enabled</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nft_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;calculation_enabled&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Boolean</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculation_enabled</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="o">*</span><span class="n">enabled</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 检查是否满足计算条件</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">min_revealed</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nft_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;min_revealed_for_calculation&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="n">required</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">min_revealed</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">total_revealed</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nft_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;total_revealed&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="n">actual</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">total_revealed</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">actual</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="o">*</span><span class="n">required</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="c1">// 默认允许</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">update_nft_state_after_calculation</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_state</span>: <span class="kp">&amp;</span><span class="nc">NFTState</span><span class="p">,</span>
<span class="w">        </span><span class="n">winners</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Winner</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 更新计算状态</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">updated_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">nft_state</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 设置计算完成标志</span>
<span class="w">        </span><span class="n">updated_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;calculation_completed&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">StateValue</span>::<span class="n">Boolean</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 记录中奖者数量</span>
<span class="w">        </span><span class="n">updated_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;total_winners&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="n">winners</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 记录计算时间</span>
<span class="w">        </span><span class="n">updated_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;calculation_timestamp&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 更新NFT状态</span>
<span class="w">        </span><span class="n">updated_state</span><span class="p">.</span><span class="n">last_updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">();</span>
<span class="w">        </span><span class="n">updated_state</span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 保存更新后的状态</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">save_nft_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">updated_state</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="4">4. 系统架构</h2>
<h3 id="41">4.1 整体架构</h3>
<div class="codehilite"><pre><span></span><code>┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   客户端SDK     │    │ WebAssembly服务器    │    │   区块链网络    │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │ 多目标选择  │ │◄──►│ │ 多目标选择  │ │◄──►│ │ 智能合约    │ │
│ │ 配置工具    │ │    │ │ 生命周期    │ │    │ │ 承诺存储    │ │
│ │ NFT类型管理 │ │    │ │ 区块链接口  │ │    │ │ 结果记录    │ │
│ │ NFT状态管理 │ │    │ │ NFT状态管理 │ │    │ │ NFT状态     │ │
│ │ AI代理配置  │ │    │ │ AI代理管理  │ │    │ │ 自动化合约  │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   密码学核心    │    │   存储策略      │    │   去中心化存储  │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │ 比特承诺    │ │    │ │ 链上优化    │ │    │ │ IPFS节点    │ │
│ │ 随机数生成  │ │    │ │ IPFS适配    │ │    │ │ 数据分片    │ │
│ │ 哈希函数    │ │    │ │ 完整性验证  │ │    │ │ 冗余备份    │ │
│ │ 中奖序号    │ │    │ │ NFT元数据   │ │    │ │ 元数据存储  │ │
│ │ NFT状态控制 │ │    │ │ NFT状态     │ │    │ │ 状态存储    │ │
│ │ iAgent自动化 │ │    │ │ 自动化配置  │ │    │ │ 自动化状态  │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
└─────────────────┘    └─────────────────┘    └─────────────────┘
</code></pre></div>

<h3 id="42">4.2 核心组件</h3>
<h4 id="421-nft">4.2.1 NFT类型管理器</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTTypeManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">registered_types</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">NFTTypeConfig</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state_manager</span>: <span class="nc">NFTStateManager</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">type_validator</span>: <span class="nc">NFTTypeValidator</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">NFTTypeManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">create_multi_target_nft_type</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">config</span>: <span class="nc">MultiTargetNFTTypeConfig</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 验证NFT类型配置</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">type_validator</span><span class="p">.</span><span class="n">validate_multi_target_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 创建NFT类型</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">nft_type_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_nft_type_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">nft_type_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NFTTypeConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">nft_type</span>: <span class="nc">nft_type_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">nft_standard</span>: <span class="s">&quot;CW721&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">metadata_schema</span>: <span class="nc">config</span><span class="p">.</span><span class="n">metadata_schema</span><span class="p">,</span>
<span class="w">            </span><span class="n">voting_rules</span>: <span class="nc">config</span><span class="p">.</span><span class="n">voting_rules</span><span class="p">,</span>
<span class="w">            </span><span class="n">lifecycle_hooks</span>: <span class="nc">config</span><span class="p">.</span><span class="n">lifecycle_hooks</span><span class="p">,</span>
<span class="w">            </span><span class="n">global_state_schema</span>: <span class="nc">config</span><span class="p">.</span><span class="n">state_schema</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// 注册NFT类型</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">registered_types</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">nft_type_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">nft_type_config</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 初始化NFT类型状态</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">state_manager</span><span class="p">.</span><span class="n">initialize_multi_target_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nft_type_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">config</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">nft_type_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MultiTargetNFTTypeConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">target_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">max_participants</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">metadata_schema</span>: <span class="nc">MetadataSchema</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">voting_rules</span>: <span class="nc">VotingRules</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">lifecycle_hooks</span>: <span class="nc">LifecycleHooks</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state_schema</span>: <span class="nc">StateSchema</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="422-nft">4.2.2 NFT状态管理器</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTStateManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">global_states</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">GlobalState</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state_transitions</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">StateTransition</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state_validator</span>: <span class="nc">StateValidator</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">NFTStateManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">initialize_multi_target_state</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">config</span>: <span class="kp">&amp;</span><span class="nc">MultiTargetNFTTypeConfig</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">initial_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">GlobalState</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">nft_type</span>: <span class="nc">nft_type_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">state_variables</span>: <span class="nc">HashMap</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">current_state</span>: <span class="s">&quot;created&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">last_updated</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">            </span><span class="n">version</span>: <span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="n">state_transitions</span>: <span class="nb">Vec</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// 设置初始状态变量</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">state_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashMap</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">state_variables</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&quot;commitment_enabled&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Boolean</span><span class="p">(</span><span class="kc">true</span><span class="p">));</span>
<span class="w">        </span><span class="n">state_variables</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&quot;reveal_enabled&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Boolean</span><span class="p">(</span><span class="kc">false</span><span class="p">));</span>
<span class="w">        </span><span class="n">state_variables</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&quot;calculation_enabled&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Boolean</span><span class="p">(</span><span class="kc">false</span><span class="p">));</span>
<span class="w">        </span><span class="n">state_variables</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&quot;max_participants&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">max_participants</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">));</span>
<span class="w">        </span><span class="n">state_variables</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&quot;target_count&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">target_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">));</span>
<span class="w">        </span><span class="n">state_variables</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&quot;total_participants&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="w">        </span><span class="n">state_variables</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&quot;total_commitments&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="w">        </span><span class="n">state_variables</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&quot;total_reveals&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
<span class="w">        </span><span class="n">state_variables</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&quot;min_revealed_for_calculation&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">max_participants</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">));</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">updated_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">initial_state</span><span class="p">;</span>
<span class="w">        </span><span class="n">updated_state</span><span class="p">.</span><span class="n">state_variables</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state_variables</span><span class="p">;</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">global_states</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">nft_type_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">updated_state</span><span class="p">);</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">update_multi_target_state</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">variable_name</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">new_value</span>: <span class="nc">StateValue</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">global_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">global_states</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="n">nft_type_id</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="s">&quot;Global state not found for NFT type&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 验证状态转换是否有效</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">transitions</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">state_transitions</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">nft_type_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">is_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">validate_state_transition</span><span class="p">(</span>
<span class="w">                </span><span class="n">nft_type_id</span><span class="p">,</span>
<span class="w">                </span><span class="n">variable_name</span><span class="p">,</span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">global_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">variable_name</span><span class="p">),</span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">new_value</span><span class="p">,</span>
<span class="w">                </span><span class="n">transitions</span>
<span class="w">            </span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">is_valid</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Invalid state transition&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 更新状态变量</span>
<span class="w">        </span><span class="n">global_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">variable_name</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">new_value</span><span class="p">);</span>
<span class="w">        </span><span class="n">global_state</span><span class="p">.</span><span class="n">last_updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">();</span>
<span class="w">        </span><span class="n">global_state</span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 记录状态转换</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">transition</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StateTransition</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">from_state</span>: <span class="nc">global_state</span><span class="p">.</span><span class="n">current_state</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">to_state</span>: <span class="nc">self</span><span class="p">.</span><span class="n">determine_new_state</span><span class="p">(</span><span class="n">global_state</span><span class="p">),</span>
<span class="w">            </span><span class="n">trigger</span>: <span class="nc">variable_name</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">timestamp</span>: <span class="nc">global_state</span><span class="p">.</span><span class="n">last_updated</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="n">global_state</span><span class="p">.</span><span class="n">state_transitions</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">transition</span><span class="p">);</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">determine_new_state</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">global_state</span>: <span class="kp">&amp;</span><span class="nc">GlobalState</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span>
<span class="w">        </span><span class="c1">// 基于状态变量确定新状态</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">total_participants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;total_participants&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">and_then</span><span class="p">(</span><span class="o">|</span><span class="n">v</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">None</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">total_commitments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;total_commitments&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">and_then</span><span class="p">(</span><span class="o">|</span><span class="n">v</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">None</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">total_reveals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;total_reveals&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">and_then</span><span class="p">(</span><span class="o">|</span><span class="n">v</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">None</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">max_participants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;max_participants&quot;</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">and_then</span><span class="p">(</span><span class="o">|</span><span class="n">v</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">None</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">total_reveals</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">max_participants</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s">&quot;completed&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">total_commitments</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">max_participants</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s">&quot;revealing&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">total_participants</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">max_participants</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s">&quot;committing&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">total_participants</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s">&quot;collecting&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="s">&quot;created&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">()</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="5">5. 实现细节</h2>
<h3 id="51">5.1 智能合约集成</h3>
<h4 id="511">5.1.1 合约状态管理</h4>
<div class="codehilite"><pre><span></span><code><span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">State</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">multi_target_sessions</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">MultiTargetSession</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_type_states</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">NFTTypeState</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitments</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Addr</span><span class="p">,</span><span class="w"> </span><span class="n">CommitmentData</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveals</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Addr</span><span class="p">,</span><span class="w"> </span><span class="n">RevealData</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winners</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Winner</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MultiTargetSession</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">session_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">target_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">max_participants</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">status</span>: <span class="nc">SessionStatus</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">created_at</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">updated_at</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_state</span>: <span class="nc">NFTTypeState</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTTypeState</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state_variables</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">StateValue</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">current_state</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">last_updated</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">version</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="512">5.1.2 合约消息处理</h4>
<div class="codehilite"><pre><span></span><code><span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">ExecuteMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">CreateMultiTargetSession</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">target_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">        </span><span class="n">max_participants</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">        </span><span class="n">state_schema</span>: <span class="nc">StateSchema</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">SubmitCommitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">session_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">commitment</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">SubmitReveal</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">session_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">values</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">randomness</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">CalculateWinners</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">session_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">UpdateNFTState</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">variable_name</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">new_value</span>: <span class="nc">StateValue</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">QueryMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">GetMultiTargetSession</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">session_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">GetNFTTypeState</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">nft_type</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">GetCommitments</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">session_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">GetReveals</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">session_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">GetWinners</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">session_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="52-webassembly">5.2 WebAssembly模块</h3>
<h4 id="521">5.2.1 多目标选择引擎</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MultiTargetEngine</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_type_manager</span>: <span class="nc">NFTTypeManager</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state_manager</span>: <span class="nc">NFTStateManager</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_manager</span>: <span class="nc">MultiTargetCommitment</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveal_manager</span>: <span class="nc">MultiTargetReveal</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">calculation_engine</span>: <span class="nc">WinnerCalculationEngine</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">MultiTargetEngine</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">create_session</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">config</span>: <span class="nc">MultiTargetSessionConfig</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 验证NFT类型</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">nft_type_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">nft_type_manager</span><span class="p">.</span><span class="n">get_nft_type_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">.</span><span class="n">nft_type</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="s">&quot;NFT type not found&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 创建会话</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">session_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_session_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MultiTargetSession</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">session_id</span>: <span class="nc">session_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">nft_type</span>: <span class="nc">config</span><span class="p">.</span><span class="n">nft_type</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">target_count</span>: <span class="nc">config</span><span class="p">.</span><span class="n">target_count</span><span class="p">,</span>
<span class="w">            </span><span class="n">max_participants</span>: <span class="nc">config</span><span class="p">.</span><span class="n">max_participants</span><span class="p">,</span>
<span class="w">            </span><span class="n">status</span>: <span class="nc">SessionStatus</span>::<span class="n">Created</span><span class="p">,</span>
<span class="w">            </span><span class="n">created_at</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">            </span><span class="n">updated_at</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">            </span><span class="n">nft_state</span>: <span class="nc">NFTTypeState</span>::<span class="n">default</span><span class="p">(),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// 初始化NFT状态</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">state_manager</span><span class="p">.</span><span class="n">initialize_session_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">config</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">submit_commitment</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">session_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">        </span><span class="n">values</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">CommitmentData</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 获取会话信息</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 验证NFT状态</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">nft_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">state_manager</span><span class="p">.</span><span class="n">get_session_state</span><span class="p">(</span><span class="n">session_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">validate_commitment_permission</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nft_state</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Commitment not allowed by current state&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 创建承诺</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">commitment_manager</span><span class="p">.</span><span class="n">create_commitment</span><span class="p">(</span>
<span class="w">            </span><span class="n">participant_id</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">values</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">nft_state</span>
<span class="w">        </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 更新NFT状态</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">state_manager</span><span class="p">.</span><span class="n">update_session_state</span><span class="p">(</span>
<span class="w">            </span><span class="n">session_id</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;total_commitments&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span>
<span class="w">                </span><span class="n">nft_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;total_commitments&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="n">and_then</span><span class="p">(</span><span class="o">|</span><span class="n">v</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">None</span><span class="w"> </span><span class="p">}</span>
<span class="w">                    </span><span class="p">})</span>
<span class="w">                    </span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">commitment_data</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">submit_reveal</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">session_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">        </span><span class="n">values</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">randomness</span>: <span class="nb">String</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">RevealResult</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 获取会话信息</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 验证NFT状态</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">nft_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">state_manager</span><span class="p">.</span><span class="n">get_session_state</span><span class="p">(</span><span class="n">session_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">validate_reveal_permission</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nft_state</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Reveal not allowed by current state&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 验证承诺</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_commitment</span><span class="p">(</span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="n">participant_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">is_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">commitment_manager</span><span class="p">.</span><span class="n">verify_commitment</span><span class="p">(</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">commitment</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">values</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">randomness</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">nft_state</span>
<span class="w">        </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">is_valid</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Invalid commitment&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 创建揭示结果</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">reveal_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RevealResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">participant_id</span><span class="p">,</span>
<span class="w">            </span><span class="n">values</span><span class="p">,</span>
<span class="w">            </span><span class="n">timestamp</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">            </span><span class="n">nft_type</span>: <span class="nc">session</span><span class="p">.</span><span class="n">nft_type</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// 更新NFT状态</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">state_manager</span><span class="p">.</span><span class="n">update_session_state</span><span class="p">(</span>
<span class="w">            </span><span class="n">session_id</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;total_reveals&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span>
<span class="w">                </span><span class="n">nft_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;total_reveals&quot;</span><span class="p">)</span>
<span class="w">                    </span><span class="p">.</span><span class="n">and_then</span><span class="p">(</span><span class="o">|</span><span class="n">v</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">None</span><span class="w"> </span><span class="p">}</span>
<span class="w">                    </span><span class="p">})</span>
<span class="w">                    </span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span>
<span class="w">            </span><span class="p">)</span>
<span class="w">        </span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">reveal_result</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">calculate_winners</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">session_id</span>: <span class="kp">&amp;</span><span class="kt">str</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Winner</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 获取会话信息</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_session</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 验证NFT状态</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">nft_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">state_manager</span><span class="p">.</span><span class="n">get_session_state</span><span class="p">(</span><span class="n">session_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">validate_calculation_permission</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nft_state</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Calculation not allowed by current state&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 获取所有揭示数据</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">reveals</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_all_reveals</span><span class="p">(</span><span class="n">session_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 计算中奖者</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">calculation_engine</span><span class="p">.</span><span class="n">calculate_winners</span><span class="p">(</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">reveals</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">nft_state</span>
<span class="w">        </span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 更新NFT状态</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">state_manager</span><span class="p">.</span><span class="n">update_session_state</span><span class="p">(</span>
<span class="w">            </span><span class="n">session_id</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;calculation_completed&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">StateValue</span>::<span class="n">Boolean</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">state_manager</span><span class="p">.</span><span class="n">update_session_state</span><span class="p">(</span>
<span class="w">            </span><span class="n">session_id</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;winners_calculated&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">StateValue</span>::<span class="n">Boolean</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">        </span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="6">6. 测试和验证</h2>
<h3 id="61">6.1 单元测试</h3>
<h4 id="611-nft">6.1.1 NFT状态管理测试</h4>
<div class="codehilite"><pre><span></span><code><span class="cp">#[cfg(test)]</span>
<span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="o">*</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#[tokio::test]</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_nft_state_initialization</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">state_manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NFTStateManager</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MultiTargetNFTTypeConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">nft_type</span>: <span class="s">&quot;test_multi_target&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">target_count</span>: <span class="mi">5</span><span class="p">,</span>
<span class="w">            </span><span class="n">max_participants</span>: <span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="n">metadata_schema</span>: <span class="nc">MetadataSchema</span>::<span class="n">default</span><span class="p">(),</span>
<span class="w">            </span><span class="n">voting_rules</span>: <span class="nc">VotingRules</span>::<span class="n">default</span><span class="p">(),</span>
<span class="w">            </span><span class="n">lifecycle_hooks</span>: <span class="nc">LifecycleHooks</span>::<span class="n">default</span><span class="p">(),</span>
<span class="w">            </span><span class="n">state_schema</span>: <span class="nc">StateSchema</span>::<span class="n">default</span><span class="p">(),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="n">state_manager</span><span class="p">.</span><span class="n">initialize_multi_target_state</span><span class="p">(</span><span class="s">&quot;test_type&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">config</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state_manager</span><span class="p">.</span><span class="n">get_global_state</span><span class="p">(</span><span class="s">&quot;test_type&quot;</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;target_count&quot;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="mi">5</span><span class="p">));</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;max_participants&quot;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="mi">100</span><span class="p">));</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;commitment_enabled&quot;</span><span class="p">).</span><span class="n">unwrap</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">StateValue</span>::<span class="n">Boolean</span><span class="p">(</span><span class="kc">true</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[tokio::test]</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_nft_state_transition</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">state_manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NFTStateManager</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="c1">// 初始化状态...</span>

<span class="w">        </span><span class="c1">// 测试状态转换</span>
<span class="w">        </span><span class="n">state_manager</span><span class="p">.</span><span class="n">update_multi_target_state</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;test_type&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="s">&quot;total_participants&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="mi">50</span><span class="p">)</span>
<span class="w">        </span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">state_manager</span><span class="p">.</span><span class="n">get_global_state</span><span class="p">(</span><span class="s">&quot;test_type&quot;</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">state</span><span class="p">.</span><span class="n">current_state</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;collecting&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="612">6.1.2 多目标选择算法测试</h4>
<div class="codehilite"><pre><span></span><code><span class="cp">#[tokio::test]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_winner_calculation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">calculation_engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">WinnerCalculationEngine</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">participants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span>
<span class="w">        </span><span class="n">ParticipantData</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">values</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[</span><span class="mi">10</span><span class="p">,</span><span class="w"> </span><span class="mi">20</span><span class="p">,</span><span class="w"> </span><span class="mi">30</span><span class="p">],</span><span class="w"> </span><span class="o">..</span><span class="nb">Default</span>::<span class="n">default</span><span class="p">()</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="n">ParticipantData</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">values</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[</span><span class="mi">15</span><span class="p">,</span><span class="w"> </span><span class="mi">25</span><span class="p">,</span><span class="w"> </span><span class="mi">35</span><span class="p">],</span><span class="w"> </span><span class="o">..</span><span class="nb">Default</span>::<span class="n">default</span><span class="p">()</span><span class="w"> </span><span class="p">},</span>
<span class="w">        </span><span class="n">ParticipantData</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">values</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[</span><span class="mi">12</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="p">,</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span><span class="w"> </span><span class="o">..</span><span class="nb">Default</span>::<span class="n">default</span><span class="p">()</span><span class="w"> </span><span class="p">},</span>
<span class="w">    </span><span class="p">];</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">nft_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NFTState</span>::<span class="n">default</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculation_engine</span><span class="p">.</span><span class="n">calculate_winners</span><span class="p">(</span><span class="o">&amp;</span><span class="n">participants</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nft_state</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">winners</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="fm">assert!</span><span class="p">(</span><span class="n">winners</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">all</span><span class="p">(</span><span class="o">|</span><span class="n">w</span><span class="o">|</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">winning_number</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">winning_number</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">));</span>

<span class="w">    </span><span class="c1">// 验证唯一性</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">winning_numbers</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">winners</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">w</span><span class="o">|</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">winning_number</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">unique_numbers</span>: <span class="nc">HashSet</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">winning_numbers</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">cloned</span><span class="p">().</span><span class="n">collect</span><span class="p">();</span>
<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">winning_numbers</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="n">unique_numbers</span><span class="p">.</span><span class="n">len</span><span class="p">());</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="62">6.2 集成测试</h3>
<h4 id="621">6.2.1 端到端流程测试</h4>
<div class="codehilite"><pre><span></span><code><span class="cp">#[tokio::test]</span>
<span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_end_to_end_flow</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">engine</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MultiTargetEngine</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 创建会话</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MultiTargetSessionConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="s">&quot;test_lottery&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">target_count</span>: <span class="mi">3</span><span class="p">,</span>
<span class="w">        </span><span class="n">max_participants</span>: <span class="mi">10</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">session_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">engine</span><span class="p">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">config</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 提交承诺</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">42</span><span class="p">,</span><span class="w"> </span><span class="mi">73</span><span class="p">,</span><span class="w"> </span><span class="mi">15</span><span class="p">];</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">engine</span><span class="p">.</span><span class="n">submit_commitment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="n">clone</span><span class="p">()).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 提交揭示</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">randomness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;random_string&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">();</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">reveal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">engine</span><span class="p">.</span><span class="n">submit_reveal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="n">values</span><span class="p">,</span><span class="w"> </span><span class="n">randomness</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="c1">// 计算中奖者</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">engine</span><span class="p">.</span><span class="n">calculate_winners</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session_id</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">    </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">winners</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="7">7. 性能优化</h2>
<h3 id="71">7.1 并发处理</h3>
<ul>
<li><strong>批量承诺处理</strong>：支持批量提交承诺，减少网络往返</li>
<li><strong>并行揭示验证</strong>：并行验证多个揭示，提高处理速度</li>
<li><strong>异步状态更新</strong>：异步更新NFT状态，不阻塞主流程</li>
</ul>
<h3 id="72">7.2 缓存策略</h3>
<ul>
<li><strong>NFT状态缓存</strong>：缓存NFT状态信息，减少重复查询</li>
<li><strong>承诺验证缓存</strong>：缓存承诺验证结果，提高验证效率</li>
<li><strong>中奖计算缓存</strong>：缓存中间计算结果，支持增量计算</li>
</ul>
<h3 id="73">7.3 存储优化</h3>
<ul>
<li><strong>IPFS分片存储</strong>：将大量承诺数据分片存储到IPFS</li>
<li><strong>链上状态压缩</strong>：压缩链上状态数据，降低存储成本</li>
<li><strong>状态增量更新</strong>：只更新变更的状态变量，减少存储开销</li>
</ul>
<h2 id="8">8. 安全考虑</h2>
<h3 id="81">8.1 密码学安全</h3>
<ul>
<li><strong>强哈希函数</strong>：使用SHA-256等强哈希函数</li>
<li><strong>随机数生成</strong>：使用密码学安全的随机数生成器</li>
<li><strong>承诺不可逆性</strong>：确保承诺值无法被逆向计算</li>
</ul>
<h3 id="82">8.2 状态安全</h3>
<ul>
<li><strong>状态验证</strong>：所有状态变更必须通过验证</li>
<li><strong>权限控制</strong>：基于NFT状态控制操作权限</li>
<li><strong>状态一致性</strong>：确保NFT状态在所有节点间保持一致</li>
</ul>
<h3 id="83">8.3 防攻击机制</h3>
<ul>
<li><strong>重放攻击防护</strong>：使用时间戳和唯一标识防止重放</li>
<li><strong>Sybil攻击防护</strong>：通过NFT所有权验证防止Sybil攻击</li>
<li><strong>操纵攻击防护</strong>：通过密码学技术防止结果操纵</li>
</ul>
<h2 id="9">9. 总结</h2>
<p>本多目标选择技术实现方案详细描述了如何通过NFT类型控制不同的多目标选择应用场景，以及如何通过NFT全局状态变量控制比特承诺功能的执行状态。</p>
<h3 id="91">9.1 核心优势</h3>
<ol>
<li><strong>NFT类型驱动</strong>：通过NFT类型控制不同的多目标选择应用场景</li>
<li><strong>状态精确控制</strong>：NFT全局状态变量精确控制比特承诺功能的执行</li>
<li><strong>自动化处理</strong>：iAgent自动化处理所有通信和计算过程</li>
<li><strong>公平性保障</strong>：基于密码学技术确保选择过程的公平性</li>
<li><strong>可扩展性</strong>：支持大规模参与者和多种应用场景</li>
</ol>
<h3 id="92">9.2 技术特色</h3>
<ol>
<li><strong>NFT状态集成</strong>：多目标选择算法与NFT状态深度集成</li>
<li><strong>智能合约支持</strong>：完整的智能合约支持，确保链上状态一致性</li>
<li><strong>WebAssembly引擎</strong>：高性能的WebAssembly处理引擎</li>
<li><strong>IPFS存储</strong>：去中心化的IPFS存储，确保数据可用性</li>
</ol>
<h3 id="93">9.3 应用价值</h3>
<ol>
<li><strong>降低开发成本</strong>：新应用场景可以通过定义新的NFT类型快速开发</li>
<li><strong>提高系统利用率</strong>：一个系统支持多种多目标选择应用场景</li>
<li><strong>增强用户体验</strong>：用户可以在一个平台上参与多种选择活动</li>
<li><strong>促进生态发展</strong>：为开发者提供丰富的多目标选择支持</li>
</ol>
<p>通过本方案，系统成功实现了多目标选择功能的NFT类型化控制，完全符合"不同的应用场景通过不同的NFT类型进行控制"的顶层设计思想，为用户提供了更加清晰、统一、可扩展的多目标选择解决方案。</p>
<h2 id="_2">评估标准与结论</h2>
<h3 id="_3">评估标准（统一口径）</h3>
<ul>
<li>SoT与边界：统一“链上最小化 + IPFS（CID/版本为单一真实源）”。</li>
<li>算法公平性：n选k 唯一性与公开可验证性达标。</li>
<li>可扩展性：百万规模参与、批处理与并行揭示能力。</li>
<li>可运维性：iAgent自动化、监控与审计链路完整。</li>
</ul>
<h3 id="_4">结论</h3>
<p>本方案满足公平性、可验证性与扩展性要求，建议按详设实现并与统一状态机对齐落地。</p>
</body>
</html>