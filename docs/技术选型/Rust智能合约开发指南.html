<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Rust智能合约开发指南</title>
    <style>
        body {
            max-width: 860px;
            margin: 32px auto;
            padding: 0 16px;
            font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            line-height: 1.6;
            color: #1f2937;
        }
        pre { background:#f8fafc; padding:12px; overflow:auto; border-radius:6px; }
        code { background:#f1f5f9; padding:2px 4px; border-radius:4px; }
        h1,h2,h3,h4,h5,h6 { line-height:1.25; }
        a { color:#2563eb; text-decoration:none; }
        a:hover { text-decoration:underline; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #e5e7eb; padding: 8px; }
        blockquote { margin: 0; padding-left: 1em; border-left: 4px solid #e5e7eb; color:#6b7280; }
    </style>
</head>
<body>
<h1 id="rust">Rust智能合约开发指南</h1>
<h2 id="_1">概述</h2>
<p>本指南详细介绍如何使用Rust语言和CosmWasm框架开发去中心化投票系统的智能合约。架构边界：
- 投票项目管理是NFT管理的属性接口，配置均为NFT类型的全局参数；
- 详细投票数据（承诺/揭示明细、计算过程、参与者列表、证明等）存储在IPFS；
- 链上仅记录账户与NFT的关联信息以及结果摘要/哈希/CID与必要索引。</p>
<h2 id="_2">技术栈</h2>
<ul>
<li><strong>开发语言</strong>：Rust</li>
<li><strong>智能合约框架</strong>：CosmWasm</li>
<li><strong>区块链平台</strong>：Injective Protocol</li>
<li><strong>开发工具</strong>：cargo, wasm-pack, cosmwasm-check</li>
</ul>
<h2 id="_3">环境搭建</h2>
<h3 id="1-rust">1. 安装Rust</h3>
<div class="codehilite"><pre><span></span><code>curl<span class="w"> </span>--proto<span class="w"> </span><span class="s1">&#39;=https&#39;</span><span class="w"> </span>--tlsv1.2<span class="w"> </span>-sSf<span class="w"> </span>https://sh.rustup.rs<span class="w"> </span><span class="p">|</span><span class="w"> </span>sh
<span class="nb">source</span><span class="w"> </span>~/.cargo/env
rustup<span class="w"> </span>default<span class="w"> </span>stable
</code></pre></div>

<h3 id="2-cosmwasm">2. 安装CosmWasm工具链</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 安装wasm-pack</span>
curl<span class="w"> </span>https://rustwasm.github.io/wasm-pack/installer/init.sh<span class="w"> </span>-sSf<span class="w"> </span><span class="p">|</span><span class="w"> </span>sh

<span class="c1"># 安装cosmwasm-check</span>
cargo<span class="w"> </span>install<span class="w"> </span>cosmwasm-check

<span class="c1"># 安装wasm-opt (可选，用于优化)</span>
cargo<span class="w"> </span>install<span class="w"> </span>wasm-opt
</code></pre></div>

<h3 id="3">3. 创建项目</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 创建新的CosmWasm项目</span>
cargo<span class="w"> </span>generate<span class="w"> </span>--git<span class="w"> </span>https://github.com/CosmWasm/cw-template.git<span class="w"> </span>--name<span class="w"> </span>decision-voting-contract
<span class="nb">cd</span><span class="w"> </span>decision-voting-contract
</code></pre></div>

<h2 id="_4">项目结构</h2>
<div class="codehilite"><pre><span></span><code>decision-voting-contract/
├── Cargo.toml                 # 项目配置
├── src/
│   ├── contract.rs            # 合约入口点
│   ├── msg.rs                 # 消息定义
│   ├── state.rs               # 状态定义
│   ├── error.rs               # 错误处理
│   └── lib.rs                 # 库入口
├── schema/                    # JSON Schema生成
├── tests/                     # 测试文件
└── examples/                  # 示例代码
</code></pre></div>

<h2 id="_5">核心组件</h2>
<h3 id="1-msgrs">1. 消息定义 (msg.rs)</h3>
<div class="codehilite"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">cosmwasm_std</span>::<span class="p">{</span><span class="n">Addr</span><span class="p">,</span><span class="w"> </span><span class="n">Uint128</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">schemars</span>::<span class="n">JsonSchema</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">serde</span>::<span class="p">{</span><span class="n">Deserialize</span><span class="p">,</span><span class="w"> </span><span class="n">Serialize</span><span class="p">};</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">ExecuteMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">CreateDecisionVote</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">title</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">min_preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">        </span><span class="n">max_preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">        </span><span class="n">start_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">        </span><span class="n">end_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">        </span><span class="n">max_votes</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">min_votes</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">is_lottery</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span><span class="w">                     </span><span class="c1">// NFT类型标识（作为投票项目属性接口的承载）</span>
<span class="w">        </span><span class="n">config_cid</span>: <span class="nb">String</span><span class="p">,</span><span class="w">                   </span><span class="c1">// IPFS上完整配置版本的CID（链上仅存指针）</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">SubmitPreferenceCommitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">commitment_hash</span>: <span class="nb">String</span><span class="p">,</span><span class="w">              </span><span class="c1">// 承诺哈希（明细存IPFS）</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">RevealPreferenceVote</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">        </span><span class="n">randomness</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span><span class="w">                     </span><span class="c1">// NFT类型</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="c1">// NFT类型管理</span>
<span class="w">    </span><span class="n">CreateNFTType</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">config</span>: <span class="nc">NFTTypeConfig</span><span class="p">,</span>
<span class="w">        </span><span class="n">state_schema</span>: <span class="nc">StateSchema</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">UpdateNFTState</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">variable_name</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">new_value</span>: <span class="nc">StateValue</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">QueryMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">GetDecisionVote</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">GetPreferenceCommitments</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">CalculateDecisionResult</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">CalculateLotteryResult</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">InstantiateMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">admin</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MigrateMsg</span><span class="w"> </span><span class="p">{}</span>
</code></pre></div>

<h3 id="2-staters">2. 状态定义 (state.rs)</h3>
<div class="codehilite"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">cosmwasm_std</span>::<span class="p">{</span><span class="n">Addr</span><span class="p">,</span><span class="w"> </span><span class="n">Storage</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">cosmwasm_storage</span>::<span class="p">{</span><span class="n">bucket</span><span class="p">,</span><span class="w"> </span><span class="n">bucket_read</span><span class="p">,</span><span class="w"> </span><span class="n">Bucket</span><span class="p">,</span><span class="w"> </span><span class="n">ReadonlyBucket</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">schemars</span>::<span class="n">JsonSchema</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">serde</span>::<span class="p">{</span><span class="n">Deserialize</span><span class="p">,</span><span class="w"> </span><span class="n">Serialize</span><span class="p">};</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">DecisionVote</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">title</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">min_preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">max_preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">start_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">end_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">max_votes</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">min_votes</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">is_active</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">result_hash</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">creator</span>: <span class="nc">Addr</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">is_lottery</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">PreferenceVoteCommitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">timestamp</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">decision_maker</span>: <span class="nc">Addr</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">is_revealed</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1">// 存储键定义</span>
<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">DECISION_VOTES</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">b&quot;decision_votes&quot;</span><span class="p">;</span>
<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">COMMITMENTS</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">b&quot;commitments&quot;</span><span class="p">;</span>
<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">VOTE_COUNTS</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">b&quot;vote_counts&quot;</span><span class="p">;</span>
<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">PREFERENCE_SUMS</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">b&quot;preference_sums&quot;</span><span class="p">;</span>
<span class="k">pub</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">LOTTERY_RESULTS</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">b&quot;lottery_results&quot;</span><span class="p">;</span>

<span class="c1">// 存储函数</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">decision_votes</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Bucket</span><span class="o">&lt;</span><span class="n">DecisionVote</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">bucket</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="n">DECISION_VOTES</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">decision_votes_read</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ReadonlyBucket</span><span class="o">&lt;</span><span class="n">DecisionVote</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">bucket_read</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="n">DECISION_VOTES</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">commitments</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Bucket</span><span class="o">&lt;</span><span class="n">PreferenceVoteCommitment</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">bucket</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="n">COMMITMENTS</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">commitments_read</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ReadonlyBucket</span><span class="o">&lt;</span><span class="n">PreferenceVoteCommitment</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">bucket_read</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="n">COMMITMENTS</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">vote_counts</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Bucket</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">bucket</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="n">VOTE_COUNTS</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">vote_counts_read</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ReadonlyBucket</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">bucket_read</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="n">VOTE_COUNTS</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">preference_sums</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Bucket</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">bucket</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="n">PREFERENCE_SUMS</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">preference_sums_read</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ReadonlyBucket</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">bucket_read</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="n">PREFERENCE_SUMS</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">lottery_results</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Bucket</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">bucket</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="n">LOTTERY_RESULTS</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">lottery_results_read</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">ReadonlyBucket</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">bucket_read</span><span class="p">(</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="n">LOTTERY_RESULTS</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="3-errorrs">3. 错误处理 (error.rs)</h3>
<div class="codehilite"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">cosmwasm_std</span>::<span class="n">StdError</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">thiserror</span>::<span class="n">Error</span><span class="p">;</span>

<span class="cp">#[derive(Error, Debug, PartialEq)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">ContractError</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;{0}&quot;</span><span class="cp">)]</span>
<span class="w">    </span><span class="n">Std</span><span class="p">(</span><span class="cp">#[from]</span><span class="w"> </span><span class="n">StdError</span><span class="p">),</span>

<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;Invalid preference range&quot;</span><span class="cp">)]</span>
<span class="w">    </span><span class="n">InvalidPreferenceRange</span><span class="p">,</span>

<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;Voting not started&quot;</span><span class="cp">)]</span>
<span class="w">    </span><span class="n">VotingNotStarted</span><span class="p">,</span>

<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;Voting ended&quot;</span><span class="cp">)]</span>
<span class="w">    </span><span class="n">VotingEnded</span><span class="p">,</span>

<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;Decision vote not active&quot;</span><span class="cp">)]</span>
<span class="w">    </span><span class="n">DecisionVoteNotActive</span><span class="p">,</span>

<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;Already voted&quot;</span><span class="cp">)]</span>
<span class="w">    </span><span class="n">AlreadyVoted</span><span class="p">,</span>

<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;No commitment found&quot;</span><span class="cp">)]</span>
<span class="w">    </span><span class="n">NoCommitmentFound</span><span class="p">,</span>

<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;Already revealed&quot;</span><span class="cp">)]</span>
<span class="w">    </span><span class="n">AlreadyRevealed</span><span class="p">,</span>

<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;Invalid commitment&quot;</span><span class="cp">)]</span>
<span class="w">    </span><span class="n">InvalidCommitment</span><span class="p">,</span>

<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;Preference out of range&quot;</span><span class="cp">)]</span>
<span class="w">    </span><span class="n">PreferenceOutOfRange</span><span class="p">,</span>

<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;Not a lottery&quot;</span><span class="cp">)]</span>
<span class="w">    </span><span class="n">NotALottery</span><span class="p">,</span>

<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;No participants&quot;</span><span class="cp">)]</span>
<span class="w">    </span><span class="n">NoParticipants</span><span class="p">,</span>

<span class="w">    </span><span class="cp">#[error(</span><span class="s">&quot;Decision vote not found&quot;</span><span class="cp">)]</span>
<span class="w">    </span><span class="n">DecisionVoteNotFound</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="4-contractrs">4. 合约实现 (contract.rs)</h3>
<div class="codehilite"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">cosmwasm_std</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">entry_point</span><span class="p">,</span><span class="w"> </span><span class="n">to_binary</span><span class="p">,</span><span class="w"> </span><span class="n">Binary</span><span class="p">,</span><span class="w"> </span><span class="n">Deps</span><span class="p">,</span><span class="w"> </span><span class="n">DepsMut</span><span class="p">,</span><span class="w"> </span><span class="n">Env</span><span class="p">,</span><span class="w"> </span><span class="n">MessageInfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">StdResult</span><span class="p">,</span><span class="w"> </span><span class="n">Addr</span><span class="p">,</span><span class="w"> </span><span class="n">StdError</span><span class="p">,</span>
<span class="p">};</span>

<span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">error</span>::<span class="n">ContractError</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">msg</span>::<span class="p">{</span><span class="n">ExecuteMsg</span><span class="p">,</span><span class="w"> </span><span class="n">InstantiateMsg</span><span class="p">,</span><span class="w"> </span><span class="n">MigrateMsg</span><span class="p">,</span><span class="w"> </span><span class="n">QueryMsg</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">state</span>::<span class="o">*</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="k">crate</span>::<span class="n">crypto</span>::<span class="o">*</span><span class="p">;</span>

<span class="cp">#[entry_point]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">instantiate</span><span class="p">(</span>
<span class="w">    </span><span class="n">_deps</span>: <span class="nc">DepsMut</span><span class="p">,</span>
<span class="w">    </span><span class="n">_env</span>: <span class="nc">Env</span><span class="p">,</span>
<span class="w">    </span><span class="n">_info</span>: <span class="nc">MessageInfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">_msg</span>: <span class="nc">InstantiateMsg</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">ContractError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">new</span><span class="p">().</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;method&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;instantiate&quot;</span><span class="p">))</span>
<span class="p">}</span>

<span class="cp">#[entry_point]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute</span><span class="p">(</span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span>
<span class="w">    </span><span class="n">env</span>: <span class="nc">Env</span><span class="p">,</span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">msg</span>: <span class="nc">ExecuteMsg</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">ContractError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">CreateDecisionVote</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">min_preference</span><span class="p">,</span><span class="w"> </span><span class="n">max_preference</span><span class="p">,</span><span class="w"> </span><span class="n">start_time</span><span class="p">,</span><span class="w"> </span><span class="n">end_time</span><span class="p">,</span><span class="w"> </span><span class="n">max_votes</span><span class="p">,</span><span class="w"> </span><span class="n">min_votes</span><span class="p">,</span><span class="w"> </span><span class="n">is_lottery</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">execute_create_decision_vote</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">min_preference</span><span class="p">,</span><span class="w"> </span><span class="n">max_preference</span><span class="p">,</span><span class="w"> </span><span class="n">start_time</span><span class="p">,</span><span class="w"> </span><span class="n">end_time</span><span class="p">,</span><span class="w"> </span><span class="n">max_votes</span><span class="p">,</span><span class="w"> </span><span class="n">min_votes</span><span class="p">,</span><span class="w"> </span><span class="n">is_lottery</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">SubmitPreferenceCommitment</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">commitment</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">execute_submit_preference_commitment</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">commitment</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">RevealPreferenceVote</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">preference</span><span class="p">,</span><span class="w"> </span><span class="n">randomness</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">execute_reveal_preference_vote</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">preference</span><span class="p">,</span><span class="w"> </span><span class="n">randomness</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[entry_point]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">query</span><span class="p">(</span><span class="n">deps</span>: <span class="nc">Deps</span><span class="p">,</span><span class="w"> </span><span class="n">_env</span>: <span class="nc">Env</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span>: <span class="nc">QueryMsg</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="n">Binary</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">GetDecisionVote</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_decision_vote</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">GetPreferenceCommitments</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_preference_commitments</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">CalculateDecisionResult</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_calculate_decision_result</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">CalculateLotteryResult</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_calculate_lottery_result</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[entry_point]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">migrate</span><span class="p">(</span><span class="n">_deps</span>: <span class="nc">DepsMut</span><span class="p">,</span><span class="w"> </span><span class="n">_env</span>: <span class="nc">Env</span><span class="p">,</span><span class="w"> </span><span class="n">_msg</span>: <span class="nc">MigrateMsg</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="n">Response</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">default</span><span class="p">())</span>
<span class="p">}</span>

<span class="c1">// 实现具体的执行函数</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_create_decision_vote</span><span class="p">(</span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span>
<span class="w">    </span><span class="n">env</span>: <span class="nc">Env</span><span class="p">,</span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">title</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">min_preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="n">max_preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="n">start_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="n">end_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="n">max_votes</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">min_votes</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">is_lottery</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">ContractError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 验证输入参数</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">min_preference</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">max_preference</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">InvalidPreferenceRange</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">start_time</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">block</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">seconds</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">VotingNotStarted</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">end_time</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">start_time</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">Std</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;End time must be after start time&quot;</span><span class="p">)));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 生成决策投票ID</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate_decision_vote_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">env</span><span class="p">.</span><span class="n">block</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">seconds</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 创建决策投票</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">decision_vote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DecisionVote</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">title</span><span class="p">,</span>
<span class="w">        </span><span class="n">description</span><span class="p">,</span>
<span class="w">        </span><span class="n">min_preference</span><span class="p">,</span>
<span class="w">        </span><span class="n">max_preference</span><span class="p">,</span>
<span class="w">        </span><span class="n">start_time</span><span class="p">,</span>
<span class="w">        </span><span class="n">end_time</span><span class="p">,</span>
<span class="w">        </span><span class="n">max_votes</span><span class="p">,</span>
<span class="w">        </span><span class="n">min_votes</span><span class="p">,</span>
<span class="w">        </span><span class="n">is_active</span>: <span class="nc">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">result_hash</span>: <span class="nb">String</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">        </span><span class="n">creator</span>: <span class="nc">info</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">        </span><span class="n">is_lottery</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// 保存到存储</span>
<span class="w">    </span><span class="n">decision_votes</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">).</span><span class="n">save</span><span class="p">(</span><span class="n">decision_vote_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;create_decision_vote&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;decision_vote_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;creator&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">to_string</span><span class="p">()))</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_submit_preference_commitment</span><span class="p">(</span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span>
<span class="w">    </span><span class="n">env</span>: <span class="nc">Env</span><span class="p">,</span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">commitment</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">ContractError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 获取决策投票</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">decision_vote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decision_votes_read</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">decision_vote_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="n">ContractError</span>::<span class="n">DecisionVoteNotFound</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 验证投票状态</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">decision_vote</span><span class="p">.</span><span class="n">is_active</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">DecisionVoteNotActive</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">block</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">seconds</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">decision_vote</span><span class="p">.</span><span class="n">start_time</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">VotingNotStarted</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">block</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">seconds</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">decision_vote</span><span class="p">.</span><span class="n">end_time</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">VotingEnded</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 检查是否已经投票</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{}:{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">commitments_read</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">).</span><span class="n">load</span><span class="p">(</span><span class="n">commitment_key</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">()).</span><span class="n">is_ok</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">AlreadyVoted</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 创建承诺</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PreferenceVoteCommitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">commitment</span><span class="p">,</span>
<span class="w">        </span><span class="n">timestamp</span>: <span class="nc">env</span><span class="p">.</span><span class="n">block</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">seconds</span><span class="p">(),</span>
<span class="w">        </span><span class="n">decision_maker</span>: <span class="nc">info</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">        </span><span class="n">is_revealed</span>: <span class="nc">false</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// 保存承诺</span>
<span class="w">    </span><span class="n">commitments</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">).</span><span class="n">save</span><span class="p">(</span><span class="n">commitment_key</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">commitment_data</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 更新投票计数</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">current_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vote_counts_read</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">decision_vote_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">vote_counts</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">).</span><span class="n">save</span><span class="p">(</span><span class="n">decision_vote_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">current_count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;submit_preference_commitment&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;decision_vote_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;decision_maker&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;commitment&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">commitment</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_reveal_preference_vote</span><span class="p">(</span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span>
<span class="w">    </span><span class="n">env</span>: <span class="nc">Env</span><span class="p">,</span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="n">randomness</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">ContractError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 获取决策投票</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">decision_vote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decision_votes_read</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">decision_vote_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="n">ContractError</span>::<span class="n">DecisionVoteNotFound</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 验证投票状态</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">decision_vote</span><span class="p">.</span><span class="n">is_active</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">DecisionVoteNotActive</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">block</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">seconds</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">decision_vote</span><span class="p">.</span><span class="n">end_time</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">Std</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Voting not ended&quot;</span><span class="p">)));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 获取承诺</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{}:{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">);</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">commitment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">commitments</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">commitment_key</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="n">ContractError</span>::<span class="n">NoCommitmentFound</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 验证承诺</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">commitment</span><span class="p">.</span><span class="n">is_revealed</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">AlreadyRevealed</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">preference</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">decision_vote</span><span class="p">.</span><span class="n">min_preference</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">preference</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">decision_vote</span><span class="p">.</span><span class="n">max_preference</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">PreferenceOutOfRange</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 验证承诺的正确性</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">computed_commitment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compute_commitment</span><span class="p">(</span><span class="n">preference</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">randomness</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">computed_commitment</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">commitment</span><span class="p">.</span><span class="n">commitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ContractError</span>::<span class="n">InvalidCommitment</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 更新承诺状态</span>
<span class="w">    </span><span class="n">commitment</span><span class="p">.</span><span class="n">is_revealed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">true</span><span class="p">;</span>
<span class="w">    </span><span class="n">commitments</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">).</span><span class="n">save</span><span class="p">(</span><span class="n">commitment_key</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">commitment</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 更新偏好值汇总</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">current_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">preference_sums_read</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">decision_vote_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">    </span><span class="n">preference_sums</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">).</span><span class="n">save</span><span class="p">(</span><span class="n">decision_vote_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="p">(</span><span class="n">current_sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">preference</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;reveal_preference_vote&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;decision_vote_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;decision_maker&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;preference&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">preference</span><span class="p">.</span><span class="n">to_string</span><span class="p">()))</span>
<span class="p">}</span>

<span class="c1">// 查询函数实现</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">query_decision_vote</span><span class="p">(</span><span class="n">deps</span>: <span class="nc">Deps</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="n">DecisionVote</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">decision_votes_read</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">).</span><span class="n">load</span><span class="p">(</span><span class="n">decision_vote_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">())</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">query_preference_commitments</span><span class="p">(</span><span class="n">deps</span>: <span class="nc">Deps</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">PreferenceVoteCommitment</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 实现获取所有承诺的逻辑</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="fm">vec!</span><span class="p">[])</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">query_calculate_decision_result</span><span class="p">(</span><span class="n">deps</span>: <span class="nc">Deps</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">preference_sums_read</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">decision_vote_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Decision vote not found&quot;</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">query_calculate_lottery_result</span><span class="p">(</span><span class="n">deps</span>: <span class="nc">Deps</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">decision_vote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">decision_votes_read</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">decision_vote_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">map_err</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="o">|</span><span class="w"> </span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Decision vote not found&quot;</span><span class="p">))</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">decision_vote</span><span class="p">.</span><span class="n">is_lottery</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Not a lottery&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">vote_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">vote_counts_read</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">decision_vote_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">vote_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;No participants&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">preference_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">preference_sums_read</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">load</span><span class="p">(</span><span class="n">decision_vote_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">winner_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">preference_sum</span><span class="p">.</span><span class="n">unsigned_abs</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">vote_count</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 保存抽奖结果</span>
<span class="w">    </span><span class="n">lottery_results</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">).</span><span class="n">save</span><span class="p">(</span><span class="n">decision_vote_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">winner_index</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">winner_index</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="5-cryptors">5. 密码学模块 (crypto.rs)</h3>
<div class="codehilite"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">sha2</span>::<span class="p">{</span><span class="n">Sha256</span><span class="p">,</span><span class="w"> </span><span class="n">Digest</span><span class="p">};</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">generate_decision_vote_id</span><span class="p">(</span><span class="n">title</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">description</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">timestamp</span>: <span class="kp">&amp;</span><span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">sender</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">title</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">    </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">description</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">    </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">timestamp</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">    </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">sender</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">    </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{:x}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">())</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">compute_commitment</span><span class="p">(</span><span class="n">preference</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">randomness</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">preference</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">    </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">randomness</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">    </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{:x}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">())</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="_6">构建和测试</h2>
<h3 id="1">1. 构建合约</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 构建优化版本</span>
cargo<span class="w"> </span>wasm

<span class="c1"># 检查合约</span>
cosmwasm-check<span class="w"> </span>target/wasm32-unknown-unknown/release/decision_voting_contract.wasm

<span class="c1"># 优化WASM文件</span>
wasm-opt<span class="w"> </span>-Os<span class="w"> </span>target/wasm32-unknown-unknown/release/decision_voting_contract.wasm<span class="w"> </span>-o<span class="w"> </span>target/wasm32-unknown-unknown/release/decision_voting_contract_optimized.wasm
</code></pre></div>

<h3 id="2">2. 运行测试</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 运行所有测试</span>
cargo<span class="w"> </span><span class="nb">test</span>

<span class="c1"># 运行特定测试</span>
cargo<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test_create_decision_vote

<span class="c1"># 生成测试覆盖率报告</span>
cargo<span class="w"> </span>tarpaulin<span class="w"> </span>--out<span class="w"> </span>Html
</code></pre></div>

<h3 id="3-schema">3. 生成Schema</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 生成JSON Schema</span>
cargo<span class="w"> </span>schema
</code></pre></div>

<h2 id="_7">部署指南</h2>
<h3 id="1_1">1. 本地测试网</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 启动本地测试网</span>
injectived<span class="w"> </span>start<span class="w"> </span>--chain-id<span class="o">=</span>testnet

<span class="c1"># 部署合约</span>
injectived<span class="w"> </span>tx<span class="w"> </span>wasm<span class="w"> </span>store<span class="w"> </span>target/wasm32-unknown-unknown/release/decision_voting_contract_optimized.wasm<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--from<span class="o">=</span>mykey<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--chain-id<span class="o">=</span>testnet<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--gas<span class="o">=</span>auto<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--gas-adjustment<span class="o">=</span><span class="m">1</span>.3<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--yes
</code></pre></div>

<h3 id="2_1">2. 测试网部署</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 部署到Injective测试网</span>
injectived<span class="w"> </span>tx<span class="w"> </span>wasm<span class="w"> </span>store<span class="w"> </span>target/wasm32-unknown-unknown/release/decision_voting_contract_optimized.wasm<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--from<span class="o">=</span>mykey<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--chain-id<span class="o">=</span>injective-888<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--gas<span class="o">=</span>auto<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--gas-adjustment<span class="o">=</span><span class="m">1</span>.3<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--yes
</code></pre></div>

<h2 id="_8">最佳实践</h2>
<h3 id="1_2">1. 代码组织</h3>
<ul>
<li>使用模块化设计，分离关注点</li>
<li>实现清晰的错误处理</li>
<li>添加详细的文档注释</li>
<li>使用类型安全的API</li>
</ul>
<h3 id="2_2">2. 安全考虑</h3>
<ul>
<li>验证所有输入参数</li>
<li>实现适当的访问控制</li>
<li>使用安全的随机数生成</li>
<li>防止重入攻击</li>
<li>实现权限管理和审计日志</li>
</ul>
<h3 id="3-gas">3. Gas优化</h3>
<ul>
<li>优化存储布局</li>
<li>减少不必要的计算</li>
<li>使用批量操作</li>
<li>实现缓存机制</li>
</ul>
<h3 id="4">4. 测试策略</h3>
<ul>
<li>单元测试覆盖核心逻辑</li>
<li>集成测试验证端到端流程</li>
<li>压力测试验证性能</li>
<li>安全测试检查漏洞</li>
<li>边界条件测试和异常处理</li>
</ul>
<h2 id="_9">常见问题</h2>
<h2 id="_10">评估标准与结论</h2>
<h3 id="_11">评估标准（统一口径）</h3>
<ul>
<li>接口一致性：与概要/详设中消息与状态结构一致；SoT与链上最小化边界清晰。</li>
<li>安全性：输入校验、权限控制、重放与重入防护齐备。</li>
<li>可维护性：模块划分清晰、Schema齐全、测试覆盖充分。</li>
<li>可运维性：事件日志完整、错误可诊断、版本迁移机制。</li>
</ul>
<h3 id="_12">结论</h3>
<p>合约开发规范与实现路径明确，满足安全与可维护要求，建议按本指南推进实现与审计。</p>
<h3 id="1_3">1. 编译错误</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 检查Rust版本</span>
rustc<span class="w"> </span>--version

<span class="c1"># 更新依赖</span>
cargo<span class="w"> </span>update

<span class="c1"># 清理缓存</span>
cargo<span class="w"> </span>clean
</code></pre></div>

<h3 id="2_3">2. 部署失败</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 检查合约大小</span>
ls<span class="w"> </span>-la<span class="w"> </span>target/wasm32-unknown-unknown/release/*.wasm

<span class="c1"># 验证合约格式</span>
cosmwasm-check<span class="w"> </span>target/wasm32-unknown-unknown/release/*.wasm

<span class="c1"># 检查Gas限制</span>
injectived<span class="w"> </span>query<span class="w"> </span>gas-prices
</code></pre></div>

<h3 id="3_1">3. 测试失败</h3>
<div class="codehilite"><pre><span></span><code><span class="c1"># 检查测试环境</span>
cargo<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--verbose

<span class="c1"># 运行特定测试</span>
cargo<span class="w"> </span><span class="nb">test</span><span class="w"> </span>test_name<span class="w"> </span>--<span class="w"> </span>--nocapture

<span class="c1"># 检查测试依赖</span>
cargo<span class="w"> </span><span class="nb">test</span><span class="w"> </span>--no-default-features
</code></pre></div>

<h2 id="_13">参考资料</h2>
<ul>
<li><a href="https://docs.cosmwasm.com/">CosmWasm官方文档</a></li>
<li><a href="https://www.rust-lang.org/">Rust编程语言</a></li>
<li><a href="https://docs.injective.network/">Injective Protocol文档</a></li>
<li><a href="https://webassembly.org/">WebAssembly</a></li>
</ul>
<hr>
<p><strong>开发指南版本</strong>：1.0
<strong>最后更新</strong>：2025-08
<strong>维护人员</strong>：luckeedao 技术团队</p>
</body>
</html>