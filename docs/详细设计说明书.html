<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>详细设计说明书</title>
    <style>
        body {
            max-width: 860px;
            margin: 32px auto;
            padding: 0 16px;
            font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            line-height: 1.6;
            color: #1f2937;
        }
        pre { background:#f8fafc; padding:12px; overflow:auto; border-radius:6px; }
        code { background:#f1f5f9; padding:2px 4px; border-radius:4px; }
        h1,h2,h3,h4,h5,h6 { line-height:1.25; }
        a { color:#2563eb; text-decoration:none; }
        a:hover { text-decoration:underline; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #e5e7eb; padding: 8px; }
        blockquote { margin: 0; padding-left: 1em; border-left: 4px solid #e5e7eb; color:#6b7280; }
    </style>
</head>
<body>
<p>﻿# 基于比特承诺模型的去中心化投票系统详细设计说明书</p>
<blockquote>
<p>用词规范：请参阅《<a href="项目术语表.html">项目术语表</a>》以确保术语统一。
存储与模型澄清：投票项目管理属于NFT管理的属性接口，其配置为NFT类型的全局参数；详细投票数据（承诺/揭示、参与者、计算与证明、会话配置明细）存储在IPFS，链上仅记录账户与NFT的关联信息以及投票结果摘要/哈希/CID与必要索引。</p>
</blockquote>
<h1 id="_1">基于比特承诺模型的去中心化投票系统详细设计说明书</h1>
<h2 id="1">1. 密码学核心模块详细设计</h2>
<h3 id="11">1.1 比特承诺协议实现</h3>
<h4 id="111">1.1.1 核心数据结构</h4>
<div class="codehilite"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">sha2</span>::<span class="p">{</span><span class="n">Sha256</span><span class="p">,</span><span class="w"> </span><span class="n">Digest</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">rand</span>::<span class="p">{</span><span class="n">Rng</span><span class="p">,</span><span class="w"> </span><span class="n">RngCore</span><span class="p">};</span>

<span class="cp">#[derive(Debug, Clone, PartialEq)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">BitCommitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">opening</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">message_hash</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">CommitmentProof</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">opening</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">message</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">timestamp</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">IAgentConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">agent_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">automation_enabled</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">auto_commit_interval</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 自动承诺间隔（秒）</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">auto_reveal_delay</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span><span class="w">   </span><span class="c1">// 自动揭示延迟（秒）</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_strategy</span>: <span class="nc">CommitmentStrategy</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveal_conditions</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevealCondition</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">CommitmentStrategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Immediate</span><span class="p">,</span><span class="w">      </span><span class="c1">// 立即承诺</span>
<span class="w">    </span><span class="n">Scheduled</span><span class="p">,</span><span class="w">      </span><span class="c1">// 定时承诺</span>
<span class="w">    </span><span class="n">Conditional</span><span class="p">,</span><span class="w">    </span><span class="c1">// 条件触发承诺</span>
<span class="w">    </span><span class="n">Batch</span><span class="p">,</span><span class="w">          </span><span class="c1">// 批量承诺</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">RevealCondition</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">condition_type</span>: <span class="nc">RevealConditionType</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">threshold</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">time_trigger</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_count</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">RevealConditionType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">TimeBased</span><span class="p">,</span><span class="w">          </span><span class="c1">// 基于时间</span>
<span class="w">    </span><span class="n">ParticipantCount</span><span class="p">,</span><span class="w">   </span><span class="c1">// 基于参与者数量</span>
<span class="w">    </span><span class="n">Manual</span><span class="p">,</span><span class="w">             </span><span class="c1">// 手动触发</span>
<span class="w">    </span><span class="n">Automatic</span><span class="p">,</span><span class="w">          </span><span class="c1">// 自动触发</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="112">1.1.2 承诺生成算法</h4>
<div class="codehilite"><pre><span></span><code><span class="k">impl</span><span class="w"> </span><span class="n">BitCommitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">message</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(</span><span class="n">BitCommitment</span><span class="p">,</span><span class="w"> </span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span>::<span class="n">thread_rng</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">randomness</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">];</span>
<span class="w">        </span><span class="n">rng</span><span class="p">.</span><span class="n">fill_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">randomness</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">randomness</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">().</span><span class="n">into</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">message_hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">message_hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">message_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">message_hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">().</span><span class="n">into</span><span class="p">();</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">((</span><span class="n">BitCommitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">commitment</span><span class="p">,</span>
<span class="w">            </span><span class="n">opening</span>: <span class="nc">randomness</span><span class="p">,</span>
<span class="w">            </span><span class="n">message_hash</span><span class="p">,</span>
<span class="w">        </span><span class="p">},</span><span class="w"> </span><span class="n">randomness</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">verify</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">message</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">opening</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">computed_commitment</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">().</span><span class="n">into</span><span class="p">();</span>

<span class="w">        </span><span class="n">computed_commitment</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">commitment</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">reveal</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">randomness</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 验证随机数并返回原始消息</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">randomness</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">opening</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Some</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">message_hash</span><span class="p">.</span><span class="n">to_vec</span><span class="p">())</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">None</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

####<span class="w"> </span><span class="mf">1.1.3</span><span class="w"> </span><span class="n">iAgent自动化承诺管理</span>
<span class="err">```</span><span class="n">rust</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">IAgentCommitmentManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">config</span>: <span class="nc">IAgentConfig</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">pending_commitments</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">PendingCommitment</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_scheduler</span>: <span class="nc">CommitmentScheduler</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveal_monitor</span>: <span class="nc">RevealMonitor</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">PendingCommitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">message</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">randomness</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">created_at</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">scheduled_reveal_time</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">status</span>: <span class="nc">CommitmentStatus</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, PartialEq)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">CommitmentStatus</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Pending</span><span class="p">,</span>
<span class="w">    </span><span class="n">Committed</span><span class="p">,</span>
<span class="w">    </span><span class="n">Revealed</span><span class="p">,</span>
<span class="w">    </span><span class="n">Expired</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">IAgentCommitmentManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">config</span>: <span class="nc">IAgentConfig</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">config</span><span class="p">,</span>
<span class="w">            </span><span class="n">pending_commitments</span>: <span class="nc">HashMap</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">commitment_scheduler</span>: <span class="nc">CommitmentScheduler</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">reveal_monitor</span>: <span class="nc">RevealMonitor</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">setup_automated_commitment</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">message</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">strategy</span>: <span class="kp">&amp;</span><span class="nc">CommitmentStrategy</span><span class="p">,</span>
<span class="w">        </span><span class="n">conditions</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">RevealCondition</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 生成承诺</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">commitment</span><span class="p">,</span><span class="w"> </span><span class="n">randomness</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BitCommitment</span>::<span class="n">new</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_commitment_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">message</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 创建待处理承诺</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pending_commitment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PendingCommitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">commitment_id</span>: <span class="nc">commitment_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">message</span><span class="p">,</span>
<span class="w">            </span><span class="n">randomness</span><span class="p">,</span>
<span class="w">            </span><span class="n">created_at</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">            </span><span class="n">scheduled_reveal_time</span>: <span class="nc">self</span><span class="p">.</span><span class="n">calculate_reveal_time</span><span class="p">(</span><span class="o">&amp;</span><span class="n">conditions</span><span class="p">),</span>
<span class="w">            </span><span class="n">status</span>: <span class="nc">CommitmentStatus</span>::<span class="n">Pending</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// 根据策略安排承诺和揭示</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">strategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">CommitmentStrategy</span>::<span class="n">Immediate</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">execute_immediate_commitment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pending_commitment</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">CommitmentStrategy</span>::<span class="n">Scheduled</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">schedule_commitment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pending_commitment</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">CommitmentStrategy</span>::<span class="n">Conditional</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">setup_conditional_commitment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pending_commitment</span><span class="p">,</span><span class="w"> </span><span class="n">conditions</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">CommitmentStrategy</span>::<span class="n">Batch</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">add_to_batch_commitment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pending_commitment</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">pending_commitments</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">commitment_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">pending_commitment</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">commitment_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_automated_reveal</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">commitment_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">pending_commitment</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">pending_commitments</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="n">commitment_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">pending_commitment</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">CommitmentStatus</span>::<span class="n">Committed</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 执行自动揭示</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">reveal_commitment</span><span class="p">(</span><span class="n">pending_commitment</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">                </span><span class="n">pending_commitment</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CommitmentStatus</span>::<span class="n">Revealed</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_immediate_commitment</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">pending_commitment</span>: <span class="kp">&amp;</span><span class="nc">PendingCommitment</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 立即执行承诺</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BitCommitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">commitment</span>: <span class="nc">self</span><span class="p">.</span><span class="n">compute_commitment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pending_commitment</span><span class="p">.</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">pending_commitment</span><span class="p">.</span><span class="n">randomness</span><span class="p">),</span>
<span class="w">            </span><span class="n">opening</span>: <span class="nc">pending_commitment</span><span class="p">.</span><span class="n">randomness</span><span class="p">,</span>
<span class="w">            </span><span class="n">message_hash</span>: <span class="nc">self</span><span class="p">.</span><span class="n">compute_message_hash</span><span class="p">(</span><span class="o">&amp;</span><span class="n">pending_commitment</span><span class="p">.</span><span class="n">message</span><span class="p">),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// 提交到区块链</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">submit_commitment_to_blockchain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commitment</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 如果配置了自动揭示，安排揭示任务</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">reveal_delay</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">auto_reveal_delay</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">schedule_reveal</span><span class="p">(</span><span class="n">pending_commitment</span><span class="p">,</span><span class="w"> </span><span class="n">reveal_delay</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">schedule_commitment</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">pending_commitment</span>: <span class="kp">&amp;</span><span class="nc">PendingCommitment</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">interval</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">config</span><span class="p">.</span><span class="n">auto_commit_interval</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">scheduled_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">interval</span><span class="p">;</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">commitment_scheduler</span><span class="p">.</span><span class="n">schedule_commitment</span><span class="p">(</span>
<span class="w">                </span><span class="n">pending_commitment</span><span class="p">.</span><span class="n">commitment_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">                </span><span class="n">scheduled_time</span><span class="p">,</span>
<span class="w">                </span><span class="n">pending_commitment</span><span class="p">.</span><span class="n">clone</span><span class="p">()</span>
<span class="w">            </span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">setup_conditional_commitment</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">pending_commitment</span>: <span class="kp">&amp;</span><span class="nc">PendingCommitment</span><span class="p">,</span>
<span class="w">        </span><span class="n">conditions</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">RevealCondition</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">condition</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">conditions</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">match</span><span class="w"> </span><span class="n">condition</span><span class="p">.</span><span class="n">condition_type</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">RevealConditionType</span>::<span class="n">TimeBased</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">time_trigger</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">condition</span><span class="p">.</span><span class="n">time_trigger</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="bp">self</span><span class="p">.</span><span class="n">reveal_monitor</span><span class="p">.</span><span class="n">add_time_condition</span><span class="p">(</span>
<span class="w">                            </span><span class="n">pending_commitment</span><span class="p">.</span><span class="n">commitment_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">                            </span><span class="n">time_trigger</span>
<span class="w">                        </span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">RevealConditionType</span>::<span class="n">ParticipantCount</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">threshold</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">condition</span><span class="p">.</span><span class="n">threshold</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="bp">self</span><span class="p">.</span><span class="n">reveal_monitor</span><span class="p">.</span><span class="n">add_participant_condition</span><span class="p">(</span>
<span class="w">                            </span><span class="n">pending_commitment</span><span class="p">.</span><span class="n">commitment_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">                            </span><span class="n">threshold</span>
<span class="w">                        </span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">RevealConditionType</span>::<span class="n">Automatic</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="c1">// 自动触发条件，基于系统状态</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">reveal_monitor</span><span class="p">.</span><span class="n">add_automatic_condition</span><span class="p">(</span>
<span class="w">                        </span><span class="n">pending_commitment</span><span class="p">.</span><span class="n">commitment_id</span><span class="p">.</span><span class="n">clone</span><span class="p">()</span>
<span class="w">                    </span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">                </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_to_batch_commitment</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">pending_commitment</span>: <span class="kp">&amp;</span><span class="nc">PendingCommitment</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 添加到批量承诺队列</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">commitment_scheduler</span><span class="p">.</span><span class="n">add_to_batch</span><span class="p">(</span><span class="n">pending_commitment</span><span class="p">.</span><span class="n">clone</span><span class="p">()).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">reveal_commitment</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">pending_commitment</span>: <span class="kp">&amp;</span><span class="nc">PendingCommitment</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 执行揭示操作</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">reveal_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RevealData</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">commitment_id</span>: <span class="nc">pending_commitment</span><span class="p">.</span><span class="n">commitment_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">message</span>: <span class="nc">pending_commitment</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">randomness</span>: <span class="nc">pending_commitment</span><span class="p">.</span><span class="n">randomness</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// 提交揭示到区块链</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">submit_reveal_to_blockchain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reveal_data</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">calculate_reveal_time</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">conditions</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">RevealCondition</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">condition</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">conditions</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">RevealConditionType</span>::<span class="n">TimeBased</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">condition</span><span class="p">.</span><span class="n">condition_type</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">time_trigger</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">condition</span><span class="p">.</span><span class="n">time_trigger</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">time_trigger</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nb">None</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">compute_commitment</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">message</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">],</span><span class="w"> </span><span class="n">randomness</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">randomness</span><span class="p">);</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">().</span><span class="n">into</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">compute_message_hash</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">message</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">().</span><span class="n">into</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">generate_commitment_id</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">message</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">message</span><span class="p">);</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">().</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;commitment_{:x}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">get_current_timestamp</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">time</span>::<span class="n">SystemTime</span>::<span class="n">now</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">duration_since</span><span class="p">(</span><span class="n">std</span>::<span class="n">time</span>::<span class="n">UNIX_EPOCH</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">as_secs</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">submit_commitment_to_blockchain</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">commitment</span>: <span class="kp">&amp;</span><span class="nc">BitCommitment</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现区块链提交逻辑</span>
<span class="w">        </span><span class="c1">// 这里应该调用具体的区块链接口</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">submit_reveal_to_blockchain</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">reveal_data</span>: <span class="kp">&amp;</span><span class="nc">RevealData</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现区块链揭示提交逻辑</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">RevealData</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">message</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">randomness</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">CommitmentScheduler</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">scheduled_tasks</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">ScheduledTask</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">CommitmentScheduler</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">scheduled_tasks</span>: <span class="nc">HashMap</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">schedule_commitment</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">commitment_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">scheduled_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">        </span><span class="n">pending_commitment</span>: <span class="nc">PendingCommitment</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ScheduledTask</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">commitment_id</span>: <span class="nc">commitment_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">scheduled_time</span><span class="p">,</span>
<span class="w">            </span><span class="n">task_type</span>: <span class="nc">TaskType</span>::<span class="n">Commitment</span><span class="p">,</span>
<span class="w">            </span><span class="n">data</span>: <span class="nc">pending_commitment</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">scheduled_tasks</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">commitment_id</span><span class="p">,</span><span class="w"> </span><span class="n">task</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_to_batch</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">pending_commitment</span>: <span class="nc">PendingCommitment</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现批量处理逻辑</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ScheduledTask</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">scheduled_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">task_type</span>: <span class="nc">TaskType</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">data</span>: <span class="nc">PendingCommitment</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">TaskType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Commitment</span><span class="p">,</span>
<span class="w">    </span><span class="n">Reveal</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">RevealMonitor</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">time_conditions</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_conditions</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">automatic_conditions</span>: <span class="nc">HashSet</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">RevealMonitor</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">time_conditions</span>: <span class="nc">HashMap</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">participant_conditions</span>: <span class="nc">HashMap</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">automatic_conditions</span>: <span class="nc">HashSet</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_time_condition</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">commitment_id</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">trigger_time</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">time_conditions</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">commitment_id</span><span class="p">,</span><span class="w"> </span><span class="n">trigger_time</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_participant_condition</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">commitment_id</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">threshold</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">participant_conditions</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">commitment_id</span><span class="p">,</span><span class="w"> </span><span class="n">threshold</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_automatic_condition</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">commitment_id</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">automatic_conditions</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">commitment_id</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="12">1.2 中奖序号生成算法</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">WinningNumberGenerator</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">algorithm</span>: <span class="nc">WinningNumberAlgorithm</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">seed</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">WinningNumberAlgorithm</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Deterministic</span><span class="p">,</span><span class="w">    </span><span class="c1">// 确定性算法</span>
<span class="w">    </span><span class="n">PseudoRandom</span><span class="p">,</span><span class="w">     </span><span class="c1">// 伪随机算法</span>
<span class="w">    </span><span class="n">HashBased</span><span class="p">,</span><span class="w">        </span><span class="c1">// 基于哈希的算法</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">WinningNumberGenerator</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">algorithm</span>: <span class="nc">WinningNumberAlgorithm</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">algorithm</span><span class="p">,</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">generate_winning_number</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_data</span>: <span class="kp">&amp;</span><span class="nc">ParticipantData</span><span class="p">,</span>
<span class="w">        </span><span class="n">tier_config</span>: <span class="kp">&amp;</span><span class="nc">LotteryTierConfig</span><span class="p">,</span>
<span class="w">        </span><span class="n">position</span>: <span class="kt">u32</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">algorithm</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">WinningNumberAlgorithm</span>::<span class="n">Deterministic</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_deterministic_number</span><span class="p">(</span><span class="n">participant_data</span><span class="p">,</span><span class="w"> </span><span class="n">tier_config</span><span class="p">,</span><span class="w"> </span><span class="n">position</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">WinningNumberAlgorithm</span>::<span class="n">PseudoRandom</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_pseudo_random_number</span><span class="p">(</span><span class="n">participant_data</span><span class="p">,</span><span class="w"> </span><span class="n">tier_config</span><span class="p">,</span><span class="w"> </span><span class="n">position</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">WinningNumberAlgorithm</span>::<span class="n">HashBased</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_hash_based_number</span><span class="p">(</span><span class="n">participant_data</span><span class="p">,</span><span class="w"> </span><span class="n">tier_config</span><span class="p">,</span><span class="w"> </span><span class="n">position</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">generate_deterministic_number</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_data</span>: <span class="kp">&amp;</span><span class="nc">ParticipantData</span><span class="p">,</span>
<span class="w">        </span><span class="n">tier_config</span>: <span class="kp">&amp;</span><span class="nc">LotteryTierConfig</span><span class="p">,</span>
<span class="w">        </span><span class="n">position</span>: <span class="kt">u32</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span>
<span class="w">        </span><span class="c1">// 基于参与者数据和等级配置生成确定性中奖序号</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tier_config</span><span class="p">.</span><span class="n">tier_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">position_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">participant_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">hash_participant_data</span><span class="p">(</span><span class="n">participant_data</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">hash_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">participant_hash</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">100</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">;</span>

<span class="w">        </span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">position_offset</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hash_offset</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">generate_pseudo_random_number</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_data</span>: <span class="kp">&amp;</span><span class="nc">ParticipantData</span><span class="p">,</span>
<span class="w">        </span><span class="n">tier_config</span>: <span class="kp">&amp;</span><span class="nc">LotteryTierConfig</span><span class="p">,</span>
<span class="w">        </span><span class="n">position</span>: <span class="kt">u32</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span>
<span class="w">        </span><span class="c1">// 使用种子和参与者数据生成伪随机中奖序号</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">create_seeded_rng</span><span class="p">(</span><span class="n">participant_data</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tier_config</span><span class="p">.</span><span class="n">tier_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">random_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rng</span><span class="p">.</span><span class="n">gen_range</span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="mi">10000</span><span class="p">);</span>

<span class="w">        </span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">random_offset</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">generate_hash_based_number</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_data</span>: <span class="kp">&amp;</span><span class="nc">ParticipantData</span><span class="p">,</span>
<span class="w">        </span><span class="n">tier_config</span>: <span class="kp">&amp;</span><span class="nc">LotteryTierConfig</span><span class="p">,</span>
<span class="w">        </span><span class="n">position</span>: <span class="kt">u32</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span>
<span class="w">        </span><span class="c1">// 基于哈希值生成中奖序号</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">seed</span><span class="p">);</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">participant_data</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">tier_config</span><span class="p">.</span><span class="n">tier_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">position</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">hash_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">hash_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u64</span>::<span class="n">from_be_bytes</span><span class="p">([</span>
<span class="w">            </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
<span class="w">            </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
<span class="w">        </span><span class="p">]);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tier_config</span><span class="p">.</span><span class="n">tier_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">hash_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash_value</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span>

<span class="w">        </span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hash_offset</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">hash_participant_data</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">participant_data</span>: <span class="kp">&amp;</span><span class="nc">ParticipantData</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">participant_data</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">participant_data</span><span class="p">.</span><span class="n">random_number</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">participant_data</span><span class="p">.</span><span class="n">nft_token_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">hash_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">        </span><span class="kt">u64</span>::<span class="n">from_be_bytes</span><span class="p">([</span>
<span class="w">            </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
<span class="w">            </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
<span class="w">        </span><span class="p">])</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">create_seeded_rng</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">participant_data</span>: <span class="kp">&amp;</span><span class="nc">ParticipantData</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Rng</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">];</span>
<span class="w">        </span><span class="n">seed</span><span class="p">[</span><span class="o">..</span><span class="mi">16</span><span class="p">].</span><span class="n">copy_from_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">seed</span><span class="p">[</span><span class="o">..</span><span class="mi">16</span><span class="p">]);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">participant_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">hash_participant_data</span><span class="p">(</span><span class="n">participant_data</span><span class="p">);</span>
<span class="w">        </span><span class="n">seed</span><span class="p">[</span><span class="mi">16</span><span class="o">..</span><span class="mi">24</span><span class="p">].</span><span class="n">copy_from_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">participant_hash</span><span class="p">.</span><span class="n">to_be_bytes</span><span class="p">());</span>

<span class="w">        </span><span class="n">rand</span>::<span class="n">SeedableRng</span>::<span class="n">from_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ParticipantData</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">address</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">random_number</span>: <span class="kt">i64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_token_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">voting_project_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LotteryTierConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tier_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tier_name</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">prize_description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winner_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">min_participants</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">probability</span>: <span class="kt">f64</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="13">1.3 安全随机数生成器</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">SecureRandomGenerator</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">rng</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">RngCore</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">SecureRandomGenerator</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">rng</span>: <span class="nb">Box</span>::<span class="n">new</span><span class="p">(</span><span class="n">rand</span>::<span class="n">thread_rng</span><span class="p">()),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">generate_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">length</span>: <span class="kt">usize</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">bytes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="n">length</span><span class="p">];</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">rng</span><span class="p">.</span><span class="n">fill_bytes</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">bytes</span><span class="p">);</span>
<span class="w">        </span><span class="n">bytes</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">generate_u64</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">rng</span><span class="p">.</span><span class="n">gen</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="2">2. 代币验证模块详细设计</h2>
<h3 id="21">2.1 代币持有验证实现</h3>
<div class="codehilite"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">cosmwasm_std</span>::<span class="p">{</span><span class="n">Uint128</span><span class="p">,</span><span class="w"> </span><span class="n">Addr</span><span class="p">,</span><span class="w"> </span><span class="n">StdResult</span><span class="p">,</span><span class="w"> </span><span class="n">StdError</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">serde</span>::<span class="p">{</span><span class="n">Deserialize</span><span class="p">,</span><span class="w"> </span><span class="n">Serialize</span><span class="p">};</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">TokenBalance</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">address</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">balance</span>: <span class="nc">Uint128</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">symbol</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">decimals</span>: <span class="kt">u8</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">TokenVerificationResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">is_verified</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">balance</span>: <span class="nc">Uint128</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">min_requirement</span>: <span class="nc">Uint128</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">verification_timestamp</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">TokenVerifier</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">contract_address</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">min_token_amount</span>: <span class="nc">Uint128</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">client</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">BlockchainClient</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">TokenVerifier</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">contract_address</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">min_token_amount</span>: <span class="nc">Uint128</span><span class="p">,</span><span class="w"> </span><span class="n">client</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">BlockchainClient</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">contract_address</span><span class="p">,</span>
<span class="w">            </span><span class="n">min_token_amount</span><span class="p">,</span>
<span class="w">            </span><span class="n">client</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">verify_token_holding</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">user_address</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">TokenVerificationResult</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 查询用户代币余额</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">query_token_balance</span><span class="p">(</span><span class="n">user_address</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 验证是否满足最小持有量要求</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">is_verified</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">min_token_amount</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">TokenVerificationResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">is_verified</span><span class="p">,</span>
<span class="w">            </span><span class="n">balance</span><span class="p">,</span>
<span class="w">            </span><span class="n">min_requirement</span>: <span class="nc">self</span><span class="p">.</span><span class="n">min_token_amount</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">verification_timestamp</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">query_token_balance</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">user_address</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Uint128</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 调用代币合约查询余额</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">query_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">TokenQueryMsg</span>::<span class="n">Balance</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">address</span>: <span class="nc">user_address</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">client</span>
<span class="w">            </span><span class="p">.</span><span class="n">query_contract</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">query_msg</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">balance</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">verify_multiple_users</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">user_addresses</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="nb">String</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">TokenVerificationResult</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">results</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 并行验证多个用户</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">verification_tasks</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_addresses</span>
<span class="w">            </span><span class="p">.</span><span class="n">iter</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">address</span><span class="o">|</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">verify_token_holding</span><span class="p">(</span><span class="n">address</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="n">collect</span><span class="p">();</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">verification_tasks</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">task</span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">results</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">result</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_current_timestamp</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">time</span>::<span class="n">SystemTime</span>::<span class="n">now</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">duration_since</span><span class="p">(</span><span class="n">std</span>::<span class="n">time</span>::<span class="n">UNIX_EPOCH</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">as_secs</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">TokenQueryMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Balance</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">address</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">TokenInfo</span><span class="w"> </span><span class="p">{},</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">TokenBalanceResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">balance</span>: <span class="nc">Uint128</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">TokenInfoResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">symbol</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">decimals</span>: <span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">total_supply</span>: <span class="nc">Uint128</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">BlockchainClient</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">query_contract</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">contract_address</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">query_msg</span>: <span class="kp">&amp;</span><span class="nc">TokenQueryMsg</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">TokenBalanceResponse</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="22">2.2 代币权限控制实现</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">TokenPermissionManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">verifier</span>: <span class="nc">TokenVerifier</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">permission_levels</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">PermissionLevel</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">PermissionLevel</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Basic</span><span class="p">,</span><span class="w">      </span><span class="c1">// 基础权限：可以参与投票</span>
<span class="w">    </span><span class="n">Creator</span><span class="p">,</span><span class="w">    </span><span class="c1">// 创建者权限：可以创建投票项目</span>
<span class="w">    </span><span class="n">Admin</span><span class="p">,</span><span class="w">      </span><span class="c1">// 管理员权限：可以管理所有功能</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">TokenPermissionManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">verifier</span>: <span class="nc">TokenVerifier</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">permission_levels</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashMap</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">permission_levels</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&quot;basic&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">PermissionLevel</span>::<span class="n">Basic</span><span class="p">);</span>
<span class="w">        </span><span class="n">permission_levels</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&quot;creator&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">PermissionLevel</span>::<span class="n">Creator</span><span class="p">);</span>
<span class="w">        </span><span class="n">permission_levels</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="s">&quot;admin&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">PermissionLevel</span>::<span class="n">Admin</span><span class="p">);</span>

<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">verifier</span><span class="p">,</span>
<span class="w">            </span><span class="n">permission_levels</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">check_permission</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">user_address</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">required_level</span>: <span class="kp">&amp;</span><span class="nc">PermissionLevel</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">verification_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">verifier</span><span class="p">.</span><span class="n">verify_token_holding</span><span class="p">(</span><span class="n">user_address</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">verification_result</span><span class="p">.</span><span class="n">is_verified</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">user_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_user_permission_level</span><span class="p">(</span><span class="o">&amp;</span><span class="n">verification_result</span><span class="p">.</span><span class="n">balance</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">can_access_level</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_level</span><span class="p">,</span><span class="w"> </span><span class="n">required_level</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">get_user_permission_level</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span>: <span class="kp">&amp;</span><span class="nc">Uint128</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">PermissionLevel</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 根据代币持有量确定权限等级</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Uint128</span>::<span class="n">new</span><span class="p">(</span><span class="mi">10000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">PermissionLevel</span>::<span class="n">Admin</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">Uint128</span>::<span class="n">new</span><span class="p">(</span><span class="mi">1000</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">PermissionLevel</span>::<span class="n">Creator</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">PermissionLevel</span>::<span class="n">Basic</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">can_access_level</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">user_level</span>: <span class="kp">&amp;</span><span class="nc">PermissionLevel</span><span class="p">,</span><span class="w"> </span><span class="n">required_level</span>: <span class="kp">&amp;</span><span class="nc">PermissionLevel</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="n">user_level</span><span class="p">,</span><span class="w"> </span><span class="n">required_level</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">(</span><span class="n">PermissionLevel</span>::<span class="n">Admin</span><span class="p">,</span><span class="w"> </span><span class="n">_</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="p">(</span><span class="n">PermissionLevel</span>::<span class="n">Creator</span><span class="p">,</span><span class="w"> </span><span class="n">PermissionLevel</span>::<span class="n">Creator</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="p">(</span><span class="n">PermissionLevel</span>::<span class="n">Creator</span><span class="p">,</span><span class="w"> </span><span class="n">PermissionLevel</span>::<span class="n">Basic</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="p">(</span><span class="n">PermissionLevel</span>::<span class="n">Basic</span><span class="p">,</span><span class="w"> </span><span class="n">PermissionLevel</span>::<span class="n">Basic</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="3-nft">3. NFT管理模块详细设计</h2>
<h3 id="31-nft">3.1 NFT创建和管理实现</h3>
<div class="codehilite"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">cosmwasm_std</span>::<span class="p">{</span><span class="n">Addr</span><span class="p">,</span><span class="w"> </span><span class="n">Storage</span><span class="p">,</span><span class="w"> </span><span class="n">StdResult</span><span class="p">,</span><span class="w"> </span><span class="n">StdError</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">serde</span>::<span class="p">{</span><span class="n">Deserialize</span><span class="p">,</span><span class="w"> </span><span class="n">Serialize</span><span class="p">};</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTMetadata</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">image</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">attributes</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">NFTAttribute</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">voting_project_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">lottery_tier</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">LotteryTier</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winning_number</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">created_at</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">updated_at</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTAttribute</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">trait_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">value</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">display_type</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LotteryTier</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tier_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tier_name</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">prize_description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winner_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">contract_address</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_standard</span>: <span class="nc">NFTStandard</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">storage_adapter</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">StorageAdapter</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">client</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">BlockchainClient</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">NFTStandard</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">CW721</span><span class="p">,</span>
<span class="w">    </span><span class="n">CW1155</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">NFTManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span>
<span class="w">        </span><span class="n">contract_address</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_standard</span>: <span class="nc">NFTStandard</span><span class="p">,</span>
<span class="w">        </span><span class="n">storage_adapter</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">StorageAdapter</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">client</span>: <span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">BlockchainClient</span><span class="o">&gt;</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">contract_address</span><span class="p">,</span>
<span class="w">            </span><span class="n">nft_standard</span><span class="p">,</span>
<span class="w">            </span><span class="n">storage_adapter</span><span class="p">,</span>
<span class="w">            </span><span class="n">client</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">create_voting_nft</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span>: <span class="nc">NFTMetadata</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 存储NFT元数据到IPFS</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">metadata_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">storage_adapter</span><span class="p">.</span><span class="n">store_nft_metadata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">metadata</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 生成唯一的token_id</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">token_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_token_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">metadata</span><span class="p">.</span><span class="n">voting_project_id</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 创建NFT</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">mint_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NFTMintMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">token_id</span>: <span class="nc">token_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">owner</span>: <span class="nc">metadata</span><span class="p">.</span><span class="n">voting_project_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">token_uri</span>: <span class="nc">metadata_uri</span><span class="p">,</span>
<span class="w">            </span><span class="n">extension</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">client</span>
<span class="w">            </span><span class="p">.</span><span class="n">execute_contract</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mint_msg</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">token_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">verify_nft_ownership</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">user_address</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">token_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 验证用户是否拥有指定NFT</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">query_nft_owner</span><span class="p">(</span><span class="n">token_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">owner</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">user_address</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">assign_winning_number</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">token_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">winning_number</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 获取当前NFT元数据</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">current_metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_nft_metadata</span><span class="p">(</span><span class="n">token_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 更新中奖序号</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">updated_metadata</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">current_metadata</span><span class="p">;</span>
<span class="w">        </span><span class="n">updated_metadata</span><span class="p">.</span><span class="n">winning_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">winning_number</span><span class="p">);</span>
<span class="w">        </span><span class="n">updated_metadata</span><span class="p">.</span><span class="n">updated_at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 存储更新后的元数据</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">new_metadata_uri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">storage_adapter</span><span class="p">.</span><span class="n">store_nft_metadata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">updated_metadata</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 更新NFT合约中的token_uri</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">update_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NFTUpdateMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">token_id</span>: <span class="nc">token_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">token_uri</span>: <span class="nc">new_metadata_uri</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">client</span>
<span class="w">            </span><span class="p">.</span><span class="n">execute_contract</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">update_msg</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">batch_create_nfts</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">metadata_list</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">NFTMetadata</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">token_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 并行创建多个NFT</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">creation_tasks</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">metadata_list</span>
<span class="w">            </span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">metadata</span><span class="o">|</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">create_voting_nft</span><span class="p">(</span><span class="n">metadata</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="n">collect</span><span class="p">();</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">creation_tasks</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">token_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">task</span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">token_ids</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">token_id</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">token_ids</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">batch_assign_winning_numbers</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">assignments</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="p">(</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="kt">u64</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 批量分配中奖序号</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">assignment_tasks</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">_</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assignments</span>
<span class="w">            </span><span class="p">.</span><span class="n">into_iter</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="p">(</span><span class="n">token_id</span><span class="p">,</span><span class="w"> </span><span class="n">winning_number</span><span class="p">)</span><span class="o">|</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">assign_winning_number</span><span class="p">(</span><span class="o">&amp;</span><span class="n">token_id</span><span class="p">,</span><span class="w"> </span><span class="n">winning_number</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="n">collect</span><span class="p">();</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">task</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">assignment_tasks</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">task</span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">generate_token_id</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">voting_project_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">voting_project_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">().</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">hash_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">        </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;voting_nft_{:x}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">hash_result</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">query_nft_owner</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">token_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">query_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NFTQueryMsg</span>::<span class="n">OwnerOf</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">token_id</span>: <span class="nc">token_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">client</span>
<span class="w">            </span><span class="p">.</span><span class="n">query_contract</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">query_msg</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">owner</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_nft_metadata</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">token_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">NFTMetadata</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">query_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NFTQueryMsg</span>::<span class="n">TokenInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">token_id</span>: <span class="nc">token_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">client</span>
<span class="w">            </span><span class="p">.</span><span class="n">query_contract</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">query_msg</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">storage_adapter</span><span class="p">.</span><span class="n">retrieve_nft_metadata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">response</span><span class="p">.</span><span class="n">token_uri</span><span class="p">).</span><span class="k">await</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">get_current_timestamp</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">time</span>::<span class="n">SystemTime</span>::<span class="n">now</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">duration_since</span><span class="p">(</span><span class="n">std</span>::<span class="n">time</span>::<span class="n">UNIX_EPOCH</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">as_secs</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">NFTExecuteMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Mint</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">token_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">owner</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">token_uri</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">extension</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Extension</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">TransferNft</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">recipient</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">token_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">UpdateMetadata</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">token_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">token_uri</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">NFTQueryMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">OwnerOf</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">token_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">TokenInfo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">token_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">NumTokens</span><span class="w"> </span><span class="p">{},</span>
<span class="w">    </span><span class="n">AllTokens</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">start_after</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">},</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTMintMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">token_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">owner</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">token_uri</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">extension</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Extension</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTUpdateMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">token_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">token_uri</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Extension</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">attributes</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">NFTAttribute</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">external_url</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">StorageAdapter</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">store_nft_metadata</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span>: <span class="kp">&amp;</span><span class="nc">NFTMetadata</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">retrieve_nft_metadata</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">uri</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">NFTMetadata</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">BlockchainClient</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_contract</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">contract_address</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span>: <span class="kp">&amp;</span><span class="nc">NFTExecuteMsg</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">ContractResponse</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">query_contract</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">contract_address</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">query_msg</span>: <span class="kp">&amp;</span><span class="nc">NFTQueryMsg</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">NFTQueryResponse</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ContractResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tx_hash</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTQueryResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">owner</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">token_uri</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="2-webassembly">2. WebAssembly服务器模块详细设计</h2>
<h3 id="21_1">2.1 投票生命周期管理</h3>
<h4 id="211">2.1.1 决策投票状态机</h4>
<div class="codehilite"><pre><span></span><code><span class="cp">#[derive(Debug, Clone, PartialEq)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">DecisionVoteStatus</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Created</span><span class="p">,</span>
<span class="w">    </span><span class="n">Active</span><span class="p">,</span>
<span class="w">    </span><span class="n">Paused</span><span class="p">,</span>
<span class="w">    </span><span class="n">Closed</span><span class="p">,</span>
<span class="w">    </span><span class="n">Tallied</span><span class="p">,</span>
<span class="w">    </span><span class="n">Cancelled</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">DecisionVoteStatus</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">can_transition_to</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">new_status</span>: <span class="kp">&amp;</span><span class="nc">DecisionVoteStatus</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">new_status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">(</span><span class="n">DecisionVoteStatus</span>::<span class="n">Created</span><span class="p">,</span><span class="w"> </span><span class="n">DecisionVoteStatus</span>::<span class="n">Active</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="p">(</span><span class="n">DecisionVoteStatus</span>::<span class="n">Active</span><span class="p">,</span><span class="w"> </span><span class="n">DecisionVoteStatus</span>::<span class="n">Paused</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="p">(</span><span class="n">DecisionVoteStatus</span>::<span class="n">Active</span><span class="p">,</span><span class="w"> </span><span class="n">DecisionVoteStatus</span>::<span class="n">Closed</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="p">(</span><span class="n">DecisionVoteStatus</span>::<span class="n">Paused</span><span class="p">,</span><span class="w"> </span><span class="n">DecisionVoteStatus</span>::<span class="n">Active</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="p">(</span><span class="n">DecisionVoteStatus</span>::<span class="n">Closed</span><span class="p">,</span><span class="w"> </span><span class="n">DecisionVoteStatus</span>::<span class="n">Tallied</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">DecisionVoteStatus</span>::<span class="n">Cancelled</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

####<span class="w"> </span><span class="mf">2.1.2</span><span class="w"> </span><span class="n">iAgent自动化投票管理</span>
<span class="err">```</span><span class="n">rust</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">IAgentVotingManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_manager</span>: <span class="nc">IAgentCommitmentManager</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">voting_automation</span>: <span class="nc">VotingAutomation</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">auto_reveal_service</span>: <span class="nc">AutoRevealService</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">VotingAutomation</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">auto_commit_enabled</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">auto_reveal_enabled</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">batch_processing</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">smart_timing</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">AutoRevealService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveal_triggers</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevealTrigger</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveal_queue</span>: <span class="nc">VecDeque</span><span class="o">&lt;</span><span class="n">RevealTask</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveal_worker</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">JoinHandle</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">RevealTrigger</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">trigger_type</span>: <span class="nc">TriggerType</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">condition</span>: <span class="nc">TriggerCondition</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">action</span>: <span class="nc">RevealAction</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">TriggerType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">TimeBased</span><span class="p">,</span>
<span class="w">    </span><span class="n">ParticipantCount</span><span class="p">,</span>
<span class="w">    </span><span class="n">VoteCompletion</span><span class="p">,</span>
<span class="w">    </span><span class="n">Manual</span><span class="p">,</span>
<span class="w">    </span><span class="n">Smart</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">TriggerCondition</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">threshold</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">time_window</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Duration</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_min</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">completion_percentage</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">f64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">RevealAction</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">RevealAll</span><span class="p">,</span>
<span class="w">    </span><span class="n">RevealBatch</span><span class="p">,</span>
<span class="w">    </span><span class="n">RevealSelected</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">),</span>
<span class="w">    </span><span class="n">NotifyAdmin</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">IAgentVotingManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">config</span>: <span class="nc">IAgentConfig</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">commitment_manager</span>: <span class="nc">IAgentCommitmentManager</span>::<span class="n">new</span><span class="p">(</span><span class="n">config</span><span class="p">),</span>
<span class="w">            </span><span class="n">voting_automation</span>: <span class="nc">VotingAutomation</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">auto_commit_enabled</span>: <span class="nc">true</span><span class="p">,</span>
<span class="w">                </span><span class="n">auto_reveal_enabled</span>: <span class="nc">true</span><span class="p">,</span>
<span class="w">                </span><span class="n">batch_processing</span>: <span class="nc">true</span><span class="p">,</span>
<span class="w">                </span><span class="n">smart_timing</span>: <span class="nc">true</span><span class="p">,</span>
<span class="w">            </span><span class="p">},</span>
<span class="w">            </span><span class="n">auto_reveal_service</span>: <span class="nc">AutoRevealService</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">setup_automated_voting</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">vote_config</span>: <span class="nc">AutomatedVoteConfig</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">vote_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_vote_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vote_config</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 设置自动化承诺</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">commitment_manager</span><span class="p">.</span><span class="n">setup_automated_commitment</span><span class="p">(</span>
<span class="w">            </span><span class="n">vote_config</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">vote_config</span><span class="p">.</span><span class="n">commitment_strategy</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">vote_config</span><span class="p">.</span><span class="n">reveal_conditions</span>
<span class="w">        </span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 配置自动揭示触发器</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">setup_reveal_triggers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vote_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vote_config</span><span class="p">.</span><span class="n">reveal_triggers</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 启动自动揭示服务</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">start_auto_reveal_service</span><span class="p">().</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">vote_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">process_automated_voting_cycle</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 检查投票状态</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">vote_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_vote_status</span><span class="p">(</span><span class="n">vote_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">vote_status</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">DecisionVoteStatus</span>::<span class="n">Active</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 执行自动承诺</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">execute_automated_commitment</span><span class="p">(</span><span class="n">vote_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">DecisionVoteStatus</span>::<span class="n">Closed</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 检查是否满足揭示条件</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">should_auto_reveal</span><span class="p">(</span><span class="n">vote_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">execute_automated_reveal</span><span class="p">(</span><span class="n">vote_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">setup_reveal_triggers</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">triggers</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">RevealTrigger</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">trigger</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">triggers</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">reveal_task</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">RevealTask</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">vote_id</span>: <span class="nc">vote_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">                </span><span class="n">trigger</span>: <span class="nc">trigger</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">                </span><span class="n">created_at</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">                </span><span class="n">status</span>: <span class="nc">TaskStatus</span>::<span class="n">Pending</span><span class="p">,</span>
<span class="w">            </span><span class="p">};</span>

<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">auto_reveal_service</span><span class="p">.</span><span class="n">reveal_queue</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">reveal_task</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">should_auto_reveal</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 检查各种揭示条件</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">vote_info</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_vote_info</span><span class="p">(</span><span class="n">vote_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 时间条件检查</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">check_time_condition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vote_info</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 参与者数量条件检查</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">check_participant_condition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vote_info</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 投票完成度检查</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">check_completion_condition</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vote_info</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="kc">true</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_automated_reveal</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 获取所有待揭示的承诺</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">pending_commitments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_pending_commitments</span><span class="p">(</span><span class="n">vote_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">commitment</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">pending_commitments</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">commitment_manager</span><span class="p">.</span><span class="n">execute_automated_reveal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commitment</span><span class="p">.</span><span class="n">commitment_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 更新投票状态</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">update_vote_status</span><span class="p">(</span><span class="n">vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">DecisionVoteStatus</span>::<span class="n">Tallied</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">start_auto_reveal_service</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">auto_reveal_service</span><span class="p">.</span><span class="n">reveal_worker</span><span class="p">.</span><span class="n">is_some</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">reveal_queue</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">auto_reveal_service</span><span class="p">.</span><span class="n">reveal_queue</span><span class="p">.</span><span class="n">clone</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">worker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tokio</span>::<span class="n">spawn</span><span class="p">(</span><span class="k">async</span><span class="w"> </span><span class="k">move</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">Self</span>::<span class="n">reveal_worker_loop</span><span class="p">(</span><span class="n">reveal_queue</span><span class="p">).</span><span class="k">await</span><span class="p">;</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">auto_reveal_service</span><span class="p">.</span><span class="n">reveal_worker</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">worker</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">reveal_worker_loop</span><span class="p">(</span><span class="k">mut</span><span class="w"> </span><span class="n">reveal_queue</span>: <span class="nc">VecDeque</span><span class="o">&lt;</span><span class="n">RevealTask</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">task</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">reveal_queue</span><span class="p">.</span><span class="n">pop_front</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 处理揭示任务</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">e</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">Self</span>::<span class="n">process_reveal_task</span><span class="p">(</span><span class="n">task</span><span class="p">).</span><span class="k">await</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="fm">eprintln!</span><span class="p">(</span><span class="s">&quot;Error processing reveal task: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">e</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_secs</span><span class="p">(</span><span class="mi">1</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">process_reveal_task</span><span class="p">(</span><span class="n">task</span>: <span class="nc">RevealTask</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现具体的揭示任务处理逻辑</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">task</span><span class="p">.</span><span class="n">trigger</span><span class="p">.</span><span class="n">trigger_type</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">TriggerType</span>::<span class="n">TimeBased</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 基于时间的揭示</span>
<span class="w">                </span><span class="bp">Self</span>::<span class="n">execute_time_based_reveal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">TriggerType</span>::<span class="n">ParticipantCount</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 基于参与者数量的揭示</span>
<span class="w">                </span><span class="bp">Self</span>::<span class="n">execute_participant_based_reveal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">TriggerType</span>::<span class="n">VoteCompletion</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 基于投票完成度的揭示</span>
<span class="w">                </span><span class="bp">Self</span>::<span class="n">execute_completion_based_reveal</span><span class="p">(</span><span class="o">&amp;</span><span class="n">task</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_time_based_reveal</span><span class="p">(</span><span class="n">task</span>: <span class="kp">&amp;</span><span class="nc">RevealTask</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现基于时间的自动揭示</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_participant_based_reveal</span><span class="p">(</span><span class="n">task</span>: <span class="kp">&amp;</span><span class="nc">RevealTask</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现基于参与者数量的自动揭示</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_completion_based_reveal</span><span class="p">(</span><span class="n">task</span>: <span class="kp">&amp;</span><span class="nc">RevealTask</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现基于投票完成度的自动揭示</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 辅助方法</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">generate_vote_id</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">config</span>: <span class="kp">&amp;</span><span class="nc">AutomatedVoteConfig</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">title</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">().</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;auto_vote_{:x}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">get_current_timestamp</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">time</span>::<span class="n">SystemTime</span>::<span class="n">now</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">duration_since</span><span class="p">(</span><span class="n">std</span>::<span class="n">time</span>::<span class="n">UNIX_EPOCH</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">as_secs</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 这些方法需要根据具体的实现来完善</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_vote_status</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">DecisionVoteStatus</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现获取投票状态的逻辑</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">DecisionVoteStatus</span>::<span class="n">Created</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_vote_info</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">VoteInfo</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现获取投票信息的逻辑</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">VoteInfo</span>::<span class="n">default</span><span class="p">())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_pending_commitments</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">PendingCommitment</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现获取待处理承诺的逻辑</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">update_vote_status</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">status</span>: <span class="nc">DecisionVoteStatus</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现更新投票状态的逻辑</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">check_time_condition</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">vote_info</span>: <span class="kp">&amp;</span><span class="nc">VoteInfo</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现时间条件检查逻辑</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">check_participant_condition</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">vote_info</span>: <span class="kp">&amp;</span><span class="nc">VoteInfo</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现参与者条件检查逻辑</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">check_completion_condition</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">vote_info</span>: <span class="kp">&amp;</span><span class="nc">VoteInfo</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现完成度条件检查逻辑</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_automated_commitment</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现自动承诺执行逻辑</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">AutomatedVoteConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">title</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">message</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_strategy</span>: <span class="nc">CommitmentStrategy</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveal_conditions</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevealCondition</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveal_triggers</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevealTrigger</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">VoteInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">status</span>: <span class="nc">DecisionVoteStatus</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">created_at</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">end_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">completion_percentage</span>: <span class="kt">f64</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="nb">Default</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">VoteInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">default</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">vote_id</span>: <span class="nb">String</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">status</span>: <span class="nc">DecisionVoteStatus</span>::<span class="n">Created</span><span class="p">,</span>
<span class="w">            </span><span class="n">created_at</span>: <span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="n">end_time</span>: <span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="n">participant_count</span>: <span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="n">completion_percentage</span>: <span class="mf">0.0</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">RevealTask</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">trigger</span>: <span class="nc">RevealTrigger</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">created_at</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">status</span>: <span class="nc">TaskStatus</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, PartialEq)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">TaskStatus</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Pending</span><span class="p">,</span>
<span class="w">    </span><span class="n">Processing</span><span class="p">,</span>
<span class="w">    </span><span class="n">Completed</span><span class="p">,</span>
<span class="w">    </span><span class="n">Failed</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">AutoRevealService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">reveal_triggers</span>: <span class="nb">Vec</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">reveal_queue</span>: <span class="nc">VecDeque</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">reveal_worker</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="212">2.1.2 决策投票数据结构</h4>
<div class="codehilite"><pre><span></span><code><span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">DecisionVote</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">title</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">min_preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">max_preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">creator</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">status</span>: <span class="nc">DecisionVoteStatus</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">created_at</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">start_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">end_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">max_votes</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">min_votes</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_hash</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">result_hash</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_contract_address</span>: <span class="nb">String</span><span class="p">,</span><span class="w">        </span><span class="c1">// NFT合约地址</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span><span class="w">                    </span><span class="c1">// NFT类型标识</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_metadata_uri</span>: <span class="nb">String</span><span class="p">,</span><span class="w">            </span><span class="c1">// NFT元数据URI</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTTypeDefinition</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span><span class="w">                    </span><span class="c1">// NFT类型标识</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_standard</span>: <span class="nb">String</span><span class="p">,</span><span class="w">                </span><span class="c1">// NFT标准（如CW721）</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">application_category</span>: <span class="nb">String</span><span class="p">,</span><span class="w">         </span><span class="c1">// 应用场景分类</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">metadata_schema</span>: <span class="nc">MetadataSchema</span><span class="p">,</span><span class="w">     </span><span class="c1">// 元数据模式</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">voting_rules</span>: <span class="nc">VotingRules</span><span class="p">,</span><span class="w">           </span><span class="c1">// 投票规则</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">lifecycle_hooks</span>: <span class="nc">LifecycleHooks</span><span class="p">,</span><span class="w">     </span><span class="c1">// 生命周期钩子</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MetadataSchema</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">required_fields</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w">         </span><span class="c1">// 必需字段</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">optional_fields</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w">         </span><span class="c1">// 可选字段</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">validation_rules</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">ValidationRule</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 验证规则</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">VotingRules</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">min_participants</span>: <span class="kt">u32</span><span class="p">,</span><span class="w">               </span><span class="c1">// 最小参与者数量</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">max_participants</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">,</span><span class="w">       </span><span class="c1">// 最大参与者数量</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">voting_duration</span>: <span class="nc">Duration</span><span class="p">,</span><span class="w">           </span><span class="c1">// 投票持续时间</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveal_delay</span>: <span class="nc">Duration</span><span class="p">,</span><span class="w">              </span><span class="c1">// 揭示延迟</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">result_calculation</span>: <span class="nc">ResultCalculation</span><span class="p">,</span><span class="w"> </span><span class="c1">// 结果计算方式</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LifecycleHooks</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">on_vote_created</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w">     </span><span class="c1">// 投票创建时钩子</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">on_vote_started</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w">     </span><span class="c1">// 投票开始时钩子</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">on_vote_completed</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w">   </span><span class="c1">// 投票完成时钩子</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">on_result_calculated</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 结果计算时钩子</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LotteryConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">is_lottery</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">lottery_tiers</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">LotteryTierConfig</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winning_number_generator</span>: <span class="nc">WinningNumberGenerator</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LotteryTicketConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">ticket_type</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="c1">// 彩票类型</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">price</span>: <span class="kt">u64</span><span class="p">,</span><span class="w">          </span><span class="c1">// 彩票价格</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">max_tickets</span>: <span class="kt">u32</span><span class="p">,</span><span class="w">    </span><span class="c1">// 最大彩票数量</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">prize_pool</span>: <span class="kt">u64</span><span class="p">,</span><span class="w">     </span><span class="c1">// 奖金池</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">draw_rules</span>: <span class="nc">DrawRules</span><span class="p">,</span><span class="w"> </span><span class="c1">// 开奖规则</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ResourceAllocationConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">resource_type</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="c1">// 资源类型</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">total_amount</span>: <span class="kt">u64</span><span class="p">,</span><span class="w">     </span><span class="c1">// 总资源数量</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">allocation_algorithm</span>: <span class="nc">AllocationAlgorithm</span><span class="p">,</span><span class="w"> </span><span class="c1">// 分配算法</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">constraints</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Constraint</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 约束条件</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">GovernanceConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">proposal_type</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="c1">// 提案类型</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">voting_rules</span>: <span class="nc">VotingRules</span><span class="p">,</span><span class="w"> </span><span class="c1">// 投票规则</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">decision_threshold</span>: <span class="kt">f64</span><span class="p">,</span><span class="w"> </span><span class="c1">// 决策阈值</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">execution_delay</span>: <span class="kt">u64</span><span class="p">,</span><span class="w">   </span><span class="c1">// 执行延迟</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">CustomConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">config_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">parameters</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LotteryResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">total_participants</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">random_sum</span>: <span class="kt">i64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winner_index</span>: <span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="c1">// 抽奖结果（余数对应的参与者索引）</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">calculation_proof</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="c1">// 计算过程证明</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">PreferenceVoteSubmission</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">decision_maker_address</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">timestamp</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">signature</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="22_1">2.2 区块链交互接口</h3>
<h4 id="221">2.2.1 智能合约接口</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">BlockchainInterface</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">submit_preference_commitment</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">commitment</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">reveal_preference_vote</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">preference</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">randomness</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_decision_vote_status</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">DecisionVoteStatus</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_preference_commitments</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">calculate_decision_result</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">calculate_lottery_result</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">LotteryResult</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<p>pub struct InjectiveInterface {
    client: InjectiveClient,
    contract_address: String,
}</p>
<p>impl BlockchainInterface for InjectiveInterface {
    async fn submit_preference_commitment(&amp;self, decision_vote_id: &amp;str, commitment: &amp;[u8; 32]) -&gt; Result<String, Error> {
        let message = SubmitPreferenceCommitmentMsg {
            decision_vote_id: decision_vote_id.to_string(),
            commitment: commitment.to_vec(),
        };</p>
<div class="codehilite"><pre><span></span><code><span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">response</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">client</span>
<span class="w">        </span><span class="p">.</span><span class="nx">execute_contract</span><span class="p">(</span><span class="o">&amp;</span><span class="kp">self</span><span class="p">.</span><span class="nx">contract_address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">message</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="nx">await</span><span class="p">?;</span>

<span class="w">    </span><span class="nx">Ok</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">tx_hash</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">async</span><span class="w"> </span><span class="kd">fn</span><span class="w"> </span><span class="nx">calculate_decision_result</span><span class="p">(</span><span class="o">&amp;</span><span class="kp">self</span><span class="p">,</span><span class="w"> </span><span class="nx">decision_vote_id</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">Result</span><span class="p">&lt;</span><span class="kt">i64</span><span class="p">,</span><span class="w"> </span><span class="nx">Error</span><span class="p">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">client</span>
<span class="w">        </span><span class="p">.</span><span class="nx">query_contract</span><span class="p">(</span><span class="o">&amp;</span><span class="kp">self</span><span class="p">.</span><span class="nx">contract_address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">format</span><span class="p">!(</span><span class="s">&quot;calculateDecisionResult:{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">decision_vote_id</span><span class="p">))</span>
<span class="w">        </span><span class="p">.</span><span class="nx">await</span><span class="p">?;</span>

<span class="w">    </span><span class="nx">Ok</span><span class="p">(</span><span class="nx">result</span><span class="p">.</span><span class="nx">preference_sum</span><span class="p">)</span>
<span class="p">}</span>

<span class="nx">async</span><span class="w"> </span><span class="kd">fn</span><span class="w"> </span><span class="nx">calculate_lottery_result</span><span class="p">(</span><span class="o">&amp;</span><span class="kp">self</span><span class="p">,</span><span class="w"> </span><span class="nx">decision_vote_id</span><span class="p">:</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="nx">Result</span><span class="p">&lt;</span><span class="nx">LotteryResult</span><span class="p">,</span><span class="w"> </span><span class="nx">Error</span><span class="p">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="nx">result</span><span class="w"> </span><span class="p">=</span><span class="w"> </span><span class="kp">self</span><span class="p">.</span><span class="nx">client</span>
<span class="w">        </span><span class="p">.</span><span class="nx">query_contract</span><span class="p">(</span><span class="o">&amp;</span><span class="kp">self</span><span class="p">.</span><span class="nx">contract_address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="nx">format</span><span class="p">!(</span><span class="s">&quot;calculateLotteryResult:{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">decision_vote_id</span><span class="p">))</span>
<span class="w">        </span><span class="p">.</span><span class="nx">await</span><span class="p">?;</span>

<span class="w">    </span><span class="nx">Ok</span><span class="p">(</span><span class="nx">LotteryResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nx">decision_vote_id</span><span class="p">:</span><span class="w"> </span><span class="nx">decision_vote_id</span><span class="p">.</span><span class="nx">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="nx">total_participants</span><span class="p">:</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">total_participants</span><span class="p">,</span>
<span class="w">        </span><span class="nx">random_sum</span><span class="p">:</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">random_sum</span><span class="p">,</span>
<span class="w">        </span><span class="nx">winner_index</span><span class="p">:</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">winner_index</span><span class="p">,</span>
<span class="w">        </span><span class="nx">calculation_proof</span><span class="p">:</span><span class="w"> </span><span class="nx">result</span><span class="p">.</span><span class="nx">calculation_proof</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>

<span class="c1">// 其他方法实现...</span>
</code></pre></div>

<p>}</p>
<div class="codehilite"><pre><span></span><code><span class="err">###</span><span class="w"> </span><span class="mf">2.3</span><span class="w"> </span><span class="n">存储适配器抽象层</span>

<span class="err">####</span><span class="w"> </span><span class="mf">2.3.1</span><span class="w"> </span><span class="n">IPFS适配器实现</span>
<span class="err">```</span><span class="n">rust</span>
<span class="n">pub</span><span class="w"> </span><span class="n">struct</span><span class="w"> </span><span class="n">IPFSAdapter</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="nl">client</span><span class="p">:</span><span class="w"> </span><span class="nl">reqwest</span><span class="p">:</span><span class="err">:</span><span class="n">Client</span><span class="p">,</span>
<span class="w">    </span><span class="nl">gateway_url</span><span class="p">:</span><span class="w"> </span><span class="n">String</span><span class="p">,</span>
<span class="w">    </span><span class="nl">timeout</span><span class="p">:</span><span class="w"> </span><span class="n">Duration</span><span class="p">,</span>
<span class="err">}</span>

<span class="n">impl</span><span class="w"> </span><span class="n">StorageAdapter</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">IPFSAdapter</span><span class="w"> </span><span class="err">{</span>
<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="n">fn</span><span class="w"> </span><span class="n">store</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">key</span><span class="err">:</span><span class="w"> </span><span class="o">&amp;</span><span class="nf">str</span><span class="p">,</span><span class="w"> </span><span class="k">value</span><span class="err">:</span><span class="w"> </span><span class="o">&amp;[</span><span class="n">u8</span><span class="o">]</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">Result</span><span class="o">&lt;</span><span class="n">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">let</span><span class="w"> </span><span class="n">form</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nl">reqwest</span><span class="p">:</span><span class="err">:</span><span class="nl">multipart</span><span class="p">:</span><span class="err">:</span><span class="nl">Form</span><span class="p">:</span><span class="err">:</span><span class="k">new</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">part</span><span class="p">(</span><span class="ss">&quot;file&quot;</span><span class="p">,</span><span class="w"> </span><span class="nl">reqwest</span><span class="p">:</span><span class="err">:</span><span class="nl">multipart</span><span class="p">:</span><span class="err">:</span><span class="nl">Part</span><span class="p">:</span><span class="err">:</span><span class="n">bytes</span><span class="p">(</span><span class="k">value</span><span class="p">.</span><span class="n">to_vec</span><span class="p">()));</span>

<span class="w">        </span><span class="n">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">client</span>
<span class="w">            </span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="o">&amp;</span><span class="nf">format</span><span class="err">!</span><span class="p">(</span><span class="ss">&quot;{}/api/v0/add&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">gateway_url</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="n">multipart</span><span class="p">(</span><span class="n">form</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">timeout</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">send</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">await</span><span class="vm">?</span><span class="p">;</span>

<span class="w">        </span><span class="n">let</span><span class="w"> </span><span class="k">result</span><span class="err">:</span><span class="w"> </span><span class="n">IPFSResponse</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">response</span><span class="p">.</span><span class="n">json</span><span class="p">().</span><span class="n">await</span><span class="vm">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">Ok</span><span class="p">(</span><span class="k">result</span><span class="p">.</span><span class="n">hash</span><span class="p">)</span>
<span class="w">    </span><span class="err">}</span>

<span class="w">    </span><span class="n">async</span><span class="w"> </span><span class="n">fn</span><span class="w"> </span><span class="n">retrieve</span><span class="p">(</span><span class="o">&amp;</span><span class="n">self</span><span class="p">,</span><span class="w"> </span><span class="k">key</span><span class="err">:</span><span class="w"> </span><span class="o">&amp;</span><span class="nf">str</span><span class="p">)</span><span class="w"> </span><span class="o">-&gt;</span><span class="w"> </span><span class="k">Result</span><span class="o">&lt;</span><span class="n">Vec</span><span class="o">&lt;</span><span class="n">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="err">{</span>
<span class="w">        </span><span class="n">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">client</span>
<span class="w">            </span><span class="p">.</span><span class="k">get</span><span class="p">(</span><span class="o">&amp;</span><span class="nf">format</span><span class="err">!</span><span class="p">(</span><span class="ss">&quot;{}/ipfs/{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">self</span><span class="p">.</span><span class="n">gateway_url</span><span class="p">,</span><span class="w"> </span><span class="k">key</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="n">timeout</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">timeout</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">send</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">await</span><span class="vm">?</span><span class="p">;</span>

<span class="w">        </span><span class="n">Ok</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">bytes</span><span class="p">().</span><span class="n">await</span><span class="vm">?</span><span class="p">.</span><span class="n">to_vec</span><span class="p">())</span>
<span class="w">    </span><span class="err">}</span>
<span class="err">}</span>
</code></pre></div>

<h2 id="3">3. 区块链智能合约详细设计</h2>
<h3 id="31-cosmwasm">3.1 CosmWasm智能合约</h3>
<h4 id="311">3.1.1 合约状态变量</h4>
<div class="codehilite"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">cosmwasm_std</span>::<span class="p">{</span>
<span class="w">    </span><span class="n">entry_point</span><span class="p">,</span><span class="w"> </span><span class="n">to_binary</span><span class="p">,</span><span class="w"> </span><span class="n">Binary</span><span class="p">,</span><span class="w"> </span><span class="n">Deps</span><span class="p">,</span><span class="w"> </span><span class="n">DepsMut</span><span class="p">,</span><span class="w"> </span><span class="n">Env</span><span class="p">,</span><span class="w"> </span><span class="n">MessageInfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">StdResult</span><span class="p">,</span><span class="w"> </span><span class="n">Uint128</span><span class="p">,</span><span class="w"> </span><span class="n">Addr</span><span class="p">,</span><span class="w"> </span><span class="n">Storage</span><span class="p">,</span><span class="w"> </span><span class="n">StdError</span><span class="p">,</span>
<span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">schemars</span>::<span class="n">JsonSchema</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">serde</span>::<span class="p">{</span><span class="n">Deserialize</span><span class="p">,</span><span class="w"> </span><span class="n">Serialize</span><span class="p">};</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">DecisionVote</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">title</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">min_preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">max_preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">start_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">end_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">max_votes</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">min_votes</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">is_active</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">result_hash</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">creator</span>: <span class="nc">Addr</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">is_lottery</span>: <span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="c1">// 标识是否为抽奖活动</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">PreferenceVoteCommitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">timestamp</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">decision_maker</span>: <span class="nc">Addr</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">is_revealed</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">AutomationConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">agent_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">auto_commit_enabled</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">auto_reveal_enabled</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_strategy</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="c1">// &quot;immediate&quot;, &quot;scheduled&quot;, &quot;conditional&quot;, &quot;batch&quot;</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">auto_commit_interval</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">auto_reveal_delay</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveal_conditions</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevealCondition</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">batch_size</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">smart_timing</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">RevealCondition</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">condition_type</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="c1">// &quot;time&quot;, &quot;participant_count&quot;, &quot;completion&quot;, &quot;manual&quot;</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">threshold</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">time_trigger</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_min</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">completion_percentage</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">f64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">RevealData</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">randomness</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">timestamp</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">AutomationState</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">is_automated</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">config</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">AutomationConfig</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">last_automation_run</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">automation_status</span>: <span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="c1">// &quot;active&quot;, &quot;paused&quot;, &quot;completed&quot;, &quot;error&quot;</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">batch_queue</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveal_queue</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevealData</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">State</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">decision_votes</span>: <span class="nc">std</span>::<span class="n">collections</span>::<span class="n">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">DecisionVote</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitments</span>: <span class="nc">std</span>::<span class="n">collections</span>::<span class="n">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">std</span>::<span class="n">collections</span>::<span class="n">HashMap</span><span class="o">&lt;</span><span class="n">Addr</span><span class="p">,</span><span class="w"> </span><span class="n">PreferenceVoteCommitment</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">preference_vote_counts</span>: <span class="nc">std</span>::<span class="n">collections</span>::<span class="n">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">preference_sums</span>: <span class="nc">std</span>::<span class="n">collections</span>::<span class="n">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="kt">i64</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 偏好值汇总</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">lottery_results</span>: <span class="nc">std</span>::<span class="n">collections</span>::<span class="n">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 抽奖结果</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">automation_states</span>: <span class="nc">std</span>::<span class="n">collections</span>::<span class="n">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">AutomationState</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// iAgent自动化状态</span>
<span class="p">}</span>

<span class="c1">// CosmWasm 事件通过 Response 的 attributes 实现</span>
<span class="c1">// 事件示例：</span>
<span class="c1">// - DecisionVoteCreated</span>
<span class="c1">// - PreferenceVoteCommitted  </span>
<span class="c1">// - PreferenceVoteRevealed</span>
<span class="c1">// - DecisionResult</span>
<span class="c1">// - LotteryResult</span>
</code></pre></div>

<h4 id="312">3.1.2 核心函数实现</h4>
<div class="codehilite"><pre><span></span><code><span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">ExecuteMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">CreateDecisionVote</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">title</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">min_preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">        </span><span class="n">max_preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">        </span><span class="n">start_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">        </span><span class="n">end_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">        </span><span class="n">max_votes</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">min_votes</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">is_lottery</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">SubmitPreferenceCommitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">commitment</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">RevealPreferenceVote</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">        </span><span class="n">randomness</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">SetupAutomatedVoting</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">automation_config</span>: <span class="nc">AutomationConfig</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">ExecuteAutomatedCommitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">commitment_batch</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">ExecuteAutomatedReveal</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">reveal_batch</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevealData</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">UpdateAutomationConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">automation_config</span>: <span class="nc">AutomationConfig</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">QueryMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">GetDecisionVote</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">GetPreferenceCommitments</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">CalculateDecisionResult</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">CalculateLotteryResult</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">GetAutomationConfig</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">GetAutomationStatus</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">GetAutomationQueue</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="p">}</span>

<span class="cp">#[entry_point]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute</span><span class="p">(</span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span>
<span class="w">    </span><span class="n">env</span>: <span class="nc">Env</span><span class="p">,</span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">msg</span>: <span class="nc">ExecuteMsg</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">StdError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">CreateDecisionVote</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">min_preference</span><span class="p">,</span><span class="w"> </span><span class="n">max_preference</span><span class="p">,</span><span class="w"> </span><span class="n">start_time</span><span class="p">,</span><span class="w"> </span><span class="n">end_time</span><span class="p">,</span><span class="w"> </span><span class="n">max_votes</span><span class="p">,</span><span class="w"> </span><span class="n">min_votes</span><span class="p">,</span><span class="w"> </span><span class="n">is_lottery</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">execute_create_decision_vote</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="n">min_preference</span><span class="p">,</span><span class="w"> </span><span class="n">max_preference</span><span class="p">,</span><span class="w"> </span><span class="n">start_time</span><span class="p">,</span><span class="w"> </span><span class="n">end_time</span><span class="p">,</span><span class="w"> </span><span class="n">max_votes</span><span class="p">,</span><span class="w"> </span><span class="n">min_votes</span><span class="p">,</span><span class="w"> </span><span class="n">is_lottery</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">SubmitPreferenceCommitment</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">commitment</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">execute_submit_preference_commitment</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">commitment</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">RevealPreferenceVote</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">preference</span><span class="p">,</span><span class="w"> </span><span class="n">randomness</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">execute_reveal_preference_vote</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">preference</span><span class="p">,</span><span class="w"> </span><span class="n">randomness</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">SetupAutomatedVoting</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">automation_config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">execute_setup_automated_voting</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">automation_config</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">ExecuteAutomatedCommitment</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">commitment_batch</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">execute_automated_commitment</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">commitment_batch</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">ExecuteAutomatedReveal</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">reveal_batch</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">execute_automated_reveal</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">reveal_batch</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">ExecuteMsg</span>::<span class="n">UpdateAutomationConfig</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">automation_config</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">execute_update_automation_config</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">automation_config</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[entry_point]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">query</span><span class="p">(</span><span class="n">deps</span>: <span class="nc">Deps</span><span class="p">,</span><span class="w"> </span><span class="n">_env</span>: <span class="nc">Env</span><span class="p">,</span><span class="w"> </span><span class="n">msg</span>: <span class="nc">QueryMsg</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="n">Binary</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">match</span><span class="w"> </span><span class="n">msg</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">GetDecisionVote</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_decision_vote</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">GetPreferenceCommitments</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_preference_commitments</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">CalculateDecisionResult</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_calculate_decision_result</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">CalculateLotteryResult</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_calculate_lottery_result</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">GetAutomationConfig</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_automation_config</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">GetAutomationStatus</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_automation_status</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">QueryMsg</span>::<span class="n">GetAutomationQueue</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">to_binary</span><span class="p">(</span><span class="o">&amp;</span><span class="n">query_automation_queue</span><span class="p">(</span><span class="n">deps</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_create_decision_vote</span><span class="p">(</span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span>
<span class="w">    </span><span class="n">env</span>: <span class="nc">Env</span><span class="p">,</span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">title</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">min_preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="n">max_preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="n">start_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="n">end_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="n">max_votes</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">min_votes</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">is_lottery</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">StdError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 验证输入参数</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">min_preference</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">max_preference</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Invalid preference range&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">start_time</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">block</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">seconds</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Start time must be in future&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">end_time</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">start_time</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;End time must be after start time&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 生成决策投票ID</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">generate_decision_vote_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">title</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">description</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">env</span><span class="p">.</span><span class="n">block</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">seconds</span><span class="p">(),</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">);</span>

<span class="w">    </span><span class="c1">// 创建决策投票</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">decision_vote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DecisionVote</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">title</span><span class="p">,</span>
<span class="w">        </span><span class="n">description</span><span class="p">,</span>
<span class="w">        </span><span class="n">min_preference</span><span class="p">,</span>
<span class="w">        </span><span class="n">max_preference</span><span class="p">,</span>
<span class="w">        </span><span class="n">start_time</span><span class="p">,</span>
<span class="w">        </span><span class="n">end_time</span><span class="p">,</span>
<span class="w">        </span><span class="n">max_votes</span><span class="p">,</span>
<span class="w">        </span><span class="n">min_votes</span><span class="p">,</span>
<span class="w">        </span><span class="n">is_active</span>: <span class="nc">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">result_hash</span>: <span class="nb">String</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">        </span><span class="n">creator</span>: <span class="nc">info</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">        </span><span class="n">is_lottery</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// 保存到存储</span>
<span class="w">    </span><span class="n">save_decision_vote</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;create_decision_vote&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;decision_vote_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;creator&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">to_string</span><span class="p">()))</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_submit_preference_commitment</span><span class="p">(</span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span>
<span class="w">    </span><span class="n">env</span>: <span class="nc">Env</span><span class="p">,</span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">commitment</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">StdError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 获取决策投票</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">decision_vote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_decision_vote</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 验证投票状态</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">decision_vote</span><span class="p">.</span><span class="n">is_active</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Decision vote not active&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">block</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">seconds</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">decision_vote</span><span class="p">.</span><span class="n">start_time</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Voting not started&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">block</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">seconds</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">decision_vote</span><span class="p">.</span><span class="n">end_time</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Voting ended&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 检查是否已经投票</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">has_voted</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Already voted&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 创建承诺</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PreferenceVoteCommitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">commitment</span><span class="p">,</span>
<span class="w">        </span><span class="n">timestamp</span>: <span class="nc">env</span><span class="p">.</span><span class="n">block</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">seconds</span><span class="p">(),</span>
<span class="w">        </span><span class="n">decision_maker</span>: <span class="nc">info</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">        </span><span class="n">is_revealed</span>: <span class="nc">false</span><span class="p">,</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// 保存承诺</span>
<span class="w">    </span><span class="n">save_commitment</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">commitment_data</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 更新投票计数</span>
<span class="w">    </span><span class="n">increment_vote_count</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;submit_preference_commitment&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;decision_vote_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;decision_maker&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;commitment&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">commitment</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_reveal_preference_vote</span><span class="p">(</span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span>
<span class="w">    </span><span class="n">env</span>: <span class="nc">Env</span><span class="p">,</span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="n">randomness</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">StdError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 获取决策投票</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">decision_vote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_decision_vote</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 验证投票状态</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">decision_vote</span><span class="p">.</span><span class="n">is_active</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Decision vote not active&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">block</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">seconds</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">decision_vote</span><span class="p">.</span><span class="n">end_time</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Voting not ended&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 获取承诺</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_commitment</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 验证承诺</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">commitment</span><span class="p">.</span><span class="n">is_revealed</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Already revealed&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">preference</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">decision_vote</span><span class="p">.</span><span class="n">min_preference</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">preference</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">decision_vote</span><span class="p">.</span><span class="n">max_preference</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Preference out of range&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 验证承诺的正确性</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">computed_commitment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compute_commitment</span><span class="p">(</span><span class="n">preference</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">randomness</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">computed_commitment</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">commitment</span><span class="p">.</span><span class="n">commitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Invalid commitment&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 更新承诺状态</span>
<span class="w">    </span><span class="n">mark_commitment_revealed</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 更新偏好值汇总</span>
<span class="w">    </span><span class="n">add_preference_sum</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">preference</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;reveal_preference_vote&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;decision_vote_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;decision_maker&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;preference&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">preference</span><span class="p">.</span><span class="n">to_string</span><span class="p">()))</span>
<span class="p">}</span>

<span class="c1">// iAgent自动化投票执行函数</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_setup_automated_voting</span><span class="p">(</span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span>
<span class="w">    </span><span class="n">env</span>: <span class="nc">Env</span><span class="p">,</span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">automation_config</span>: <span class="nc">AutomationConfig</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">StdError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 验证决策投票存在</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">decision_vote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_decision_vote</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 验证调用者权限（只有创建者或管理员可以设置自动化）</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">decision_vote</span><span class="p">.</span><span class="n">creator</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Only creator can setup automation&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 创建自动化状态</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">automation_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AutomationState</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">is_automated</span>: <span class="nc">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">config</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">automation_config</span><span class="p">.</span><span class="n">clone</span><span class="p">()),</span>
<span class="w">        </span><span class="n">last_automation_run</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">block</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">seconds</span><span class="p">()),</span>
<span class="w">        </span><span class="n">automation_status</span>: <span class="s">&quot;active&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">batch_queue</span>: <span class="nb">Vec</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">        </span><span class="n">reveal_queue</span>: <span class="nb">Vec</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="c1">// 保存自动化状态</span>
<span class="w">    </span><span class="n">save_automation_state</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">automation_state</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;setup_automated_voting&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;decision_vote_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;agent_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">automation_config</span><span class="p">.</span><span class="n">agent_id</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;automation_enabled&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;true&quot;</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_automated_commitment</span><span class="p">(</span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span>
<span class="w">    </span><span class="n">env</span>: <span class="nc">Env</span><span class="p">,</span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">commitment_batch</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">StdError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 验证自动化状态</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">automation_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_automation_state</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">automation_state</span><span class="p">.</span><span class="n">is_automated</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Automation not enabled&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 验证调用者权限（只有授权的iAgent可以执行）</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">automation_state</span><span class="p">.</span><span class="n">config</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">agent_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">to_string</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Unauthorized agent&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 批量处理承诺</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">commitment</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">commitment_batch</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 这里应该实现具体的承诺处理逻辑</span>
<span class="w">        </span><span class="c1">// 例如：验证承诺格式、存储承诺等</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 更新自动化状态</span>
<span class="w">    </span><span class="n">update_automation_last_run</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">block</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">seconds</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;execute_automated_commitment&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;decision_vote_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;batch_size&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">commitment_batch</span><span class="p">.</span><span class="n">len</span><span class="p">().</span><span class="n">to_string</span><span class="p">()))</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_automated_reveal</span><span class="p">(</span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span>
<span class="w">    </span><span class="n">env</span>: <span class="nc">Env</span><span class="p">,</span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">reveal_batch</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevealData</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">StdError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 验证自动化状态</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">automation_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_automation_state</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">automation_state</span><span class="p">.</span><span class="n">is_automated</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Automation not enabled&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 验证调用者权限</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">automation_state</span><span class="p">.</span><span class="n">config</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">agent_id</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="p">.</span><span class="n">to_string</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Unauthorized agent&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 批量处理揭示</span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="n">reveal_data</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">reveal_batch</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 验证揭示数据的正确性</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_commitment_by_id</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">reveal_data</span><span class="p">.</span><span class="n">commitment_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 验证承诺的正确性</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">computed_commitment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">compute_commitment</span><span class="p">(</span><span class="n">reveal_data</span><span class="p">.</span><span class="n">preference</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">reveal_data</span><span class="p">.</span><span class="n">randomness</span><span class="p">);</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">computed_commitment</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">commitment</span><span class="p">.</span><span class="n">commitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Invalid commitment in reveal batch&quot;</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 更新承诺状态</span>
<span class="w">        </span><span class="n">mark_commitment_revealed</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">commitment</span><span class="p">.</span><span class="n">decision_maker</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 更新偏好值汇总</span>
<span class="w">        </span><span class="n">add_preference_sum</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">reveal_data</span><span class="p">.</span><span class="n">preference</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 更新自动化状态</span>
<span class="w">    </span><span class="n">update_automation_last_run</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">env</span><span class="p">.</span><span class="n">block</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">seconds</span><span class="p">())</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;execute_automated_reveal&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;decision_vote_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;batch_size&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">reveal_batch</span><span class="p">.</span><span class="n">len</span><span class="p">().</span><span class="n">to_string</span><span class="p">()))</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_update_automation_config</span><span class="p">(</span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span>
<span class="w">    </span><span class="n">env</span>: <span class="nc">Env</span><span class="p">,</span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">automation_config</span>: <span class="nc">AutomationConfig</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">StdError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 验证决策投票存在</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">decision_vote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_decision_vote</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 验证调用者权限</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">decision_vote</span><span class="p">.</span><span class="n">creator</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">info</span><span class="p">.</span><span class="n">sender</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Only creator can update automation config&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="c1">// 更新自动化配置</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">automation_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_automation_state</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="n">automation_state</span><span class="p">.</span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">automation_config</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
<span class="w">    </span><span class="n">automation_state</span><span class="p">.</span><span class="n">last_automation_run</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">block</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">seconds</span><span class="p">());</span>

<span class="w">    </span><span class="c1">// 保存更新后的自动化状态</span>
<span class="w">    </span><span class="n">save_automation_state</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">automation_state</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;update_automation_config&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;decision_vote_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;agent_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">automation_config</span><span class="p">.</span><span class="n">agent_id</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">query_calculate_decision_result</span><span class="p">(</span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">Deps</span><span class="p">,</span>
<span class="w">    </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">decision_vote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_decision_vote</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">decision_vote</span><span class="p">.</span><span class="n">is_active</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Decision vote not active&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="n">get_preference_sum</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">query_calculate_lottery_result</span><span class="p">(</span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">Deps</span><span class="p">,</span>
<span class="w">    </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">decision_vote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_decision_vote</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">decision_vote</span><span class="p">.</span><span class="n">is_active</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Decision vote not active&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">decision_vote</span><span class="p">.</span><span class="n">is_lottery</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Not a lottery&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">vote_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_vote_count</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="n">vote_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;No participants&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">preference_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_preference_sum</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">winner_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">preference_sum</span><span class="p">.</span><span class="n">unsigned_abs</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">vote_count</span><span class="p">;</span>

<span class="w">    </span><span class="c1">// 保存抽奖结果</span>
<span class="w">    </span><span class="n">save_lottery_result</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">winner_index</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">winner_index</span><span class="p">)</span>
<span class="p">}</span>

<span class="c1">// iAgent自动化查询函数</span>
<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">query_automation_config</span><span class="p">(</span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">Deps</span><span class="p">,</span>
<span class="w">    </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="n">AutomationConfig</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">automation_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_automation_state</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">automation_state</span><span class="p">.</span><span class="n">config</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">config</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Automation not configured&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">query_automation_status</span><span class="p">(</span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">Deps</span><span class="p">,</span>
<span class="w">    </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="n">AutomationStatusResponse</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">automation_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_automation_state</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">AutomationStatusResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">is_automated</span>: <span class="nc">automation_state</span><span class="p">.</span><span class="n">is_automated</span><span class="p">,</span>
<span class="w">        </span><span class="n">automation_status</span>: <span class="nc">automation_state</span><span class="p">.</span><span class="n">automation_status</span><span class="p">,</span>
<span class="w">        </span><span class="n">last_automation_run</span>: <span class="nc">automation_state</span><span class="p">.</span><span class="n">last_automation_run</span><span class="p">,</span>
<span class="w">        </span><span class="n">batch_queue_size</span>: <span class="nc">automation_state</span><span class="p">.</span><span class="n">batch_queue</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span>
<span class="w">        </span><span class="n">reveal_queue_size</span>: <span class="nc">automation_state</span><span class="p">.</span><span class="n">reveal_queue</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">query_automation_queue</span><span class="p">(</span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">Deps</span><span class="p">,</span>
<span class="w">    </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="n">AutomationQueueResponse</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">automation_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_automation_state</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">AutomationQueueResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">batch_queue</span>: <span class="nc">automation_state</span><span class="p">.</span><span class="n">batch_queue</span><span class="p">,</span>
<span class="w">        </span><span class="n">reveal_queue</span>: <span class="nc">automation_state</span><span class="p">.</span><span class="n">reveal_queue</span><span class="p">,</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">AutomationStatusResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">is_automated</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">automation_status</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">last_automation_run</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">batch_queue_size</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveal_queue_size</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">AutomationQueueResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">batch_queue</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveal_queue</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevealData</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1">// 辅助函数</span>
<span class="k">fn</span> <span class="nf">generate_decision_vote_id</span><span class="p">(</span><span class="n">title</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">description</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">timestamp</span>: <span class="kp">&amp;</span><span class="kt">u64</span><span class="p">,</span><span class="w"> </span><span class="n">sender</span>: <span class="kp">&amp;</span><span class="nc">Addr</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">sha2</span>::<span class="p">{</span><span class="n">Sha256</span><span class="p">,</span><span class="w"> </span><span class="n">Digest</span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">title</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">    </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">description</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">    </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">timestamp</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">    </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">sender</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">    </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{:x}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">())</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">compute_commitment</span><span class="p">(</span><span class="n">preference</span>: <span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="n">randomness</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="n">sha2</span>::<span class="p">{</span><span class="n">Sha256</span><span class="p">,</span><span class="w"> </span><span class="n">Digest</span><span class="p">};</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">    </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">preference</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">    </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">randomness</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">    </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{:x}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">())</span>
<span class="p">}</span>

<span class="c1">// 存储函数（需要实现具体的存储逻辑）</span>
<span class="k">fn</span> <span class="nf">save_decision_vote</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">,</span><span class="w"> </span><span class="n">id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">vote</span>: <span class="kp">&amp;</span><span class="nc">DecisionVote</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 实现存储逻辑</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">get_decision_vote</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">,</span><span class="w"> </span><span class="n">id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="n">DecisionVote</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 实现获取逻辑</span>
<span class="w">    </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Not implemented&quot;</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">save_commitment</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">sender</span>: <span class="kp">&amp;</span><span class="nc">Addr</span><span class="p">,</span><span class="w"> </span><span class="n">commitment</span>: <span class="kp">&amp;</span><span class="nc">PreferenceVoteCommitment</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 实现存储逻辑</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">get_commitment</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">sender</span>: <span class="kp">&amp;</span><span class="nc">Addr</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="n">PreferenceVoteCommitment</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 实现获取逻辑</span>
<span class="w">    </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Not implemented&quot;</span><span class="p">))</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">has_voted</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">sender</span>: <span class="kp">&amp;</span><span class="nc">Addr</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 实现检查逻辑</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">increment_vote_count</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 实现计数逻辑</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">mark_commitment_revealed</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">sender</span>: <span class="kp">&amp;</span><span class="nc">Addr</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 实现标记逻辑</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">add_preference_sum</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">preference</span>: <span class="kt">i32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 实现汇总逻辑</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">get_preference_sum</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 实现获取逻辑</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">get_vote_count</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 实现获取逻辑</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">save_lottery_result</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">result</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 实现保存逻辑</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="c1">// iAgent自动化存储函数</span>
<span class="k">fn</span> <span class="nf">save_automation_state</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">state</span>: <span class="kp">&amp;</span><span class="nc">AutomationState</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 实现自动化状态保存逻辑</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">get_automation_state</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="n">AutomationState</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 实现自动化状态获取逻辑</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">AutomationState</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">is_automated</span>: <span class="nc">false</span><span class="p">,</span>
<span class="w">        </span><span class="n">config</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">        </span><span class="n">last_automation_run</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">        </span><span class="n">automation_status</span>: <span class="s">&quot;inactive&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">batch_queue</span>: <span class="nb">Vec</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">        </span><span class="n">reveal_queue</span>: <span class="nb">Vec</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">    </span><span class="p">})</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">update_automation_last_run</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="k">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">timestamp</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="p">()</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 实现更新自动化最后运行时间的逻辑</span>
<span class="w">    </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="p">}</span>

<span class="k">fn</span> <span class="nf">get_commitment_by_id</span><span class="p">(</span><span class="n">storage</span>: <span class="kp">&amp;</span><span class="nc">dyn</span><span class="w"> </span><span class="n">Storage</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">commitment_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">StdResult</span><span class="o">&lt;</span><span class="n">PreferenceVoteCommitment</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 实现根据承诺ID获取承诺的逻辑</span>
<span class="w">    </span><span class="nb">Err</span><span class="p">(</span><span class="n">StdError</span>::<span class="n">generic_err</span><span class="p">(</span><span class="s">&quot;Not implemented&quot;</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="4">4. 多应用场景系统详细设计</h2>
<h3 id="41">4.1 抽奖等级系统详细设计</h3>
<h3 id="41_1">4.1 抽奖等级配置管理</h3>
<div class="codehilite"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">std</span>::<span class="n">collections</span>::<span class="n">HashMap</span><span class="p">;</span>
<span class="k">use</span><span class="w"> </span><span class="n">serde</span>::<span class="p">{</span><span class="n">Deserialize</span><span class="p">,</span><span class="w"> </span><span class="n">Serialize</span><span class="p">};</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LotteryTierConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tier_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tier_name</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">prize_description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winner_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">min_participants</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">probability</span>: <span class="kt">f64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">prize_value</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">is_active</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LotteryProject</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">project_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">title</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tiers</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">LotteryTierConfig</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">total_participants</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">status</span>: <span class="nc">LotteryStatus</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">creator</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">created_at</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">updated_at</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">min_token_requirement</span>: <span class="nc">Uint128</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_contract_address</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, PartialEq)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">LotteryStatus</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Created</span><span class="p">,</span>
<span class="w">    </span><span class="n">Active</span><span class="p">,</span>
<span class="w">    </span><span class="n">Closed</span><span class="p">,</span>
<span class="w">    </span><span class="n">WinnersSelected</span><span class="p">,</span>
<span class="w">    </span><span class="n">Completed</span><span class="p">,</span>
<span class="w">    </span><span class="n">Cancelled</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">LotteryStatus</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">can_transition_to</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">new_status</span>: <span class="kp">&amp;</span><span class="nc">LotteryStatus</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">new_status</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="p">(</span><span class="n">LotteryStatus</span>::<span class="n">Created</span><span class="p">,</span><span class="w"> </span><span class="n">LotteryStatus</span>::<span class="n">Active</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="p">(</span><span class="n">LotteryStatus</span>::<span class="n">Active</span><span class="p">,</span><span class="w"> </span><span class="n">LotteryStatus</span>::<span class="n">Closed</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="p">(</span><span class="n">LotteryStatus</span>::<span class="n">Closed</span><span class="p">,</span><span class="w"> </span><span class="n">LotteryStatus</span>::<span class="n">WinnersSelected</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="p">(</span><span class="n">LotteryStatus</span>::<span class="n">WinnersSelected</span><span class="p">,</span><span class="w"> </span><span class="n">LotteryStatus</span>::<span class="n">Completed</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="p">(</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">LotteryStatus</span>::<span class="n">Cancelled</span><span class="p">)</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">true</span><span class="p">,</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="kc">false</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LotteryManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">projects</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">LotteryProject</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winning_number_generator</span>: <span class="nc">WinningNumberGenerator</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">LotteryManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">winning_number_generator</span>: <span class="nc">WinningNumberGenerator</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">projects</span>: <span class="nc">HashMap</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">winning_number_generator</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">create_lottery_project</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">config</span>: <span class="nc">LotteryProjectConfig</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">project_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_project_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 验证等级配置</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">validate_tier_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">.</span><span class="n">tiers</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LotteryProject</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">project_id</span>: <span class="nc">project_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">title</span>: <span class="nc">config</span><span class="p">.</span><span class="n">title</span><span class="p">,</span>
<span class="w">            </span><span class="n">description</span>: <span class="nc">config</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
<span class="w">            </span><span class="n">tiers</span>: <span class="nc">config</span><span class="p">.</span><span class="n">tiers</span><span class="p">,</span>
<span class="w">            </span><span class="n">total_participants</span>: <span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="n">status</span>: <span class="nc">LotteryStatus</span>::<span class="n">Created</span><span class="p">,</span>
<span class="w">            </span><span class="n">creator</span>: <span class="nc">config</span><span class="p">.</span><span class="n">creator</span><span class="p">,</span>
<span class="w">            </span><span class="n">created_at</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">            </span><span class="n">updated_at</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">            </span><span class="n">min_token_requirement</span>: <span class="nc">config</span><span class="p">.</span><span class="n">min_token_requirement</span><span class="p">,</span>
<span class="w">            </span><span class="n">nft_contract_address</span>: <span class="nc">config</span><span class="p">.</span><span class="n">nft_contract_address</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">projects</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">project_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">project</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_lottery_tiers</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">project_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">tiers</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">LotteryTierConfig</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">project</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">projects</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 只有在项目创建状态下才能修改等级配置</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">project</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">LotteryStatus</span>::<span class="n">Created</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Cannot modify tiers after project is active&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 验证等级配置</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">validate_tier_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tiers</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">            </span><span class="n">project</span><span class="p">.</span><span class="n">tiers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tiers</span><span class="p">;</span>
<span class="w">            </span><span class="n">project</span><span class="p">.</span><span class="n">updated_at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">();</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Project not found&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">())</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">activate_lottery</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">project_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">project</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">projects</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">project</span><span class="p">.</span><span class="n">status</span><span class="p">.</span><span class="n">can_transition_to</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LotteryStatus</span>::<span class="n">Active</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Invalid status transition&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 验证等级配置是否完整</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">project</span><span class="p">.</span><span class="n">tiers</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Cannot activate lottery without tier configuration&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">project</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LotteryStatus</span>::<span class="n">Active</span><span class="p">;</span>
<span class="w">            </span><span class="n">project</span><span class="p">.</span><span class="n">updated_at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">();</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Project not found&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">())</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">close_lottery</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">project_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">project</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">projects</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">project</span><span class="p">.</span><span class="n">status</span><span class="p">.</span><span class="n">can_transition_to</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LotteryStatus</span>::<span class="n">Closed</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Invalid status transition&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">project</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LotteryStatus</span>::<span class="n">Closed</span><span class="p">;</span>
<span class="w">            </span><span class="n">project</span><span class="p">.</span><span class="n">updated_at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">();</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Project not found&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">())</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">calculate_winners</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">project_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">participants</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">ParticipantData</span><span class="o">&gt;</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Winner</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">projects</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="s">&quot;Project not found&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">project</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">LotteryStatus</span>::<span class="n">Closed</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Lottery must be closed before selecting winners&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 更新参与者数量</span>
<span class="w">        </span><span class="n">project</span><span class="p">.</span><span class="n">total_participants</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">participants</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">used_indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashSet</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 为每个等级分配中奖者</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">tier</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="n">project</span><span class="p">.</span><span class="n">tiers</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">tier</span><span class="p">.</span><span class="n">is_active</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">continue</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">tier_winners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">select_tier_winners</span><span class="p">(</span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">participants</span><span class="p">,</span>
<span class="w">                </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">used_indices</span><span class="p">,</span>
<span class="w">                </span><span class="n">tier</span><span class="p">,</span>
<span class="w">                </span><span class="n">project_id</span>
<span class="w">            </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">winner</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">tier_winners</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">winners</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">winner</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">project</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LotteryStatus</span>::<span class="n">WinnersSelected</span><span class="p">;</span>
<span class="w">        </span><span class="n">project</span><span class="p">.</span><span class="n">updated_at</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">();</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">select_tier_winners</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participants</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">ParticipantData</span><span class="p">],</span>
<span class="w">        </span><span class="n">used_indices</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">tier</span>: <span class="kp">&amp;</span><span class="nc">LotteryTierConfig</span><span class="p">,</span>
<span class="w">        </span><span class="n">project_id</span>: <span class="kp">&amp;</span><span class="kt">str</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Winner</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">attempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">max_attempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">participants</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// 防止无限循环</span>

<span class="w">        </span><span class="c1">// 检查最小参与者要求</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">participants</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">min_participants</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;Insufficient participants for tier {}: required {}, got {}&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">tier</span><span class="p">.</span><span class="n">tier_name</span><span class="p">,</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">min_participants</span><span class="p">,</span><span class="w"> </span><span class="n">participants</span><span class="p">.</span><span class="n">len</span><span class="p">()</span>
<span class="w">            </span><span class="p">).</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="n">winners</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">winner_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">attempts</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">max_attempts</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">attempts</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// 使用中奖序号生成器选择中奖者</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">winner_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">select_winner_index</span><span class="p">(</span>
<span class="w">                </span><span class="n">participants</span><span class="p">,</span>
<span class="w">                </span><span class="n">used_indices</span><span class="p">,</span>
<span class="w">                </span><span class="n">tier</span><span class="p">,</span>
<span class="w">                </span><span class="n">project_id</span><span class="p">,</span>
<span class="w">                </span><span class="n">attempts</span>
<span class="w">            </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">index</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">winner_index</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">used_indices</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">index</span><span class="p">);</span>

<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">winner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Winner</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">participant_index</span>: <span class="nc">index</span><span class="p">,</span>
<span class="w">                    </span><span class="n">random_number</span>: <span class="nc">participants</span><span class="p">[</span><span class="n">index</span><span class="p">].</span><span class="n">random_number</span><span class="p">,</span>
<span class="w">                    </span><span class="n">tier_id</span>: <span class="nc">tier</span><span class="p">.</span><span class="n">tier_id</span><span class="p">,</span>
<span class="w">                    </span><span class="n">winning_number</span>: <span class="nc">self</span><span class="p">.</span><span class="n">winning_number_generator</span><span class="p">.</span><span class="n">generate_winning_number</span><span class="p">(</span>
<span class="w">                        </span><span class="o">&amp;</span><span class="n">participants</span><span class="p">[</span><span class="n">index</span><span class="p">],</span>
<span class="w">                        </span><span class="n">tier</span><span class="p">,</span>
<span class="w">                        </span><span class="n">winners</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span>
<span class="w">                    </span><span class="p">),</span>
<span class="w">                    </span><span class="n">project_id</span>: <span class="nc">project_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">                </span><span class="p">};</span>

<span class="w">                </span><span class="n">winners</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">winner</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">winners</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">winner_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;Failed to select enough winners for tier {}: required {}, got {}&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">tier</span><span class="p">.</span><span class="n">tier_name</span><span class="p">,</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">winner_count</span><span class="p">,</span><span class="w"> </span><span class="n">winners</span><span class="p">.</span><span class="n">len</span><span class="p">()</span>
<span class="w">            </span><span class="p">).</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">select_winner_index</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participants</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">ParticipantData</span><span class="p">],</span>
<span class="w">        </span><span class="n">used_indices</span>: <span class="kp">&amp;</span><span class="nc">HashSet</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">tier</span>: <span class="kp">&amp;</span><span class="nc">LotteryTierConfig</span><span class="p">,</span>
<span class="w">        </span><span class="n">project_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">attempt</span>: <span class="kt">usize</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Option</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 计算所有参与者的随机数总和</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">total_sum</span>: <span class="kt">i64</span> <span class="o">=</span><span class="w"> </span><span class="n">participants</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">p</span><span class="o">|</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">random_number</span><span class="p">).</span><span class="n">sum</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">participant_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">participants</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 使用总和对参与者数量取余，然后加上随机偏移</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">base_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">total_sum</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">participant_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">attempt</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">participants</span><span class="p">.</span><span class="n">len</span><span class="p">())</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">candidate_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">base_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">participants</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 检查候选索引是否已被使用</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">used_indices</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">candidate_index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 寻找下一个可用索引</span>
<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">participants</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="n">next_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">candidate_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">participants</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">used_indices</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">next_index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="n">next_index</span><span class="p">));</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="nb">None</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(</span><span class="nb">Some</span><span class="p">(</span><span class="n">candidate_index</span><span class="p">))</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">validate_tier_config</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">tiers</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">LotteryTierConfig</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">tiers</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;At least one tier must be configured&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">tier_ids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashSet</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">total_winners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">tier</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">tiers</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="c1">// 检查等级ID唯一性</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">tier_ids</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">tier</span><span class="p">.</span><span class="n">tier_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;Duplicate tier ID: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">tier_id</span><span class="p">).</span><span class="n">into</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 验证等级名称</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">tier_name</span><span class="p">.</span><span class="n">trim</span><span class="p">().</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;Tier name cannot be empty for tier ID: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">tier_id</span><span class="p">).</span><span class="n">into</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 验证中奖者数量</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">winner_count</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;Winner count must be greater than 0 for tier: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">tier_name</span><span class="p">).</span><span class="n">into</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="c1">// 验证概率范围</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">probability</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mf">0.0</span><span class="w"> </span><span class="o">||</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">probability</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mf">1.0</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;Probability must be between 0 and 1 for tier: {}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">tier_name</span><span class="p">).</span><span class="n">into</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">total_winners</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">winner_count</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 检查总中奖者数量是否合理</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">total_winners</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Total winner count must be greater than 0&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">generate_project_id</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">config</span>: <span class="kp">&amp;</span><span class="nc">LotteryProjectConfig</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">title</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">description</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">config</span><span class="p">.</span><span class="n">creator</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">().</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">hash_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">        </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;lottery_{:x}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">hash_result</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">get_current_timestamp</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">time</span>::<span class="n">SystemTime</span>::<span class="n">now</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">duration_since</span><span class="p">(</span><span class="n">std</span>::<span class="n">time</span>::<span class="n">UNIX_EPOCH</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">as_secs</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LotteryProjectConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">title</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tiers</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">LotteryTierConfig</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">creator</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">min_token_requirement</span>: <span class="nc">Uint128</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_contract_address</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Winner</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_index</span>: <span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">random_number</span>: <span class="kt">i64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tier_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winning_number</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">project_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="42">4.2 中奖序号分配算法详细实现</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">WinningNumberAllocator</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">allocation_strategy</span>: <span class="nc">AllocationStrategy</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winning_number_generator</span>: <span class="nc">WinningNumberGenerator</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">AllocationStrategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Sequential</span><span class="p">,</span><span class="w">      </span><span class="c1">// 顺序分配</span>
<span class="w">    </span><span class="n">Random</span><span class="p">,</span><span class="w">          </span><span class="c1">// 随机分配</span>
<span class="w">    </span><span class="n">Weighted</span><span class="p">,</span><span class="w">        </span><span class="c1">// 基于权重的分配</span>
<span class="w">    </span><span class="n">TierBased</span><span class="p">,</span><span class="w">       </span><span class="c1">// 基于等级的分配</span>
<span class="w">    </span><span class="n">HashBased</span><span class="p">,</span><span class="w">       </span><span class="c1">// 基于哈希的分配</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">WinningNumberAllocator</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">allocation_strategy</span>: <span class="nc">AllocationStrategy</span><span class="p">,</span><span class="w"> </span><span class="n">winning_number_generator</span>: <span class="nc">WinningNumberGenerator</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">allocation_strategy</span><span class="p">,</span>
<span class="w">            </span><span class="n">winning_number_generator</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">allocate_winning_numbers</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participants</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">ParticipantData</span><span class="p">],</span>
<span class="w">        </span><span class="n">tiers</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">LotteryTierConfig</span><span class="p">],</span>
<span class="w">        </span><span class="n">winners</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Winner</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">WinningNumberAssignment</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">allocation_strategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">AllocationStrategy</span>::<span class="n">Sequential</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">allocate_sequential</span><span class="p">(</span><span class="n">participants</span><span class="p">,</span><span class="w"> </span><span class="n">tiers</span><span class="p">,</span><span class="w"> </span><span class="n">winners</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">AllocationStrategy</span>::<span class="n">Random</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">allocate_random</span><span class="p">(</span><span class="n">participants</span><span class="p">,</span><span class="w"> </span><span class="n">tiers</span><span class="p">,</span><span class="w"> </span><span class="n">winners</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">AllocationStrategy</span>::<span class="n">Weighted</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">allocate_weighted</span><span class="p">(</span><span class="n">participants</span><span class="p">,</span><span class="w"> </span><span class="n">tiers</span><span class="p">,</span><span class="w"> </span><span class="n">winners</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">AllocationStrategy</span>::<span class="n">TierBased</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">allocate_tier_based</span><span class="p">(</span><span class="n">participants</span><span class="p">,</span><span class="w"> </span><span class="n">tiers</span><span class="p">,</span><span class="w"> </span><span class="n">winners</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">AllocationStrategy</span>::<span class="n">HashBased</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">allocate_hash_based</span><span class="p">(</span><span class="n">participants</span><span class="p">,</span><span class="w"> </span><span class="n">tiers</span><span class="p">,</span><span class="w"> </span><span class="n">winners</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">allocate_tier_based</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participants</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">ParticipantData</span><span class="p">],</span>
<span class="w">        </span><span class="n">tiers</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">LotteryTierConfig</span><span class="p">],</span>
<span class="w">        </span><span class="n">winners</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Winner</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">WinningNumberAssignment</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">assignments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 按等级分组中奖者</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">tier_winners</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;&amp;</span><span class="n">Winner</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashMap</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">winner</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">tier_winners</span><span class="p">.</span><span class="n">entry</span><span class="p">(</span><span class="n">winner</span><span class="p">.</span><span class="n">tier_id</span><span class="p">).</span><span class="n">or_insert_with</span><span class="p">(</span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">).</span><span class="n">push</span><span class="p">(</span><span class="n">winner</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 为每个等级分配中奖序号</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">tier</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">tiers</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">tier_winners_list</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tier_winners</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tier</span><span class="p">.</span><span class="n">tier_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">position</span><span class="p">,</span><span class="w"> </span><span class="n">winner</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">tier_winners_list</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">enumerate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">winning_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">winning_number_generator</span><span class="p">.</span><span class="n">generate_winning_number</span><span class="p">(</span>
<span class="w">                        </span><span class="o">&amp;</span><span class="n">participants</span><span class="p">[</span><span class="n">winner</span><span class="p">.</span><span class="n">participant_index</span><span class="p">],</span>
<span class="w">                        </span><span class="n">tier</span><span class="p">,</span>
<span class="w">                        </span><span class="n">position</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span>
<span class="w">                    </span><span class="p">);</span>

<span class="w">                    </span><span class="n">assignments</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">WinningNumberAssignment</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">participant_index</span>: <span class="nc">winner</span><span class="p">.</span><span class="n">participant_index</span><span class="p">,</span>
<span class="w">                        </span><span class="n">tier_id</span>: <span class="nc">tier</span><span class="p">.</span><span class="n">tier_id</span><span class="p">,</span>
<span class="w">                        </span><span class="n">position</span>: <span class="nc">position</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">,</span>
<span class="w">                        </span><span class="n">winning_number</span><span class="p">,</span>
<span class="w">                        </span><span class="n">nft_token_id</span>: <span class="nc">participants</span><span class="p">[</span><span class="n">winner</span><span class="p">.</span><span class="n">participant_index</span><span class="p">].</span><span class="n">nft_token_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">                    </span><span class="p">});</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">assignments</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">allocate_hash_based</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participants</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">ParticipantData</span><span class="p">],</span>
<span class="w">        </span><span class="n">tiers</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">LotteryTierConfig</span><span class="p">],</span>
<span class="w">        </span><span class="n">winners</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Winner</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">WinningNumberAssignment</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">assignments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">winner</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">participant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">participants</span><span class="p">[</span><span class="n">winner</span><span class="p">.</span><span class="n">participant_index</span><span class="p">];</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">tier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tiers</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">tier_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">winner</span><span class="p">.</span><span class="n">tier_id</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="s">&quot;Tier not found&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// 基于参与者数据和等级信息生成哈希</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">            </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">participant</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">            </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">participant</span><span class="p">.</span><span class="n">nft_token_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">            </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">tier</span><span class="p">.</span><span class="n">tier_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">            </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">winner</span><span class="p">.</span><span class="n">random_number</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>

<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">hash_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">hash_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kt">u64</span>::<span class="n">from_be_bytes</span><span class="p">([</span>
<span class="w">                </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
<span class="w">                </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
<span class="w">            </span><span class="p">]);</span>

<span class="w">            </span><span class="c1">// 生成中奖序号</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">tier_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">hash_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hash_value</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">winning_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">hash_offset</span><span class="p">;</span>

<span class="w">            </span><span class="n">assignments</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">WinningNumberAssignment</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">participant_index</span>: <span class="nc">winner</span><span class="p">.</span><span class="n">participant_index</span><span class="p">,</span>
<span class="w">                </span><span class="n">tier_id</span>: <span class="nc">winner</span><span class="p">.</span><span class="n">tier_id</span><span class="p">,</span>
<span class="w">                </span><span class="n">position</span>: <span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="c1">// 在哈希分配中位置不重要</span>
<span class="w">                </span><span class="n">winning_number</span><span class="p">,</span>
<span class="w">                </span><span class="n">nft_token_id</span>: <span class="nc">participant</span><span class="p">.</span><span class="n">nft_token_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">assignments</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">allocate_sequential</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">_participants</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">ParticipantData</span><span class="p">],</span>
<span class="w">        </span><span class="n">tiers</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">LotteryTierConfig</span><span class="p">],</span>
<span class="w">        </span><span class="n">winners</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Winner</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">WinningNumberAssignment</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">assignments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">current_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">winner</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">tier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tiers</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">tier_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">winner</span><span class="p">.</span><span class="n">tier_id</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="s">&quot;Tier not found&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">            </span><span class="n">assignments</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">WinningNumberAssignment</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">participant_index</span>: <span class="nc">winner</span><span class="p">.</span><span class="n">participant_index</span><span class="p">,</span>
<span class="w">                </span><span class="n">tier_id</span>: <span class="nc">winner</span><span class="p">.</span><span class="n">tier_id</span><span class="p">,</span>
<span class="w">                </span><span class="n">position</span>: <span class="mi">0</span><span class="p">,</span>
<span class="w">                </span><span class="n">winning_number</span>: <span class="nc">current_number</span><span class="p">,</span>
<span class="w">                </span><span class="n">nft_token_id</span>: <span class="nb">String</span>::<span class="n">new</span><span class="p">(),</span><span class="w"> </span><span class="c1">// 将在调用方设置</span>
<span class="w">            </span><span class="p">});</span>

<span class="w">            </span><span class="n">current_number</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">assignments</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">allocate_random</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participants</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">ParticipantData</span><span class="p">],</span>
<span class="w">        </span><span class="n">tiers</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">LotteryTierConfig</span><span class="p">],</span>
<span class="w">        </span><span class="n">winners</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Winner</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">WinningNumberAssignment</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">assignments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">used_numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashSet</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">winner</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">participant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">participants</span><span class="p">[</span><span class="n">winner</span><span class="p">.</span><span class="n">participant_index</span><span class="p">];</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">tier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tiers</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">tier_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">winner</span><span class="p">.</span><span class="n">tier_id</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="s">&quot;Tier not found&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// 生成随机中奖序号</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">create_seeded_rng</span><span class="p">(</span><span class="n">participant</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">winning_number</span><span class="p">;</span>

<span class="w">            </span><span class="k">loop</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">winning_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rng</span><span class="p">.</span><span class="n">gen_range</span><span class="p">(</span><span class="mi">1</span><span class="o">..=</span><span class="mi">1000000</span><span class="p">);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">used_numbers</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">winning_number</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">used_numbers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">winning_number</span><span class="p">);</span>
<span class="w">                    </span><span class="k">break</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">assignments</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">WinningNumberAssignment</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">participant_index</span>: <span class="nc">winner</span><span class="p">.</span><span class="n">participant_index</span><span class="p">,</span>
<span class="w">                </span><span class="n">tier_id</span>: <span class="nc">winner</span><span class="p">.</span><span class="n">tier_id</span><span class="p">,</span>
<span class="w">                </span><span class="n">position</span>: <span class="mi">0</span><span class="p">,</span>
<span class="w">                </span><span class="n">winning_number</span><span class="p">,</span>
<span class="w">                </span><span class="n">nft_token_id</span>: <span class="nc">participant</span><span class="p">.</span><span class="n">nft_token_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">assignments</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">allocate_weighted</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participants</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">ParticipantData</span><span class="p">],</span>
<span class="w">        </span><span class="n">tiers</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">LotteryTierConfig</span><span class="p">],</span>
<span class="w">        </span><span class="n">winners</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Winner</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">WinningNumberAssignment</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">assignments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">winner</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">participant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">participants</span><span class="p">[</span><span class="n">winner</span><span class="p">.</span><span class="n">participant_index</span><span class="p">];</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">tier</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tiers</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">tier_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">winner</span><span class="p">.</span><span class="n">tier_id</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="s">&quot;Tier not found&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// 基于等级权重和参与者数据生成中奖序号</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">weight_factor</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">tier</span><span class="p">.</span><span class="n">probability</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">1000.0</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">;</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">tier_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10000</span><span class="p">;</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">weighted_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">weight_factor</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">winner</span><span class="p">.</span><span class="n">random_number</span><span class="p">.</span><span class="n">unsigned_abs</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">);</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">winning_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">weighted_offset</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">10000</span><span class="p">);</span>

<span class="w">            </span><span class="n">assignments</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">WinningNumberAssignment</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">participant_index</span>: <span class="nc">winner</span><span class="p">.</span><span class="n">participant_index</span><span class="p">,</span>
<span class="w">                </span><span class="n">tier_id</span>: <span class="nc">winner</span><span class="p">.</span><span class="n">tier_id</span><span class="p">,</span>
<span class="w">                </span><span class="n">position</span>: <span class="mi">0</span><span class="p">,</span>
<span class="w">                </span><span class="n">winning_number</span><span class="p">,</span>
<span class="w">                </span><span class="n">nft_token_id</span>: <span class="nc">participant</span><span class="p">.</span><span class="n">nft_token_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="p">});</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">assignments</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">create_seeded_rng</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">participant</span>: <span class="kp">&amp;</span><span class="nc">ParticipantData</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">impl</span><span class="w"> </span><span class="n">Rng</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">seed</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">];</span>
<span class="w">        </span><span class="n">seed</span><span class="p">[</span><span class="o">..</span><span class="mi">16</span><span class="p">].</span><span class="n">copy_from_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">winning_number_generator</span><span class="p">.</span><span class="n">seed</span><span class="p">[</span><span class="o">..</span><span class="mi">16</span><span class="p">]);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">participant_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">hash_participant_data</span><span class="p">(</span><span class="n">participant</span><span class="p">);</span>
<span class="w">        </span><span class="n">seed</span><span class="p">[</span><span class="mi">16</span><span class="o">..</span><span class="mi">24</span><span class="p">].</span><span class="n">copy_from_slice</span><span class="p">(</span><span class="o">&amp;</span><span class="n">participant_hash</span><span class="p">.</span><span class="n">to_be_bytes</span><span class="p">());</span>

<span class="w">        </span><span class="n">rand</span>::<span class="n">SeedableRng</span>::<span class="n">from_seed</span><span class="p">(</span><span class="n">seed</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">hash_participant_data</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">participant</span>: <span class="kp">&amp;</span><span class="nc">ParticipantData</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">participant</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">participant</span><span class="p">.</span><span class="n">random_number</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">participant</span><span class="p">.</span><span class="n">nft_token_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">hash_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">        </span><span class="kt">u64</span>::<span class="n">from_be_bytes</span><span class="p">([</span>
<span class="w">            </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span>
<span class="w">            </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">4</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">5</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">6</span><span class="p">],</span><span class="w"> </span><span class="n">hash_result</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span>
<span class="w">        </span><span class="p">])</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">WinningNumberAssignment</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_index</span>: <span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tier_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">position</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winning_number</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_token_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="43">4.3 抽奖结果验证和审计</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LotteryResultVerifier</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">verification_strategy</span>: <span class="nc">VerificationStrategy</span><span class="p">,</span>
<span class="p">}</span>

###<span class="w"> </span><span class="mf">4.4</span><span class="w"> </span><span class="err">彩票系统详细设计</span>
<span class="err">```</span><span class="n">rust</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LotteryTicketSystem</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">ticket_manager</span>: <span class="nc">TicketManager</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">draw_engine</span>: <span class="nc">DrawEngine</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">prize_distributor</span>: <span class="nc">PrizeDistributor</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">TicketManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tickets</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">LotteryTicket</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">ticket_counter</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LotteryTicket</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">ticket_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">owner</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">ticket_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">purchase_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">price</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">lucky_number</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">is_winner</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">prize_amount</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">LotteryTicketSystem</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">purchase_ticket</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">owner</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">ticket_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">price</span>: <span class="kt">u64</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ticket_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_ticket_id</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ticket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LotteryTicket</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ticket_id</span>: <span class="nc">ticket_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">owner</span><span class="p">,</span>
<span class="w">            </span><span class="n">ticket_type</span><span class="p">,</span>
<span class="w">            </span><span class="n">purchase_time</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">            </span><span class="n">price</span><span class="p">,</span>
<span class="w">            </span><span class="n">lucky_number</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">            </span><span class="n">is_winner</span>: <span class="nc">false</span><span class="p">,</span>
<span class="w">            </span><span class="n">prize_amount</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">ticket_manager</span><span class="p">.</span><span class="n">tickets</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">ticket_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">ticket</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">ticket_manager</span><span class="p">.</span><span class="n">ticket_counter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">ticket_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">submit_lucky_number</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">ticket_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">lucky_number</span>: <span class="kt">i32</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">ticket</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ticket_manager</span><span class="p">.</span><span class="n">tickets</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="n">ticket_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">ticket</span><span class="p">.</span><span class="n">lucky_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">lucky_number</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">draw_lottery</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">DrawResult</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 收集所有幸运数字</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">lucky_numbers</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i32</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ticket_manager</span><span class="p">.</span><span class="n">tickets</span>
<span class="w">            </span><span class="p">.</span><span class="n">values</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">filter_map</span><span class="p">(</span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">lucky_number</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">collect</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 生成开奖号码</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">draw_number</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">draw_engine</span><span class="p">.</span><span class="n">generate_draw_number</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lucky_numbers</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 确定中奖者</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">identify_winners</span><span class="p">(</span><span class="o">&amp;</span><span class="n">draw_number</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 分配奖金</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">prize_distribution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">prize_distributor</span><span class="p">.</span><span class="n">distribute_prizes</span><span class="p">(</span><span class="o">&amp;</span><span class="n">winners</span><span class="p">);</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">DrawResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">draw_number</span><span class="p">,</span>
<span class="w">            </span><span class="n">winners</span><span class="p">,</span>
<span class="w">            </span><span class="n">prize_distribution</span><span class="p">,</span>
<span class="w">            </span><span class="n">draw_time</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">        </span><span class="p">})</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">DrawResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">draw_number</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winners</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">prize_distribution</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">draw_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="45">4.5 资源分配系统详细设计</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ResourceAllocationSystem</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">resource_manager</span>: <span class="nc">ResourceManager</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">allocation_engine</span>: <span class="nc">AllocationEngine</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">preference_collector</span>: <span class="nc">PreferenceCollector</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ResourceManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">resources</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Resource</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">allocation_history</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">AllocationRecord</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Resource</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">resource_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">resource_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">total_amount</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">allocated_amount</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">unit_price</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">constraints</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Constraint</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">AllocationEngine</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">algorithms</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">AllocationAlgorithm</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">AllocationAlgorithm</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">allocate</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">resources</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Resource</span><span class="p">],</span>
<span class="w">        </span><span class="n">preferences</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Preference</span><span class="p">],</span>
<span class="w">        </span><span class="n">constraints</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Constraint</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">AllocationResult</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">HungarianAllocationAlgorithm</span><span class="p">;</span>

<span class="k">impl</span><span class="w"> </span><span class="n">AllocationAlgorithm</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">HungarianAllocationAlgorithm</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">allocate</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">resources</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Resource</span><span class="p">],</span>
<span class="w">        </span><span class="n">preferences</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Preference</span><span class="p">],</span>
<span class="w">        </span><span class="n">constraints</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Constraint</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">AllocationResult</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 实现匈牙利算法进行资源分配</span>
<span class="w">        </span><span class="c1">// 这里应该实现具体的算法逻辑</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">AllocationResult</span>::<span class="n">default</span><span class="p">())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">AllocationResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">allocations</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Allocation</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">total_value</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">efficiency_score</span>: <span class="kt">f64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">fairness_score</span>: <span class="kt">f64</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Allocation</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">resource_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">allocated_amount</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">preference_score</span>: <span class="kt">f64</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="46">4.6 治理投票系统详细设计</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">GovernanceSystem</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">proposal_manager</span>: <span class="nc">ProposalManager</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">voting_engine</span>: <span class="nc">VotingEngine</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">decision_executor</span>: <span class="nc">DecisionExecutor</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ProposalManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">proposals</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Proposal</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">proposal_counter</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Proposal</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">proposal_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">title</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">creator</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">proposal_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">status</span>: <span class="nc">ProposalStatus</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">created_at</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">voting_start</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">voting_end</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">decision_threshold</span>: <span class="kt">f64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">execution_delay</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, PartialEq)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">ProposalStatus</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Draft</span><span class="p">,</span>
<span class="w">    </span><span class="n">Active</span><span class="p">,</span>
<span class="w">    </span><span class="n">Voting</span><span class="p">,</span>
<span class="w">    </span><span class="n">Closed</span><span class="p">,</span>
<span class="w">    </span><span class="n">Executed</span><span class="p">,</span>
<span class="w">    </span><span class="n">Rejected</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">GovernanceSystem</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">create_proposal</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">title</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">creator</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">proposal_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">voting_duration</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">        </span><span class="n">decision_threshold</span>: <span class="kt">f64</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">proposal_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_proposal_id</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">current_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">proposal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Proposal</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">proposal_id</span>: <span class="nc">proposal_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">title</span><span class="p">,</span>
<span class="w">            </span><span class="n">description</span><span class="p">,</span>
<span class="w">            </span><span class="n">creator</span><span class="p">,</span>
<span class="w">            </span><span class="n">proposal_type</span><span class="p">,</span>
<span class="w">            </span><span class="n">status</span>: <span class="nc">ProposalStatus</span>::<span class="n">Draft</span><span class="p">,</span>
<span class="w">            </span><span class="n">created_at</span>: <span class="nc">current_time</span><span class="p">,</span>
<span class="w">            </span><span class="n">voting_start</span>: <span class="nc">current_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3600</span><span class="p">,</span><span class="w"> </span><span class="c1">// 1小时后开始投票</span>
<span class="w">            </span><span class="n">voting_end</span>: <span class="nc">current_time</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3600</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">voting_duration</span><span class="p">,</span>
<span class="w">            </span><span class="n">decision_threshold</span><span class="p">,</span>
<span class="w">            </span><span class="n">execution_delay</span>: <span class="mi">86400</span><span class="p">,</span><span class="w"> </span><span class="c1">// 24小时执行延迟</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">proposal_manager</span><span class="p">.</span><span class="n">proposals</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">proposal_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">proposal</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">proposal_manager</span><span class="p">.</span><span class="n">proposal_counter</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">proposal_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">submit_vote</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">proposal_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">voter</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">preference</span>: <span class="kt">i32</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 验证投票资格</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">verify_voting_eligibility</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proposal_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">voter</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Voter not eligible&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 提交投票</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">voting_engine</span><span class="p">.</span><span class="n">submit_vote</span><span class="p">(</span><span class="n">proposal_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">voter</span><span class="p">,</span><span class="w"> </span><span class="n">preference</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">calculate_decision</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">proposal_id</span>: <span class="kp">&amp;</span><span class="kt">str</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">DecisionResult</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">proposal</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">proposal_manager</span><span class="p">.</span><span class="n">proposals</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">proposal_id</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="s">&quot;Proposal not found&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 计算投票结果</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">voting_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">voting_engine</span><span class="p">.</span><span class="n">calculate_result</span><span class="p">(</span><span class="n">proposal_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 判断是否达到决策阈值</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">decision</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="n">voting_result</span><span class="p">.</span><span class="n">support_score</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">proposal</span><span class="p">.</span><span class="n">decision_threshold</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Decision</span>::<span class="n">Approved</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">Decision</span>::<span class="n">Rejected</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">decision_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DecisionResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">proposal_id</span>: <span class="nc">proposal_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">decision</span><span class="p">,</span>
<span class="w">            </span><span class="n">support_score</span>: <span class="nc">voting_result</span><span class="p">.</span><span class="n">support_score</span><span class="p">,</span>
<span class="w">            </span><span class="n">total_votes</span>: <span class="nc">voting_result</span><span class="p">.</span><span class="n">total_votes</span><span class="p">,</span>
<span class="w">            </span><span class="n">calculated_at</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// 如果通过，安排执行</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">decision</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Decision</span>::<span class="n">Approved</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">decision_executor</span><span class="p">.</span><span class="n">schedule_execution</span><span class="p">(</span><span class="n">proposal_id</span><span class="p">,</span><span class="w"> </span><span class="n">proposal</span><span class="p">.</span><span class="n">execution_delay</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">decision_result</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">DecisionResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">proposal_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">decision</span>: <span class="nc">Decision</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">support_score</span>: <span class="kt">f64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">total_votes</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">calculated_at</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, PartialEq)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">Decision</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Approved</span><span class="p">,</span>
<span class="w">    </span><span class="n">Rejected</span><span class="p">,</span>
<span class="w">    </span><span class="n">Pending</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">VerificationStrategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Full</span><span class="p">,</span><span class="w">           </span><span class="c1">// 完整验证</span>
<span class="w">    </span><span class="n">Sampling</span><span class="p">,</span><span class="w">       </span><span class="c1">// 抽样验证</span>
<span class="w">    </span><span class="n">HashBased</span><span class="p">,</span><span class="w">      </span><span class="c1">// 基于哈希的验证</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">LotteryResultVerifier</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">verification_strategy</span>: <span class="nc">VerificationStrategy</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">verification_strategy</span><span class="w"> </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">verify_lottery_result</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">project</span>: <span class="kp">&amp;</span><span class="nc">LotteryProject</span><span class="p">,</span>
<span class="w">        </span><span class="n">participants</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">ParticipantData</span><span class="p">],</span>
<span class="w">        </span><span class="n">winners</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Winner</span><span class="p">],</span>
<span class="w">        </span><span class="n">assignments</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">WinningNumberAssignment</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">VerificationResult</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">verification_strategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">VerificationStrategy</span>::<span class="n">Full</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">verify_full</span><span class="p">(</span><span class="n">project</span><span class="p">,</span><span class="w"> </span><span class="n">participants</span><span class="p">,</span><span class="w"> </span><span class="n">winners</span><span class="p">,</span><span class="w"> </span><span class="n">assignments</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">VerificationStrategy</span>::<span class="n">Sampling</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">verify_sampling</span><span class="p">(</span><span class="n">project</span><span class="p">,</span><span class="w"> </span><span class="n">participants</span><span class="p">,</span><span class="w"> </span><span class="n">winners</span><span class="p">,</span><span class="w"> </span><span class="n">assignments</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">VerificationStrategy</span>::<span class="n">HashBased</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">verify_hash_based</span><span class="p">(</span><span class="n">project</span><span class="p">,</span><span class="w"> </span><span class="n">participants</span><span class="p">,</span><span class="w"> </span><span class="n">winners</span><span class="p">,</span><span class="w"> </span><span class="n">assignments</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">verify_full</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">project</span>: <span class="kp">&amp;</span><span class="nc">LotteryProject</span><span class="p">,</span>
<span class="w">        </span><span class="n">participants</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">ParticipantData</span><span class="p">],</span>
<span class="w">        </span><span class="n">winners</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Winner</span><span class="p">],</span>
<span class="w">        </span><span class="n">assignments</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">WinningNumberAssignment</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">VerificationResult</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">verification_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VerificationResult</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 验证参与者数量</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">participants</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">project</span><span class="p">.</span><span class="n">total_participants</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">verification_result</span><span class="p">.</span><span class="n">add_error</span><span class="p">(</span><span class="s">&quot;Participant count mismatch&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 验证中奖者数量</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">expected_winners</span>: <span class="kt">u32</span> <span class="o">=</span><span class="w"> </span><span class="n">project</span><span class="p">.</span><span class="n">tiers</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">t</span><span class="o">|</span><span class="w"> </span><span class="n">t</span><span class="p">.</span><span class="n">winner_count</span><span class="p">).</span><span class="n">sum</span><span class="p">();</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">winners</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">expected_winners</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">verification_result</span><span class="p">.</span><span class="n">add_error</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span>
<span class="w">                </span><span class="s">&quot;Winner count mismatch: expected {}, got {}&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="n">expected_winners</span><span class="p">,</span><span class="w"> </span><span class="n">winners</span><span class="p">.</span><span class="n">len</span><span class="p">()</span>
<span class="w">            </span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 验证每个等级的中奖者数量</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">tier</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="n">project</span><span class="p">.</span><span class="n">tiers</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">tier_winners</span>: <span class="nb">Vec</span><span class="o">&lt;&amp;</span><span class="n">Winner</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">winners</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">filter</span><span class="p">(</span><span class="o">|</span><span class="n">w</span><span class="o">|</span><span class="w"> </span><span class="n">w</span><span class="p">.</span><span class="n">tier_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">tier_id</span><span class="p">).</span><span class="n">collect</span><span class="p">();</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">tier_winners</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">winner_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">verification_result</span><span class="p">.</span><span class="n">add_error</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span>
<span class="w">                    </span><span class="s">&quot;Tier {} winner count mismatch: expected {}, got {}&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">tier</span><span class="p">.</span><span class="n">tier_name</span><span class="p">,</span><span class="w"> </span><span class="n">tier</span><span class="p">.</span><span class="n">winner_count</span><span class="p">,</span><span class="w"> </span><span class="n">tier_winners</span><span class="p">.</span><span class="n">len</span><span class="p">()</span>
<span class="w">                </span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 验证中奖序号的唯一性</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">winning_numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashSet</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">assignment</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">assignments</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">winning_numbers</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">assignment</span><span class="p">.</span><span class="n">winning_number</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">verification_result</span><span class="p">.</span><span class="n">add_error</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span>
<span class="w">                    </span><span class="s">&quot;Duplicate winning number: {}&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">assignment</span><span class="p">.</span><span class="n">winning_number</span>
<span class="w">                </span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 验证计算过程的正确性</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">total_sum</span>: <span class="kt">i64</span> <span class="o">=</span><span class="w"> </span><span class="n">participants</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">p</span><span class="o">|</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">random_number</span><span class="p">).</span><span class="n">sum</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">participant_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">participants</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 验证中奖者索引的计算</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">winner</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">calculated_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">total_sum</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">participant_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">winner</span><span class="p">.</span><span class="n">participant_index</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="n">participants</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">verification_result</span><span class="p">.</span><span class="n">add_error</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span>
<span class="w">                    </span><span class="s">&quot;Invalid participant index: {}&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">winner</span><span class="p">.</span><span class="n">participant_index</span>
<span class="w">                </span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">verification_result</span><span class="p">.</span><span class="n">set_verification_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">());</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">verification_result</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">verify_sampling</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">project</span>: <span class="kp">&amp;</span><span class="nc">LotteryProject</span><span class="p">,</span>
<span class="w">        </span><span class="n">participants</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">ParticipantData</span><span class="p">],</span>
<span class="w">        </span><span class="n">winners</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Winner</span><span class="p">],</span>
<span class="w">        </span><span class="n">assignments</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">WinningNumberAssignment</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">VerificationResult</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">verification_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VerificationResult</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 随机选择样本进行验证</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">sample_size</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">winners</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="mi">10</span><span class="p">).</span><span class="n">max</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span><span class="w"> </span><span class="c1">// 至少验证10%的中奖者</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span>::<span class="n">thread_rng</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">sample_indices</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">winners</span><span class="p">.</span><span class="n">len</span><span class="p">())</span>
<span class="w">            </span><span class="p">.</span><span class="n">choose_multiple</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="p">,</span><span class="w"> </span><span class="n">sample_size</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">cloned</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">collect</span><span class="p">();</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="o">&amp;</span><span class="n">index</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="n">sample_indices</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">winner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">winners</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">assignment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">assignments</span><span class="p">.</span><span class="n">iter</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">a</span><span class="o">|</span><span class="w"> </span><span class="n">a</span><span class="p">.</span><span class="n">participant_index</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">winner</span><span class="p">.</span><span class="n">participant_index</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="s">&quot;Assignment not found&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// 验证中奖序号的合理性</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">assignment</span><span class="p">.</span><span class="n">winning_number</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">verification_result</span><span class="p">.</span><span class="n">add_error</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span>
<span class="w">                    </span><span class="s">&quot;Invalid winning number for participant {}: {}&quot;</span><span class="p">,</span>
<span class="w">                    </span><span class="n">winner</span><span class="p">.</span><span class="n">participant_index</span><span class="p">,</span><span class="w"> </span><span class="n">assignment</span><span class="p">.</span><span class="n">winning_number</span>
<span class="w">                </span><span class="p">));</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">verification_result</span><span class="p">.</span><span class="n">set_verification_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">());</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">verification_result</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">verify_hash_based</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">project</span>: <span class="kp">&amp;</span><span class="nc">LotteryProject</span><span class="p">,</span>
<span class="w">        </span><span class="n">participants</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">ParticipantData</span><span class="p">],</span>
<span class="w">        </span><span class="n">winners</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Winner</span><span class="p">],</span>
<span class="w">        </span><span class="n">assignments</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">WinningNumberAssignment</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">VerificationResult</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">verification_result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">VerificationResult</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 计算所有参与者数据的哈希值</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">participant_hashes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">participant</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">participants</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">calculate_participant_hash</span><span class="p">(</span><span class="n">participant</span><span class="p">);</span>
<span class="w">            </span><span class="n">participant_hashes</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 计算中奖者数据的哈希值</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">winner_hashes</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">winner</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">participant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="n">participants</span><span class="p">[</span><span class="n">winner</span><span class="p">.</span><span class="n">participant_index</span><span class="p">];</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">calculate_winner_hash</span><span class="p">(</span><span class="n">participant</span><span class="p">,</span><span class="w"> </span><span class="n">winner</span><span class="p">);</span>
<span class="w">            </span><span class="n">winner_hashes</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 验证哈希值的一致性</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">participant_hash_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">calculate_merkle_root</span><span class="p">(</span><span class="o">&amp;</span><span class="n">participant_hashes</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">winner_hash_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">calculate_merkle_root</span><span class="p">(</span><span class="o">&amp;</span><span class="n">winner_hashes</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 存储哈希根用于后续验证</span>
<span class="w">        </span><span class="n">verification_result</span><span class="p">.</span><span class="n">set_participant_hash_root</span><span class="p">(</span><span class="n">participant_hash_root</span><span class="p">);</span>
<span class="w">        </span><span class="n">verification_result</span><span class="p">.</span><span class="n">set_winner_hash_root</span><span class="p">(</span><span class="n">winner_hash_root</span><span class="p">);</span>

<span class="w">        </span><span class="n">verification_result</span><span class="p">.</span><span class="n">set_verification_timestamp</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">());</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">verification_result</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">calculate_participant_hash</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">participant</span>: <span class="kp">&amp;</span><span class="nc">ParticipantData</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">participant</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">participant</span><span class="p">.</span><span class="n">random_number</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">participant</span><span class="p">.</span><span class="n">nft_token_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">participant</span><span class="p">.</span><span class="n">voting_project_id</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>

<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">().</span><span class="n">into</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">calculate_winner_hash</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">participant</span>: <span class="kp">&amp;</span><span class="nc">ParticipantData</span><span class="p">,</span><span class="w"> </span><span class="n">winner</span>: <span class="kp">&amp;</span><span class="nc">Winner</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">participant</span><span class="p">.</span><span class="n">address</span><span class="p">.</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">winner</span><span class="p">.</span><span class="n">random_number</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">winner</span><span class="p">.</span><span class="n">tier_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">winner</span><span class="p">.</span><span class="n">winning_number</span><span class="p">.</span><span class="n">to_string</span><span class="p">().</span><span class="n">as_bytes</span><span class="p">());</span>

<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">().</span><span class="n">into</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">calculate_merkle_root</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">hashes</span>: <span class="kp">&amp;</span><span class="p">[[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]])</span><span class="w"> </span>-&gt; <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">hashes</span><span class="p">.</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">hashes</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="n">hashes</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">current_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hashes</span><span class="p">.</span><span class="n">to_vec</span><span class="p">();</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="n">current_level</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">next_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">chunk</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">current_level</span><span class="p">.</span><span class="n">chunks</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">                </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">chunk</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chunk</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">chunk</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span><span class="w"> </span><span class="c1">// 奇数个元素时重复最后一个</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="n">next_level</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">().</span><span class="n">into</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span>

<span class="w">            </span><span class="n">current_level</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">next_level</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">current_level</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">get_current_timestamp</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">time</span>::<span class="n">SystemTime</span>::<span class="n">now</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">duration_since</span><span class="p">(</span><span class="n">std</span>::<span class="n">time</span>::<span class="n">UNIX_EPOCH</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">as_secs</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">VerificationResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">is_valid</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">errors</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">warnings</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">verification_timestamp</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_hash_root</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winner_hash_root</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">VerificationResult</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">is_valid</span>: <span class="nc">true</span><span class="p">,</span>
<span class="w">            </span><span class="n">errors</span>: <span class="nb">Vec</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">warnings</span>: <span class="nb">Vec</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">verification_timestamp</span>: <span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="n">participant_hash_root</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">            </span><span class="n">winner_hash_root</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_error</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">error</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">errors</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">error</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">is_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_warning</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">warning</span>: <span class="nb">String</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">warnings</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">warning</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_verification_timestamp</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">timestamp</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">verification_timestamp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">timestamp</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_participant_hash_root</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">hash_root</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">participant_hash_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">hash_root</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_winner_hash_root</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">hash_root</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">])</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">winner_hash_root</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">hash_root</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_summary</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span>
<span class="w">        </span><span class="fm">format!</span><span class="p">(</span>
<span class="w">            </span><span class="s">&quot;Verification Result: {} ({} errors, {} warnings)&quot;</span><span class="p">,</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">is_valid</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;VALID&quot;</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="s">&quot;INVALID&quot;</span><span class="w"> </span><span class="p">},</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">errors</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">warnings</span><span class="p">.</span><span class="n">len</span><span class="p">()</span>
<span class="w">        </span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="5">5. 存储策略模块详细设计</h2>
<h3 id="51">5.1 分层存储策略</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">StorageLayer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">OnChain</span><span class="p">,</span>
<span class="w">    </span><span class="n">IPFS</span><span class="p">,</span>
<span class="w">    </span><span class="n">Local</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">StorageStrategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">layers</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">StorageLayer</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">redundancy</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">compression</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">ipfs_config</span>: <span class="nc">IPFSConfig</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">IPFSConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">gateway_urls</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">local_node</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">LocalIPFSNode</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">pinning_services</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">PinningService</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">redundancy_factor</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">data_retention_days</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LocalIPFSNode</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">api_url</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">data_path</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">max_storage_gb</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">PinningService</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">api_key</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">endpoint</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">cost_per_gb</span>: <span class="kt">f64</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">StorageStrategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">layers</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[</span><span class="n">StorageLayer</span>::<span class="n">IPFS</span><span class="p">,</span><span class="w"> </span><span class="n">StorageLayer</span>::<span class="n">OnChain</span><span class="p">],</span>
<span class="w">            </span><span class="n">redundancy</span>: <span class="mi">3</span><span class="p">,</span>
<span class="w">            </span><span class="n">compression</span>: <span class="nc">true</span><span class="p">,</span>
<span class="w">            </span><span class="n">ipfs_config</span>: <span class="nc">IPFSConfig</span>::<span class="n">default</span><span class="p">(),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">store</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">data</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">locations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// IPFS作为主要存储方案</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">StorageLayer</span>::<span class="n">IPFS</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">ipfs_locations</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">store_to_ipfs_with_redundancy</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">locations</span><span class="p">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ipfs_locations</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 链上存储关键哈希</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">StorageLayer</span>::<span class="n">OnChain</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">store_on_chain</span><span class="p">(</span><span class="n">data</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">locations</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;chain:{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">hash</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 本地缓存（可选）</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">layers</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">StorageLayer</span>::<span class="n">Local</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">path</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">store_local</span><span class="p">(</span><span class="n">key</span><span class="p">,</span><span class="w"> </span><span class="n">data</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">locations</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;local:{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">path</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">locations</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">store_to_ipfs_with_redundancy</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">data</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">cids</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 存储到本地IPFS节点</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">local_node</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">ipfs_config</span><span class="p">.</span><span class="n">local_node</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">cid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">store_to_local_ipfs</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">local_node</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">cids</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;ipfs:{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cid</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 存储到公共网关</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">gateway</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">ipfs_config</span><span class="p">.</span><span class="n">gateway_urls</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">cid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">store_to_gateway</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">gateway</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">cids</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;gateway:{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cid</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 使用固定服务确保数据持久性</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">service</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">ipfs_config</span><span class="p">.</span><span class="n">pinning_services</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">cid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">pin_to_service</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="w"> </span><span class="n">service</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">cids</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;pinned:{}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">cid</span><span class="p">));</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">cids</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="52">5.2 数据完整性验证</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">IntegrityVerifier</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">merkle_tree</span>: <span class="nc">MerkleTree</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">signatures</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">DigitalSignature</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">IntegrityVerifier</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">verify_data_integrity</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">data</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">],</span><span class="w"> </span><span class="n">proof</span>: <span class="kp">&amp;</span><span class="nc">IntegrityProof</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span>
<span class="w">        </span><span class="c1">// 验证Merkle证明</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">merkle_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">merkle_tree</span><span class="p">.</span><span class="n">verify_proof</span><span class="p">(</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">proof</span><span class="p">.</span><span class="n">merkle_proof</span><span class="p">,</span>
<span class="w">            </span><span class="n">data</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">proof</span><span class="p">.</span><span class="n">root_hash</span>
<span class="w">        </span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 验证数字签名</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">signature_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">verify_signatures</span><span class="p">(</span><span class="o">&amp;</span><span class="n">proof</span><span class="p">.</span><span class="n">signatures</span><span class="p">);</span>

<span class="w">        </span><span class="n">merkle_valid</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">signature_valid</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">generate_integrity_proof</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">data</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">IntegrityProof</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">merkle_proof</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">merkle_tree</span><span class="p">.</span><span class="n">generate_proof</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">signatures</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">sign_data</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>

<span class="w">        </span><span class="n">IntegrityProof</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">merkle_proof</span><span class="p">,</span>
<span class="w">            </span><span class="n">signatures</span><span class="p">,</span>
<span class="w">            </span><span class="n">root_hash</span>: <span class="nc">self</span><span class="p">.</span><span class="n">merkle_tree</span><span class="p">.</span><span class="n">root</span><span class="p">(),</span>
<span class="w">            </span><span class="n">timestamp</span>: <span class="nc">SystemTime</span>::<span class="n">now</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="n">duration_since</span><span class="p">(</span><span class="n">UNIX_EPOCH</span><span class="p">)</span>
<span class="w">                </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="n">as_secs</span><span class="p">(),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="6">6. 性能优化详细设计</h2>
<h3 id="53">5.3 链上最小记录集数据结构（新增）</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// 链上仅存最小必要摘要与指针，明细驻留 IPFS（CID/版本 为单一真实源）</span>
<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">OffchainPointer</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">cid</span>: <span class="nb">String</span><span class="p">,</span><span class="w">          </span><span class="c1">// IPFS CID（唯一内容寻址）</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">version</span>: <span class="kt">u32</span><span class="p">,</span><span class="w">         </span><span class="c1">// 版本号（与CID变更一同递增）</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">sha256</span>: <span class="nb">String</span><span class="p">,</span><span class="w">       </span><span class="c1">// 可选：链上再次校验的哈希摘要</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ResultSummary</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span><span class="w">           </span><span class="c1">// 归属的NFT类型（决定规则）</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winners_count</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">,</span><span class="w">  </span><span class="c1">// n选k的k，或单一中奖为1</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">merkle_root</span>: <span class="nb">String</span><span class="p">,</span><span class="w">        </span><span class="c1">// 结果/参与者/揭示等的根哈希</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">offchain</span>: <span class="nc">OffchainPointer</span><span class="p">,</span><span class="w">  </span><span class="c1">// 指向IPFS明细</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">timestamp</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>

<span class="c1">// 最小化上链条目：账户- NFT 关联（当前所有权）</span>
<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">OwnershipRecord</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">token_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">owner</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">updated_at</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="531">5.3.1 合约消息扩展</h4>
<div class="codehilite"><pre><span></span><code><span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">ExecuteMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...既有消息...</span>
<span class="w">    </span><span class="n">SetOffchainSummary</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">summary</span>: <span class="nc">ResultSummary</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">QueryMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// ...既有查询...</span>
<span class="w">    </span><span class="n">GetOffchainSummary</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">GetOffchainSummaryResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">summary</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">ResultSummary</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="532">5.3.2 上链写入与校验流程</h4>
<ul>
<li>写入前：对 IPFS 明细计算 <code>sha256</code> 与 <code>merkle_root</code>，生成 <code>ResultSummary</code>。</li>
<li>上链：调用 <code>SetOffchainSummary</code> 写入 <code>ResultSummary</code>，作为可验证索引。</li>
<li>校验：审计方据 <code>cid/version/sha256/merkle_root</code> 交叉验证 IPFS 明细与链上摘要一致。</li>
</ul>
<h3 id="54-nft">5.4 NFT 元数据与配置引用（新增）</h3>
<div class="codehilite"><pre><span></span><code><span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NftMetadataExtension</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span><span class="w">             </span><span class="c1">// 类型标识</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">config_cid</span>: <span class="nb">String</span><span class="p">,</span><span class="w">           </span><span class="c1">// NFT类型全局参数的CID</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">config_version</span>: <span class="kt">u32</span><span class="p">,</span><span class="w">          </span><span class="c1">// 对应的配置版本</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">voting_project_title</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">lottery_tier</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">,</span><span class="w">    </span><span class="c1">// 抽奖等级（如适用）</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winning_number</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span><span class="w">  </span><span class="c1">// 分配后的唯一序号（如适用）</span>
<span class="p">}</span>

<span class="c1">// 铸造/更新时写入的元数据（CW721 扩展字段）</span>
<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">NFTExecuteMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Mint</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">token_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">owner</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">token_uri</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">extension</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">NftMetadataExtension</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">UpdateMetadata</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">token_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">token_uri</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">extension</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">NftMetadataExtension</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="541">5.4.1 一致性规则</h4>
<ul>
<li><code>config_cid/config_version</code> 必须与链上登记的 NFT 类型配置匹配；</li>
<li>如 <code>winning_number</code> 更新，需伴随写入结果 <code>ResultSummary</code> 的新版本并记录变更审计；</li>
<li>客户端与SDK默认以 <code>config_cid/config_version</code> 为唯一真实源（SoT）。</li>
</ul>
<h3 id="61-webassembly">6.1 WebAssembly性能优化</h3>
<div class="codehilite"><pre><span></span><code><span class="cp">#[wasm_bindgen]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">VotingEngine</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">cache</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">CachedVote</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">batch_processor</span>: <span class="nc">BatchProcessor</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[wasm_bindgen]</span>
<span class="k">impl</span><span class="w"> </span><span class="n">VotingEngine</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cache</span>: <span class="nc">HashMap</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">batch_processor</span>: <span class="nc">BatchProcessor</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">process_vote_batch</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">votes</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">VoteSubmission</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">ProcessingResult</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 并行处理投票</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">results</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">ProcessingResult</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">votes</span>
<span class="w">            </span><span class="p">.</span><span class="n">par_iter</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">map</span><span class="p">(</span><span class="o">|</span><span class="n">vote</span><span class="o">|</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">process_single_vote</span><span class="p">(</span><span class="n">vote</span><span class="p">))</span>
<span class="w">            </span><span class="p">.</span><span class="n">collect</span><span class="p">();</span>

<span class="w">        </span><span class="n">results</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">optimize_memory_usage</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 清理过期缓存</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">retain</span><span class="p">(</span><span class="o">|</span><span class="n">_</span><span class="p">,</span><span class="w"> </span><span class="n">cached_vote</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">cached_vote</span><span class="p">.</span><span class="n">is_valid</span><span class="p">()</span>
<span class="w">        </span><span class="p">});</span>

<span class="w">        </span><span class="c1">// 压缩内存</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">cache</span><span class="p">.</span><span class="n">shrink_to_fit</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="62">6.2 缓存策略</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">CacheManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">lru_cache</span>: <span class="nc">LruCache</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">CachedData</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">ttl_cache</span>: <span class="nc">TtlCache</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">CachedData</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">CacheManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_or_set</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">ttl</span>: <span class="nc">Duration</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="n">CachedData</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 先检查LRU缓存</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">lru_cache</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">data</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 检查TTL缓存</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ttl_cache</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">lru_cache</span><span class="p">.</span><span class="n">put</span><span class="p">(</span><span class="n">key</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">data</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">data</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">None</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="7">7. 安全机制详细设计</h2>
<h3 id="71">7.1 防重放攻击</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ReplayProtection</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">used_nonces</span>: <span class="nc">HashSet</span><span class="o">&lt;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">]</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="n">timestamp_window</span>: <span class="nc">Duration</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">ReplayProtection</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">verify_nonce</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">nonce</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span><span class="w"> </span><span class="n">timestamp</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">bool</span> <span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">current_time</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SystemTime</span>::<span class="n">now</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">duration_since</span><span class="p">(</span><span class="n">UNIX_EPOCH</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">as_secs</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 检查时间窗口</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">current_time</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">timestamp</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">).</span><span class="n">abs</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">timestamp_window</span><span class="p">.</span><span class="n">as_secs</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 检查nonce是否已使用</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">used_nonces</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="n">nonce</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="kc">false</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">used_nonces</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="o">*</span><span class="n">nonce</span><span class="p">);</span>
<span class="w">        </span><span class="kc">true</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="72">7.2 输入验证</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">InputValidator</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">max_vote_options</span>: <span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="n">max_title_length</span>: <span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="n">max_description_length</span>: <span class="kt">usize</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">InputValidator</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">validate_vote_options</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">options</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="nb">String</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">ValidationError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ValidationError</span>::<span class="n">TooFewOptions</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">options</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">max_vote_options</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ValidationError</span>::<span class="n">TooManyOptions</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">option</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">options</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">option</span><span class="p">.</span><span class="n">trim</span><span class="p">().</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ValidationError</span>::<span class="n">EmptyOption</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">validate_vote_title</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">title</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">ValidationError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">title</span><span class="p">.</span><span class="n">trim</span><span class="p">().</span><span class="n">is_empty</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ValidationError</span>::<span class="n">EmptyTitle</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">title</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">max_title_length</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">ValidationError</span>::<span class="n">TitleTooLong</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="8">8. 测试策略详细设计</h2>
<h3 id="81">8.1 单元测试</h3>
<div class="codehilite"><pre><span></span><code><span class="cp">#[cfg(test)]</span>
<span class="k">mod</span> <span class="nn">tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="o">*</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">test_bit_commitment_creation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">message</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">b&quot;test vote&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="p">(</span><span class="n">commitment</span><span class="p">,</span><span class="w"> </span><span class="n">randomness</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">BitCommitment</span>::<span class="n">new</span><span class="p">(</span><span class="n">message</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">commitment</span><span class="p">.</span><span class="n">verify</span><span class="p">(</span><span class="n">message</span><span class="p">));</span>
<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="o">!</span><span class="n">commitment</span><span class="p">.</span><span class="n">verify</span><span class="p">(</span><span class="s">b&quot;wrong message&quot;</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">test_decision_vote_lifecycle_transitions</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">decision_vote</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DecisionVote</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">id</span>: <span class="s">&quot;test&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">status</span>: <span class="nc">DecisionVoteStatus</span>::<span class="n">Created</span><span class="p">,</span>
<span class="w">            </span><span class="c1">// ... other fields</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">decision_vote</span><span class="p">.</span><span class="n">status</span><span class="p">.</span><span class="n">can_transition_to</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DecisionVoteStatus</span>::<span class="n">Active</span><span class="p">));</span>
<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="o">!</span><span class="n">decision_vote</span><span class="p">.</span><span class="n">status</span><span class="p">.</span><span class="n">can_transition_to</span><span class="p">(</span><span class="o">&amp;</span><span class="n">DecisionVoteStatus</span>::<span class="n">Tallied</span><span class="p">));</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[tokio::test]</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_blockchain_interface</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">interface</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">InjectiveInterface</span>::<span class="n">new</span><span class="p">(</span><span class="cm">/* config */</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">vote_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;test_vote&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">[</span><span class="mi">0</span><span class="k">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">];</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">interface</span><span class="p">.</span><span class="n">submit_commitment</span><span class="p">(</span><span class="n">vote_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">commitment</span><span class="p">).</span><span class="k">await</span><span class="p">;</span>
<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">is_ok</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="82">8.2 集成测试</h3>
<div class="codehilite"><pre><span></span><code><span class="cp">#[cfg(test)]</span>
<span class="k">mod</span> <span class="nn">integration_tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="o">*</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#[tokio::test]</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_complete_decision_voting_flow</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 创建决策投票</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">sdk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DecisionVotingSDK</span>::<span class="n">new</span><span class="p">(</span><span class="cm">/* config */</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdk</span><span class="p">.</span><span class="n">create_decision_vote</span><span class="p">(</span><span class="n">DecisionVoteOptions</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">title</span>: <span class="s">&quot;Test Decision Vote&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">description</span>: <span class="s">&quot;Test Description&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">min_preference</span>: <span class="o">-</span><span class="mi">10</span><span class="p">,</span>
<span class="w">            </span><span class="n">max_preference</span>: <span class="mi">10</span><span class="p">,</span>
<span class="w">            </span><span class="n">start_time</span>: <span class="nc">SystemTime</span>::<span class="n">now</span><span class="p">().</span><span class="n">duration_since</span><span class="p">(</span><span class="n">UNIX_EPOCH</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">as_secs</span><span class="p">(),</span>
<span class="w">            </span><span class="n">end_time</span>: <span class="nc">SystemTime</span>::<span class="n">now</span><span class="p">().</span><span class="n">duration_since</span><span class="p">(</span><span class="n">UNIX_EPOCH</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">as_secs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3600</span><span class="p">,</span>
<span class="w">        </span><span class="p">}).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 提交偏好投票</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">tx_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdk</span><span class="p">.</span><span class="n">submit_preference_vote</span><span class="p">(</span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="o">!</span><span class="n">tx_hash</span><span class="p">.</span><span class="n">is_empty</span><span class="p">());</span>

<span class="w">        </span><span class="c1">// 揭示偏好投票</span>
<span class="w">        </span><span class="n">sdk</span><span class="p">.</span><span class="n">reveal_preference_vote</span><span class="p">(</span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 获取决策结果</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdk</span><span class="p">.</span><span class="n">get_decision_result</span><span class="p">(</span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">is_verified</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">preference_sum</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">average_preference</span><span class="p">,</span><span class="w"> </span><span class="mf">5.0</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[tokio::test]</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_complete_lottery_flow</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 创建抽奖活动</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">sdk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DecisionVotingSDK</span>::<span class="n">new</span><span class="p">(</span><span class="cm">/* config */</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">lottery_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdk</span><span class="p">.</span><span class="n">create_lottery</span><span class="p">(</span><span class="n">LotteryOptions</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">title</span>: <span class="s">&quot;Test Lottery&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">description</span>: <span class="s">&quot;Test Lottery Description&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">min_preference</span>: <span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="n">max_preference</span>: <span class="mi">100</span><span class="p">,</span>
<span class="w">            </span><span class="n">start_time</span>: <span class="nc">SystemTime</span>::<span class="n">now</span><span class="p">().</span><span class="n">duration_since</span><span class="p">(</span><span class="n">UNIX_EPOCH</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">as_secs</span><span class="p">(),</span>
<span class="w">            </span><span class="n">end_time</span>: <span class="nc">SystemTime</span>::<span class="n">now</span><span class="p">().</span><span class="n">duration_since</span><span class="p">(</span><span class="n">UNIX_EPOCH</span><span class="p">).</span><span class="n">unwrap</span><span class="p">().</span><span class="n">as_secs</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3600</span><span class="p">,</span>
<span class="w">            </span><span class="n">is_lottery</span>: <span class="nc">true</span><span class="p">,</span>
<span class="w">            </span><span class="n">prize_description</span>: <span class="s">&quot;Test Prize&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="p">}).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 多个参与者提交随机数</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">random_numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">9</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">];</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">random_num</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">random_numbers</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">enumerate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">tx_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdk</span><span class="p">.</span><span class="n">submit_preference_vote</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lottery_id</span><span class="p">,</span><span class="w"> </span><span class="n">random_num</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">            </span><span class="fm">assert!</span><span class="p">(</span><span class="o">!</span><span class="n">tx_hash</span><span class="p">.</span><span class="n">is_empty</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 揭示所有随机数</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">_</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">0</span><span class="o">..</span><span class="n">random_numbers</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sdk</span><span class="p">.</span><span class="n">reveal_preference_vote</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lottery_id</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 获取抽奖结果</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdk</span><span class="p">.</span><span class="n">get_lottery_result</span><span class="p">(</span><span class="o">&amp;</span><span class="n">lottery_id</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">is_verified</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">total_participants</span><span class="p">,</span><span class="w"> </span><span class="mi">5</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">random_sum</span><span class="p">,</span><span class="w"> </span><span class="mi">22</span><span class="p">);</span><span class="w"> </span><span class="c1">// 3+7+2+9+1 = 22</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">winner_index</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span><span class="w"> </span><span class="c1">// 22 % 5 = 2</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[tokio::test]</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_iagent_automation_flow</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 测试iAgent自动化投票流程</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">sdk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DecisionVotingSDK</span>::<span class="n">new</span><span class="p">(</span><span class="cm">/* config */</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 创建自动化投票配置</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">automation_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AutomatedVoteConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">title</span>: <span class="s">&quot;Automated Test Vote&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">message</span>: <span class="nc">b</span><span class="s">&quot;automated test message&quot;</span><span class="p">.</span><span class="n">to_vec</span><span class="p">(),</span>
<span class="w">            </span><span class="n">commitment_strategy</span>: <span class="nc">CommitmentStrategy</span>::<span class="n">Immediate</span><span class="p">,</span>
<span class="w">            </span><span class="n">reveal_conditions</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[</span>
<span class="w">                </span><span class="n">RevealCondition</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">condition_type</span>: <span class="nc">RevealConditionType</span>::<span class="n">TimeBased</span><span class="p">,</span>
<span class="w">                    </span><span class="n">threshold</span>: <span class="nb">Some</span><span class="p">(</span><span class="mi">3600</span><span class="p">),</span><span class="w"> </span><span class="c1">// 1小时后自动揭示</span>
<span class="w">                    </span><span class="n">time_trigger</span>: <span class="nb">Some</span><span class="p">(</span><span class="mi">3600</span><span class="p">),</span>
<span class="w">                    </span><span class="n">participant_count</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="n">reveal_triggers</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[</span>
<span class="w">                </span><span class="n">RevealTrigger</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">trigger_type</span>: <span class="nc">TriggerType</span>::<span class="n">TimeBased</span><span class="p">,</span>
<span class="w">                    </span><span class="n">condition</span>: <span class="nc">TriggerCondition</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">threshold</span>: <span class="nb">Some</span><span class="p">(</span><span class="mi">3600</span><span class="p">),</span>
<span class="w">                        </span><span class="n">time_window</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_secs</span><span class="p">(</span><span class="mi">3600</span><span class="p">)),</span>
<span class="w">                        </span><span class="n">participant_min</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">                        </span><span class="n">completion_percentage</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">                    </span><span class="p">},</span>
<span class="w">                    </span><span class="n">action</span>: <span class="nc">RevealAction</span>::<span class="n">RevealAll</span><span class="p">,</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// 设置自动化投票</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">vote_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdk</span><span class="p">.</span><span class="n">setup_automated_voting</span><span class="p">(</span><span class="n">automation_config</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="o">!</span><span class="n">vote_id</span><span class="p">.</span><span class="n">is_empty</span><span class="p">());</span>

<span class="w">        </span><span class="c1">// 验证自动化状态</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">automation_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdk</span><span class="p">.</span><span class="n">get_automation_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vote_id</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">automation_status</span><span class="p">.</span><span class="n">is_automated</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">automation_status</span><span class="p">.</span><span class="n">automation_status</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;active&quot;</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 等待自动化执行</span>
<span class="w">        </span><span class="n">tokio</span>::<span class="n">time</span>::<span class="n">sleep</span><span class="p">(</span><span class="n">Duration</span>::<span class="n">from_secs</span><span class="p">(</span><span class="mi">2</span><span class="p">)).</span><span class="k">await</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 检查自动化执行结果</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">updated_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdk</span><span class="p">.</span><span class="n">get_automation_status</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vote_id</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">updated_status</span><span class="p">.</span><span class="n">last_automation_run</span><span class="p">.</span><span class="n">is_some</span><span class="p">());</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[tokio::test]</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_iagent_batch_processing</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 测试iAgent批量处理功能</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">sdk</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">DecisionVotingSDK</span>::<span class="n">new</span><span class="p">(</span><span class="cm">/* config */</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 创建批量处理配置</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">batch_config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AutomatedVoteConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">title</span>: <span class="s">&quot;Batch Test Vote&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">message</span>: <span class="nc">b</span><span class="s">&quot;batch test message&quot;</span><span class="p">.</span><span class="n">to_vec</span><span class="p">(),</span>
<span class="w">            </span><span class="n">commitment_strategy</span>: <span class="nc">CommitmentStrategy</span>::<span class="n">Batch</span><span class="p">,</span>
<span class="w">            </span><span class="n">reveal_conditions</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[</span>
<span class="w">                </span><span class="n">RevealCondition</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">condition_type</span>: <span class="nc">RevealConditionType</span>::<span class="n">ParticipantCount</span><span class="p">,</span>
<span class="w">                    </span><span class="n">threshold</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">                    </span><span class="n">time_trigger</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">                    </span><span class="n">participant_count</span>: <span class="nb">Some</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span><span class="w"> </span><span class="c1">// 达到10个参与者时自动揭示</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">            </span><span class="n">reveal_triggers</span>: <span class="nc">vec</span><span class="o">!</span><span class="p">[</span>
<span class="w">                </span><span class="n">RevealTrigger</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">trigger_type</span>: <span class="nc">TriggerType</span>::<span class="n">ParticipantCount</span><span class="p">,</span>
<span class="w">                    </span><span class="n">condition</span>: <span class="nc">TriggerCondition</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="n">threshold</span>: <span class="nb">Some</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
<span class="w">                        </span><span class="n">time_window</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">                        </span><span class="n">participant_min</span>: <span class="nb">Some</span><span class="p">(</span><span class="mi">10</span><span class="p">),</span>
<span class="w">                        </span><span class="n">completion_percentage</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">                    </span><span class="p">},</span>
<span class="w">                    </span><span class="n">action</span>: <span class="nc">RevealAction</span>::<span class="n">RevealBatch</span><span class="p">,</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">],</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// 设置批量自动化投票</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">vote_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdk</span><span class="p">.</span><span class="n">setup_automated_voting</span><span class="p">(</span><span class="n">batch_config</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 模拟批量提交承诺</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">commitments</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="s">&quot;commitment1&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;commitment2&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;commitment3&quot;</span><span class="p">];</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">result</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdk</span><span class="p">.</span><span class="n">execute_automated_commitment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vote_id</span><span class="p">,</span><span class="w"> </span><span class="n">commitments</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">result</span><span class="p">.</span><span class="n">is_ok</span><span class="p">());</span>

<span class="w">        </span><span class="c1">// 验证批量队列状态</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">queue_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">sdk</span><span class="p">.</span><span class="n">get_automation_queue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vote_id</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">queue_status</span><span class="p">.</span><span class="n">batch_queue</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="9">9. 多目标选择模块详细设计</h2>
<h3 id="91">9.1 多目标选择核心数据结构</h3>
<div class="codehilite"><pre><span></span><code><span class="k">use</span><span class="w"> </span><span class="n">sha2</span>::<span class="p">{</span><span class="n">Sha256</span><span class="p">,</span><span class="w"> </span><span class="n">Digest</span><span class="p">};</span>
<span class="k">use</span><span class="w"> </span><span class="n">serde</span>::<span class="p">{</span><span class="n">Deserialize</span><span class="p">,</span><span class="w"> </span><span class="n">Serialize</span><span class="p">};</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MultiTargetSession</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">session_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">target_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">status</span>: <span class="nc">SessionStatus</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">created_at</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_deadline</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveal_deadline</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participants</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">ParticipantInfo</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitments</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">CommitmentData</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveals</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">RevealData</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winners</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ParticipantInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_token_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">agent_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">status</span>: <span class="nc">ParticipantStatus</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">values</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_hash</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveal_hash</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">SessionStatus</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Created</span><span class="p">,</span>
<span class="w">    </span><span class="n">CommitmentPhase</span><span class="p">,</span>
<span class="w">    </span><span class="n">RevealPhase</span><span class="p">,</span>
<span class="w">    </span><span class="n">Calculating</span><span class="p">,</span>
<span class="w">    </span><span class="n">Completed</span><span class="p">,</span>
<span class="w">    </span><span class="n">Failed</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">ParticipantStatus</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Registered</span><span class="p">,</span>
<span class="w">    </span><span class="n">Committed</span><span class="p">,</span>
<span class="w">    </span><span class="n">Revealed</span><span class="p">,</span>
<span class="w">    </span><span class="n">Disqualified</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">CommitmentData</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_hash</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">timestamp</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">ipfs_hash</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">blockchain_tx</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone, Serialize, Deserialize)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">RevealData</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_hash</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">values</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">timestamp</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">ipfs_hash</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">blockchain_tx</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="92">9.2 多目标选择算法实现</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MultiTargetWinnerCalculator</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">algorithm</span>: <span class="nc">MultiTargetAlgorithm</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">verification_enabled</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">MultiTargetAlgorithm</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Standard</span><span class="p">,</span><span class="w">       </span><span class="c1">// 标准算法</span>
<span class="w">    </span><span class="n">Weighted</span><span class="p">,</span><span class="w">       </span><span class="c1">// 加权算法</span>
<span class="w">    </span><span class="n">Balanced</span><span class="p">,</span><span class="w">       </span><span class="c1">// 平衡算法</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">MultiTargetWinnerCalculator</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span><span class="n">algorithm</span>: <span class="nc">MultiTargetAlgorithm</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">algorithm</span><span class="p">,</span>
<span class="w">            </span><span class="n">verification_enabled</span>: <span class="nc">true</span><span class="p">,</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">calculate_winners</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">session</span>: <span class="kp">&amp;</span><span class="nc">MultiTargetSession</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">SessionStatus</span>::<span class="n">RevealPhase</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Session not ready for winner calculation&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">reveals</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">participant_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Not all participants have revealed their values&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">participant_values</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">participants</span>
<span class="w">            </span><span class="p">.</span><span class="n">iter</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">filter_map</span><span class="p">(</span><span class="o">|</span><span class="n">p</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">reveal</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">reveals</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">p</span><span class="p">.</span><span class="n">participant_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nb">Some</span><span class="p">(</span><span class="n">reveal</span><span class="p">.</span><span class="n">values</span><span class="p">.</span><span class="n">clone</span><span class="p">())</span>
<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="nb">None</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">            </span><span class="p">.</span><span class="n">collect</span><span class="p">();</span>

<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">algorithm</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">MultiTargetAlgorithm</span>::<span class="n">Standard</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">calculate_standard_winners</span><span class="p">(</span><span class="o">&amp;</span><span class="n">participant_values</span><span class="p">,</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">target_count</span><span class="p">,</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">participant_count</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">MultiTargetAlgorithm</span>::<span class="n">Weighted</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">calculate_weighted_winners</span><span class="p">(</span><span class="o">&amp;</span><span class="n">participant_values</span><span class="p">,</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">target_count</span><span class="p">,</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">participant_count</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">MultiTargetAlgorithm</span>::<span class="n">Balanced</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">calculate_balanced_winners</span><span class="p">(</span><span class="o">&amp;</span><span class="n">participant_values</span><span class="p">,</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">target_count</span><span class="p">,</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">participant_count</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">calculate_standard_winners</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_values</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="p">],</span>
<span class="w">        </span><span class="n">target_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_count</span>: <span class="kt">u32</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 计算第一个中奖序号（基准序号）</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">first_winner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">calculate_base_winner</span><span class="p">(</span><span class="n">participant_values</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">participant_count</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="n">winners</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">first_winner</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 计算后续中奖序号（偏移序号）</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="mi">1</span><span class="o">..</span><span class="n">target_count</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">winner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">calculate_offset_winner</span><span class="p">(</span>
<span class="w">                </span><span class="n">participant_values</span><span class="p">,</span>
<span class="w">                </span><span class="n">j</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">,</span>
<span class="w">                </span><span class="n">participant_count</span><span class="p">,</span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">winners</span>
<span class="w">            </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="n">winners</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">winner</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">calculate_base_winner</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_values</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="p">],</span>
<span class="w">        </span><span class="n">value_index</span>: <span class="kt">usize</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_count</span>: <span class="kt">u32</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">sum</span>: <span class="kt">i64</span> <span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">participant_values</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">value_index</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">values</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">sum</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">values</span><span class="p">[</span><span class="n">value_index</span><span class="p">];</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 处理负数情况，确保结果在1到n范围内</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">normalized_sum</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">((</span><span class="n">sum</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">participant_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">participant_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">participant_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">winner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">normalized_sum</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">winner</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">calculate_offset_winner</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_values</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="p">],</span>
<span class="w">        </span><span class="n">value_index</span>: <span class="kt">usize</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">        </span><span class="n">existing_winners</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u32</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 计算偏移量</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">calculate_base_winner</span><span class="p">(</span><span class="n">participant_values</span><span class="p">,</span><span class="w"> </span><span class="n">value_index</span><span class="p">,</span><span class="w"> </span><span class="n">participant_count</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 计算临时序号</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">last_winner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">existing_winners</span><span class="p">.</span><span class="n">last</span><span class="p">().</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">temp_winner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">last_winner</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">participant_count</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">temp_winner</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">temp_winner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">participant_count</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 调整确保唯一性</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">final_winner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">temp_winner</span><span class="p">;</span>
<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="n">existing_winners</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">final_winner</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">final_winner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">final_winner</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">participant_count</span><span class="p">)</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">final_winner</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">calculate_weighted_winners</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_values</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="p">],</span>
<span class="w">        </span><span class="n">target_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_count</span>: <span class="kt">u32</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 加权算法实现</span>
<span class="w">        </span><span class="c1">// 根据参与者的历史表现或其他权重因素调整选择概率</span>
<span class="w">        </span><span class="fm">unimplemented!</span><span class="p">(</span><span class="s">&quot;Weighted algorithm not yet implemented&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">calculate_balanced_winners</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_values</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="p">],</span>
<span class="w">        </span><span class="n">target_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_count</span>: <span class="kt">u32</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 平衡算法实现</span>
<span class="w">        </span><span class="c1">// 确保不同参与者群体都有机会中奖</span>
<span class="w">        </span><span class="fm">unimplemented!</span><span class="p">(</span><span class="s">&quot;Balanced algorithm not yet implemented&quot;</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="93-iagent">9.3 多目标选择iAgent实现</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MultiTargetAgent</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">agent_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">config</span>: <span class="nc">AgentConfig</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_manager</span>: <span class="nc">CommitmentManager</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveal_manager</span>: <span class="nc">RevealManager</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winner_calculator</span>: <span class="nc">WinnerCalculator</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">ipfs_client</span>: <span class="nc">IpfsClient</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">blockchain_client</span>: <span class="nc">BlockchainClient</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">MultiTargetAgent</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">(</span>
<span class="w">        </span><span class="n">agent_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">        </span><span class="n">config</span>: <span class="nc">AgentConfig</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">agent_id</span><span class="p">,</span>
<span class="w">            </span><span class="n">participant_id</span><span class="p">,</span>
<span class="w">            </span><span class="n">config</span><span class="p">,</span>
<span class="w">            </span><span class="n">commitment_manager</span>: <span class="nc">CommitmentManager</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">reveal_manager</span>: <span class="nc">RevealManager</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">winner_calculator</span>: <span class="nc">WinnerCalculator</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ipfs_client</span>: <span class="nc">IpfsClient</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">blockchain_client</span>: <span class="nc">BlockchainClient</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">automated_commitment_cycle</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">values</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 1. 创建承诺</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">commitment_manager</span><span class="p">.</span><span class="n">create_commitment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">values</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 2. 存储到IPFS</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ipfs_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">store_commitment_to_ipfs</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commitment</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 3. 提交到区块链</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">tx_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">submit_commitment_to_blockchain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commitment</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 4. 记录操作日志</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">log_commitment_operation</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commitment</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">ipfs_hash</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tx_hash</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">commitment</span><span class="p">.</span><span class="n">commitment_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">automated_reveal_cycle</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">commitment_id</span>: <span class="kp">&amp;</span><span class="kt">str</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 1. 获取原始值</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_original_values</span><span class="p">(</span><span class="n">commitment_id</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 2. 执行揭示</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">reveal_data</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">reveal_manager</span><span class="p">.</span><span class="n">create_reveal_data</span><span class="p">(</span><span class="n">commitment_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">values</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 3. 提交到区块链</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">tx_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">submit_reveal_to_blockchain</span><span class="p">(</span><span class="o">&amp;</span><span class="n">reveal_data</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 4. 更新IPFS元数据</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">update_ipfs_metadata</span><span class="p">(</span><span class="n">commitment_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">reveal_data</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 5. 记录操作日志</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">log_reveal_operation</span><span class="p">(</span><span class="n">commitment_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">tx_hash</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">store_commitment_to_ipfs</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">commitment</span>: <span class="kp">&amp;</span><span class="nc">CommitmentData</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment_json</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">serde_json</span>::<span class="n">to_string</span><span class="p">(</span><span class="n">commitment</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">ipfs_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">ipfs_client</span><span class="p">.</span><span class="n">add_content</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commitment_json</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">ipfs_hash</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">submit_commitment_to_blockchain</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">commitment</span>: <span class="kp">&amp;</span><span class="nc">CommitmentData</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">tx_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">blockchain_client</span><span class="p">.</span><span class="n">submit_commitment</span><span class="p">(</span><span class="n">commitment</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">tx_hash</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">log_commitment_operation</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">commitment</span>: <span class="kp">&amp;</span><span class="nc">CommitmentData</span><span class="p">,</span>
<span class="w">        </span><span class="n">ipfs_hash</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">tx_hash</span>: <span class="kp">&amp;</span><span class="kt">str</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 记录承诺操作的详细日志</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">log_entry</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LogEntry</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">timestamp</span>: <span class="nc">std</span>::<span class="n">time</span>::<span class="n">SystemTime</span>::<span class="n">now</span><span class="p">()</span>
<span class="w">                </span><span class="p">.</span><span class="n">duration_since</span><span class="p">(</span><span class="n">std</span>::<span class="n">time</span>::<span class="n">UNIX_EPOCH</span><span class="p">)</span><span class="o">?</span>
<span class="w">                </span><span class="p">.</span><span class="n">as_secs</span><span class="p">(),</span>
<span class="w">            </span><span class="n">operation</span>: <span class="s">&quot;commitment&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">participant_id</span>: <span class="nc">self</span><span class="p">.</span><span class="n">participant_id</span><span class="p">,</span>
<span class="w">            </span><span class="n">commitment_id</span>: <span class="nc">commitment</span><span class="p">.</span><span class="n">commitment_hash</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">ipfs_hash</span>: <span class="nc">ipfs_hash</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">blockchain_tx</span>: <span class="nc">tx_hash</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">status</span>: <span class="s">&quot;success&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">log_manager</span><span class="p">.</span><span class="n">add_log_entry</span><span class="p">(</span><span class="n">log_entry</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="94">9.4 多目标选择会话管理</h3>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">MultiTargetSessionManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">sessions</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">MultiTargetSession</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">session_configs</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">SessionConfig</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winner_calculator</span>: <span class="nc">MultiTargetWinnerCalculator</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">MultiTargetSessionManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">new</span><span class="p">()</span><span class="w"> </span>-&gt; <span class="nc">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">Self</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">sessions</span>: <span class="nc">HashMap</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">session_configs</span>: <span class="nc">HashMap</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">winner_calculator</span>: <span class="nc">MultiTargetWinnerCalculator</span>::<span class="n">new</span><span class="p">(</span><span class="n">MultiTargetAlgorithm</span>::<span class="n">Standard</span><span class="p">),</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">create_session</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">config</span>: <span class="nc">SessionConfig</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">session_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_session_id</span><span class="p">();</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">session</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MultiTargetSession</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">session_id</span>: <span class="nc">session_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">participant_count</span>: <span class="nc">config</span><span class="p">.</span><span class="n">participant_count</span><span class="p">,</span>
<span class="w">            </span><span class="n">target_count</span>: <span class="nc">config</span><span class="p">.</span><span class="n">target_count</span><span class="p">,</span>
<span class="w">            </span><span class="n">status</span>: <span class="nc">SessionStatus</span>::<span class="n">Created</span><span class="p">,</span>
<span class="w">            </span><span class="n">created_at</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">            </span><span class="n">commitment_deadline</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">commitment_duration</span><span class="p">,</span>
<span class="w">            </span><span class="n">reveal_deadline</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">()</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">commitment_duration</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">config</span><span class="p">.</span><span class="n">reveal_duration</span><span class="p">,</span>
<span class="w">            </span><span class="n">participants</span>: <span class="nb">Vec</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">commitments</span>: <span class="nc">HashMap</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">reveals</span>: <span class="nc">HashMap</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">            </span><span class="n">winners</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">session_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">session</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">session_configs</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">session_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">config</span><span class="p">);</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_participant</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">session_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant</span>: <span class="nc">ParticipantInfo</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">participants</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">participant_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">session</span><span class="p">.</span><span class="n">participants</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">participant</span><span class="p">);</span>

<span class="w">                </span><span class="c1">// 检查是否达到参与者数量要求</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">participants</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">participant_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">session</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SessionStatus</span>::<span class="n">CommitmentPhase</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Session is full&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Session not found&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">process_commitment</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">session_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">        </span><span class="n">commitment</span>: <span class="nc">CommitmentData</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SessionStatus</span>::<span class="n">CommitmentPhase</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">session</span><span class="p">.</span><span class="n">commitments</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">participant_id</span><span class="p">,</span><span class="w"> </span><span class="n">commitment</span><span class="p">);</span>

<span class="w">                </span><span class="c1">// 更新参与者状态</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">participant</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">participants</span><span class="p">.</span><span class="n">iter_mut</span><span class="p">()</span>
<span class="w">                    </span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">p</span><span class="o">|</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">participant_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">participant_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">participant</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParticipantStatus</span>::<span class="n">Committed</span><span class="p">;</span>
<span class="w">                    </span><span class="n">participant</span><span class="p">.</span><span class="n">commitment_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">commitment</span><span class="p">.</span><span class="n">commitment_hash</span><span class="p">.</span><span class="n">clone</span><span class="p">());</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="c1">// 检查是否所有参与者都已提交承诺</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">commitments</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">participant_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">session</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SessionStatus</span>::<span class="n">RevealPhase</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Session not in commitment phase&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Session not found&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">process_reveal</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">session_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">        </span><span class="n">reveal</span>: <span class="nc">RevealData</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">sessions</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="n">session_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">SessionStatus</span>::<span class="n">RevealPhase</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="c1">// 验证承诺</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">commitment</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">commitments</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">participant_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">verify_commitment</span><span class="p">(</span><span class="n">commitment</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">reveal</span><span class="p">.</span><span class="n">values</span><span class="p">)</span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">                        </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Commitment verification failed&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="n">session</span><span class="p">.</span><span class="n">reveals</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">participant_id</span><span class="p">,</span><span class="w"> </span><span class="n">reveal</span><span class="p">);</span>

<span class="w">                </span><span class="c1">// 更新参与者状态</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">participant</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">participants</span><span class="p">.</span><span class="n">iter_mut</span><span class="p">()</span>
<span class="w">                    </span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">p</span><span class="o">|</span><span class="w"> </span><span class="n">p</span><span class="p">.</span><span class="n">participant_id</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">participant_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">participant</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParticipantStatus</span>::<span class="n">Revealed</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">                </span><span class="c1">// 检查是否所有参与者都已揭示</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">reveals</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">session</span><span class="p">.</span><span class="n">participant_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">session</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SessionStatus</span>::<span class="n">Calculating</span><span class="p">;</span>

<span class="w">                    </span><span class="c1">// 计算中奖者</span>
<span class="w">                    </span><span class="kd">let</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">winner_calculator</span><span class="p">.</span><span class="n">calculate_winners</span><span class="p">(</span><span class="n">session</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>
<span class="w">                    </span><span class="n">session</span><span class="p">.</span><span class="n">winners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">winners</span><span class="p">);</span>
<span class="w">                    </span><span class="n">session</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SessionStatus</span>::<span class="n">Completed</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Session not in reveal phase&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Session not found&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">verify_commitment</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">commitment</span>: <span class="kp">&amp;</span><span class="nc">CommitmentData</span><span class="p">,</span>
<span class="w">        </span><span class="n">values</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">i64</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="nb">Box</span><span class="o">&lt;</span><span class="k">dyn</span><span class="w"> </span><span class="n">std</span>::<span class="n">error</span>::<span class="n">Error</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 重新计算承诺哈希进行验证</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">hasher</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">Sha256</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">value</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">value</span><span class="p">.</span><span class="n">to_be_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commitment</span><span class="p">.</span><span class="n">participant_id</span><span class="p">.</span><span class="n">to_be_bytes</span><span class="p">());</span>
<span class="w">        </span><span class="n">hasher</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commitment</span><span class="p">.</span><span class="n">timestamp</span><span class="p">.</span><span class="n">to_be_bytes</span><span class="p">());</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">computed_hash</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">hasher</span><span class="p">.</span><span class="n">finalize</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">computed_hash_hex</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;{:x}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">computed_hash</span><span class="p">);</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">computed_hash_hex</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">commitment</span><span class="p">.</span><span class="n">commitment_hash</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">generate_session_id</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">String</span> <span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">rng</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span>::<span class="n">thread_rng</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">random_bytes</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">16</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rng</span><span class="p">.</span><span class="n">gen</span><span class="p">();</span>
<span class="w">        </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;session_{:x}&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">random_bytes</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">get_current_timestamp</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span>
<span class="w">        </span><span class="n">std</span>::<span class="n">time</span>::<span class="n">SystemTime</span>::<span class="n">now</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">duration_since</span><span class="p">(</span><span class="n">std</span>::<span class="n">time</span>::<span class="n">UNIX_EPOCH</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">as_secs</span><span class="p">()</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">SessionConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">target_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_duration</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveal_duration</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">algorithm</span>: <span class="nc">MultiTargetAlgorithm</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">auto_commit</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">auto_reveal</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LogEntry</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">timestamp</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">operation</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">ipfs_hash</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">blockchain_tx</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">status</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="95">9.5 多目标选择测试用例</h3>
<div class="codehilite"><pre><span></span><code><span class="cp">#[cfg(test)]</span>
<span class="k">mod</span> <span class="nn">multi_target_tests</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">use</span><span class="w"> </span><span class="k">super</span>::<span class="o">*</span><span class="p">;</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">test_winner_calculation</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">calculator</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MultiTargetWinnerCalculator</span>::<span class="n">new</span><span class="p">(</span><span class="n">MultiTargetAlgorithm</span>::<span class="n">Standard</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 模拟参与者数据：3个参与者，选择2个中奖者</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">participant_values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span>
<span class="w">            </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">],</span><span class="w">   </span><span class="c1">// 参与者1的选择值</span>
<span class="w">            </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">7</span><span class="p">],</span><span class="w">   </span><span class="c1">// 参与者2的选择值</span>
<span class="w">            </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">8</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">],</span><span class="w">   </span><span class="c1">// 参与者3的选择值</span>
<span class="w">        </span><span class="p">];</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculator</span><span class="p">.</span><span class="n">calculate_standard_winners</span><span class="p">(</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">participant_values</span><span class="p">,</span>
<span class="w">            </span><span class="mi">2</span><span class="p">,</span><span class="w">  </span><span class="c1">// 目标数量</span>
<span class="w">            </span><span class="mi">3</span><span class="w">   </span><span class="c1">// 参与者数量</span>
<span class="w">        </span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 验证结果</span>
<span class="w">        </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">winners</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">winners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">winners</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">winners</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">winners</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">3</span><span class="p">);</span>
<span class="w">        </span><span class="fm">assert_ne!</span><span class="p">(</span><span class="n">winners</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">winners</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span><span class="w"> </span><span class="c1">// 确保唯一性</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[test]</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">test_commitment_verification</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">session_manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MultiTargetSessionManager</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 创建测试承诺数据</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">CommitmentData</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">commitment_hash</span>: <span class="s">&quot;test_hash&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">participant_id</span>: <span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="n">timestamp</span>: <span class="mi">1234567890</span><span class="p">,</span>
<span class="w">            </span><span class="n">ipfs_hash</span>: <span class="s">&quot;ipfs_hash&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">blockchain_tx</span>: <span class="s">&quot;tx_hash&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">values</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">vec!</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="mi">8</span><span class="p">];</span>

<span class="w">        </span><span class="c1">// 验证承诺</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">is_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session_manager</span><span class="p">.</span><span class="n">verify_commitment</span><span class="p">(</span><span class="o">&amp;</span><span class="n">commitment</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">values</span><span class="p">).</span><span class="n">unwrap</span><span class="p">();</span>
<span class="w">        </span><span class="fm">assert!</span><span class="p">(</span><span class="n">is_valid</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="cp">#[tokio::test]</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">test_session_lifecycle</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">session_manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MultiTargetSessionManager</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 创建会话配置</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">config</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">SessionConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">participant_count</span>: <span class="mi">3</span><span class="p">,</span>
<span class="w">            </span><span class="n">target_count</span>: <span class="mi">2</span><span class="p">,</span>
<span class="w">            </span><span class="n">commitment_duration</span>: <span class="mi">3600</span><span class="p">,</span>
<span class="w">            </span><span class="n">reveal_duration</span>: <span class="mi">1800</span><span class="p">,</span>
<span class="w">            </span><span class="n">algorithm</span>: <span class="nc">MultiTargetAlgorithm</span>::<span class="n">Standard</span><span class="p">,</span>
<span class="w">            </span><span class="n">auto_commit</span>: <span class="nc">true</span><span class="p">,</span>
<span class="w">            </span><span class="n">auto_reveal</span>: <span class="nc">true</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="c1">// 创建会话</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">session_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session_manager</span><span class="p">.</span><span class="n">create_session</span><span class="p">(</span><span class="n">config</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 添加参与者</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">participant</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ParticipantInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">participant_id</span>: <span class="mi">1</span><span class="p">,</span>
<span class="w">            </span><span class="n">nft_token_id</span>: <span class="s">&quot;nft_1&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">agent_id</span>: <span class="s">&quot;agent_1&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">status</span>: <span class="nc">ParticipantStatus</span>::<span class="n">Registered</span><span class="p">,</span>
<span class="w">            </span><span class="n">values</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">            </span><span class="n">commitment_hash</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">            </span><span class="n">reveal_hash</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="n">session_manager</span><span class="p">.</span><span class="n">add_participant</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session_id</span><span class="p">,</span><span class="w"> </span><span class="n">participant</span><span class="p">).</span><span class="k">await</span><span class="p">.</span><span class="n">unwrap</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 验证会话状态</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">session</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">session_manager</span><span class="p">.</span><span class="n">sessions</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="n">session_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="fm">assert_eq!</span><span class="p">(</span><span class="n">session</span><span class="p">.</span><span class="n">participants</span><span class="p">.</span><span class="n">len</span><span class="p">(),</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h2 id="10">10. 部署配置详细设计</h2>
<h3 id="101-docker">10.1 Docker配置</h3>
<p>```</p>
<hr>
<p>最后更新：2025-08<br>
维护人：luckeedao 技术团队</p>
</body>
</html>