<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>概要设计说明书</title>
    <style>
        body {
            max-width: 860px;
            margin: 32px auto;
            padding: 0 16px;
            font-family: -apple-system, BlinkMacSystemFont, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", sans-serif;
            line-height: 1.6;
            color: #1f2937;
        }
        pre { background:#f8fafc; padding:12px; overflow:auto; border-radius:6px; }
        code { background:#f1f5f9; padding:2px 4px; border-radius:4px; }
        h1,h2,h3,h4,h5,h6 { line-height:1.25; }
        a { color:#2563eb; text-decoration:none; }
        a:hover { text-decoration:underline; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #e5e7eb; padding: 8px; }
        blockquote { margin: 0; padding-left: 1em; border-left: 4px solid #e5e7eb; color:#6b7280; }
    </style>
</head>
<body>
<p>﻿# 基于比特承诺模型的去中心化投票系统概要设计说明书</p>
<blockquote>
<p>用词规范：请参阅《<a href="项目术语表.html">项目术语表</a>》以确保术语统一。</p>
</blockquote>
<h2 id="1">1. 系统概述</h2>
<h3 id="11">1.1 设计目标</h3>
<p>构建一个高性能、安全、可扩展的去中心化决策投票系统，通过比特承诺协议实现隐私保护，利用区块链技术确保数据不可篡改，支持百万级决策人规模。系统确保决策结果不依赖任何个人或部分人，包含全体决策人的偏好汇总，任何一个人的偏好投票都会影响最终结果。</p>
<p>系统功能目标：
- 实现基于$LUCKEE代币持有量的权限控制
- <strong>实现通过NFT类型控制不同应用场景的机制</strong>
- <strong>实现NFT分发替代用户注册功能</strong>
- <strong>实现NFT全局状态变量控制比特承诺功能</strong>
- 实现多等级选择（多组多目标选择）系统
- 支持中奖序号的智能分配
- <strong>实现iAgent自动化承诺与揭示流程</strong>，确保用户设置后可以自动执行承诺与揭示操作
- 支持多种去中心化应用场景（抽奖、彩票、分配、治理等）
- 提供可扩展的应用场景框架和配置系统</p>
<h4 id="111">1.1.1 具体应用场景</h4>
<p>系统支持多种去中心化决策投票应用场景，这些应用场景通过使用者创建不同的NFT类型来进行控制。以下是几个典型示例：</p>
<p><strong>应用场景1：去中心化抽奖系统</strong>
系统支持去中心化抽奖应用，实现以下功能：
- <strong>NFT分发管理</strong>：通过分发抽奖NFT来管理参与者，替代传统的用户注册功能
- <strong>随机数提交</strong>：每个NFT持有者提交整数作为随机数，使用比特承诺保护隐私
- <strong>结果计算</strong>：累加所有随机数之和，对参与者总数取余得到抽奖结果
- <strong>结果验证</strong>：整个计算过程透明可验证，确保公平性
- <strong>防作弊机制</strong>：通过密码学技术防止参与者作弊或操纵结果
- <strong>多等级选择（多组多目标选择）</strong>：支持设置不同等级和每个等级的数量，等价多个 n 选 k 编排
- <strong>中奖序号管理</strong>：每个NFT拥有与投票相关的中奖序号</p>
<p><strong>应用场景2：去中心化彩票系统</strong>
系统支持去中心化彩票应用，实现以下功能：
- <strong>彩票NFT分发</strong>：用户获得彩票NFT，替代传统注册流程
- <strong>购买验证</strong>：验证彩票NFT的有效性和唯一性
- <strong>开奖机制</strong>：基于参与者偏好值生成公平的开奖号码
- <strong>中奖验证</strong>：自动验证中奖彩票并分配奖金
- <strong>奖金池管理</strong>：透明管理彩票奖金池和分配规则</p>
<p><strong>应用场景3：去中心化分配系统</strong>
系统支持去中心化资源分配应用，实现以下功能：
- <strong>资源分配NFT分发</strong>：参与者获得资源分配NFT
- <strong>偏好收集</strong>：收集参与者对资源的偏好表达
- <strong>分配算法</strong>：实现多种分配算法（匈牙利算法、拍卖算法等）
- <strong>结果验证</strong>：验证分配结果的公平性和最优性
- <strong>执行机制</strong>：自动执行分配结果并更新资源状态</p>
<p><strong>应用场景4：去中心化治理系统</strong>
系统支持去中心化治理投票应用，实现以下功能：
- <strong>治理NFT分发</strong>：参与者获得治理投票NFT
- <strong>提案管理</strong>：支持治理提案的创建、修改和投票
- <strong>投票机制</strong>：实现多种投票规则（简单多数、加权投票等）
- <strong>决策计算</strong>：基于投票偏好计算最终决策结果
- <strong>执行跟踪</strong>：跟踪决策的执行情况和效果评估
- <strong>治理历史</strong>：维护完整的治理决策历史记录</p>
<h3 id="12">1.2 设计原则</h3>
<ul>
<li><strong>隐私优先</strong>：决策人偏好投票内容对第三方不可见</li>
<li><strong>去中心化</strong>：避免单点故障，提高系统可靠性，确保决策结果不依赖任何个人或部分人</li>
<li><strong>偏好汇总</strong>：系统汇总全体决策人的偏好，任何一个人的投票都会影响最终结果</li>
<li><strong>透明计算</strong>：计算过程透明，可被所有人验证</li>
<li><strong>高性能</strong>：利用WebAssembly技术实现高效计算</li>
<li><strong>可验证性</strong>：所有操作可公开验证</li>
<li><strong>可扩展性</strong>：支持大规模决策人并发</li>
<li><strong>代币权限控制</strong>：基于代币持有量的权限管理</li>
<li><strong>NFT类型驱动</strong>：通过NFT类型控制不同的应用场景</li>
<li><strong>NFT分发替代注册</strong>：使用NFT分发替代传统用户注册功能</li>
<li><strong>NFT状态控制</strong>：通过NFT全局状态变量控制比特承诺功能</li>
<li><strong>自动化执行</strong>：通过iAgent实现承诺与揭示流程的自动化，减少人工干预</li>
</ul>
<h3 id="13">1.3 决策类型统一术语与分类</h3>
<ul>
<li>按结果基数：单目标决策 / 多目标决策</li>
<li>按资源属性：竞用性资源决策 / 非竞用性资源决策</li>
<li>通过NFT类型抽象承载以上类别，支持未来扩展。</li>
</ul>
<blockquote>
<p>关系补充：唯一中奖= n 选 1（多目标特例）；多等级选择=多个 n 选 k 的组合（定义为"多组多目标选择"）；单个 n 选 k 对应 1 组偏好值，多个 n 选 k 对应多组偏好值。</p>
</blockquote>
<h3 id="13_1">1.3 技术选型</h3>
<ul>
<li><strong>核心语言</strong>：Rust + WebAssembly</li>
<li><strong>区块链平台</strong>：Injective Protocol（高性能、低费用）</li>
<li><strong>智能合约</strong>：Rust (CosmWasm)</li>
<li><strong>密码学库</strong>：RustCrypto、sha2、rand</li>
<li><strong>存储方案</strong>：IPFS去中心化存储 + 链上哈希验证</li>
<li><strong>前端框架</strong>：React + TypeScript</li>
<li><strong>代币标准</strong>：CW20 (CosmWasm代币标准)</li>
<li><strong>NFT标准</strong>：CW721 (CosmWasm NFT标准)</li>
<li><strong>状态管理</strong>：NFT全局状态变量 + 智能合约状态管理</li>
</ul>
<h2 id="2">2. 系统架构</h2>
<h3 id="21">2.1 整体架构图</h3>
<div class="codehilite"><pre><span></span><code>┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   客户端SDK     │    │ WebAssembly服务器    │    │   区块链网络    │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │ 偏好投票    │ │◄──►│ │ 决策投票    │ │◄──►│ │ 智能合约    │ │
│ │ 验证工具    │ │    │ │ 生命周期    │ │    │ │ 承诺存储    │ │
│ │ 连接管理    │ │    │ │ 区块链接口  │ │    │ │ 结果记录    │ │
│ │ NFT类型管理 │ │    │ │ 代币验证    │ │    │ │ 代币合约    │ │
│ │ NFT分发管理 │ │    │ │ NFT类型管理 │ │    │ │ NFT合约     │ │
│ │ NFT状态管理 │ │    │ │ NFT状态管理 │ │    │ │ 状态管理合约 │ │
│ │ 抽奖等级    │ │    │ │ iAgent管理  │ │    │ │ 自动化合约  │ │
│ │ iAgent配置  │ │    │ │ 比特承诺    │ │    │ │ 比特承诺合约 │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
└─────────────────┘    └─────────────────┘    └─────────────────┘
         │                       │                       │
         │                       │                       │
         ▼                       ▼                       ▼
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   密码学核心    │    │   存储策略      │    │   去中心化存储  │
│                 │    │                 │    │                 │
│ ┌─────────────┐ │    │ ┌─────────────┐ │    │ ┌─────────────┐ │
│ │ 比特承诺    │ │    │ │ 链上优化    │ │    │ │ IPFS节点    │ │
│ │ 随机数生成  │ │    │ │ IPFS适配    │ │    │ │ 数据分片    │ │
│ │ 哈希函数    │ │    │ │ 完整性验证  │ │    │ │ 冗余备份    │ │
│ │ 中奖序号    │ │    │ │ NFT元数据   │ │    │ │ 元数据存储  │ │
│ │ NFT状态控制 │ │    │ │ NFT状态     │ │    │ │ 状态存储    │ │
│ │ iAgent自动化 │ │    │ │ 自动化配置  │ │    │ │ 自动化状态  │ │
│ └─────────────┘ │    │ └─────────────┘ │    │ └─────────────┘ │
└─────────────────┘    └─────────────────┘    └─────────────────┘
</code></pre></div>

<h3 id="22">2.2 分层架构</h3>
<ol>
<li><strong>表示层</strong>：客户端SDK、Web界面</li>
<li><strong>业务逻辑层</strong>：WebAssembly服务器、决策投票管理、代币验证、NFT类型管理、NFT状态管理</li>
<li><strong>数据访问层</strong>：区块链接口、存储适配器、代币合约接口、NFT状态接口</li>
<li><strong>基础设施层</strong>：密码学核心、网络通信、代币标准、NFT状态标准</li>
</ol>
<h3 id="221-src">2.2.1 源码目录结构（src）</h3>
<div class="codehilite"><pre><span></span><code>src/
  frontend/   # 前端：Web UI、SDK集成、钱包交互
  home/       # 主页与落地页：营销/入口与文档导航
  server/     # 服务器端：WASM服务、API网关、会话与状态编排
  contracts/  # 智能合约接口与绑定：CW20/CW721、投票/状态管理合约适配
  ipfs/       # 第三方IPFS适配：网关、存储适配器、完整性校验
  wasm/       # WebAssembly：高性能计算模块与生命周期管理
  sdk/        # 客户端/服务端SDK：TS/Rust SDK、签名与验证工具
</code></pre></div>

<p>设计 rationale：
- 与架构分层一一对应，便于职责清晰与团队协作。
- <code>server</code> 聚合对区块链与IPFS的编排，<code>contracts</code> 专注合约接口与消息/类型绑定。
- <code>wasm</code> 独立，确保计算密集型逻辑可复用、可测试与可替换。
- <code>sdk</code> 面向前后端统一的开发者体验，降低集成成本。
- <code>home</code> 与 <code>frontend</code> 分离，允许主页与产品前台独立上线、灰度与缓存策略。</p>
<h3 id="23-nft">2.3 统一NFT决策状态机（架构）</h3>
<p>状态：Draft → CommitOpen → CommitClosed → RevealOpen → Revealed → Tallied → Executed → Archived</p>
<ul>
<li>与时间参数、权限与NFT类型规则绑定；</li>
<li>各模块（承诺、揭示、计票、执行）通过状态机编排；</li>
<li>事件与审计在每次迁移时产生。</li>
</ul>
<h2 id="3">3. 模块设计</h2>
<h3 id="31-nft">3.1 NFT类型管理模块</h3>
<h4 id="311-nft">3.1.1 NFT类型定义和控制</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTTypeManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">registered_types</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">NFTTypeDefinition</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">type_validator</span>: <span class="nc">NFTTypeValidator</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">type_registry</span>: <span class="nc">NFTTypeRegistry</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTTypeDefinition</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span><span class="w">                    </span><span class="c1">// NFT类型标识</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_standard</span>: <span class="nb">String</span><span class="p">,</span><span class="w">                </span><span class="c1">// NFT标准（如CW721）</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">application_category</span>: <span class="nb">String</span><span class="p">,</span><span class="w">         </span><span class="c1">// 应用场景分类</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">metadata_schema</span>: <span class="nc">MetadataSchema</span><span class="p">,</span><span class="w">     </span><span class="c1">// 元数据模式</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">voting_rules</span>: <span class="nc">VotingRules</span><span class="p">,</span><span class="w">           </span><span class="c1">// 投票规则</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">lifecycle_hooks</span>: <span class="nc">LifecycleHooks</span><span class="p">,</span><span class="w">     </span><span class="c1">// 生命周期钩子</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">global_state_schema</span>: <span class="nc">StateSchema</span><span class="p">,</span><span class="w">    </span><span class="c1">// 全局状态模式</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">StateSchema</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state_variables</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">StateVariable</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 状态变量定义</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state_transitions</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">StateTransition</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 状态转换规则</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state_constraints</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">StateConstraint</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 状态约束条件</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">NFTTypeManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">create_nft_type</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">definition</span>: <span class="nc">NFTTypeDefinition</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 验证NFT类型定义</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">type_validator</span><span class="p">.</span><span class="n">validate_nft_type</span><span class="p">(</span><span class="o">&amp;</span><span class="n">definition</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 注册NFT类型</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">type_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_type_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">definition</span><span class="p">);</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">registered_types</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">type_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">definition</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 初始化NFT类型状态</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">initialize_nft_type_state</span><span class="p">(</span><span class="o">&amp;</span><span class="n">type_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">type_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_nft_type_config</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="kp">&amp;</span><span class="kt">str</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">NFTTypeDefinition</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">registered_types</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">nft_type</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">initialize_nft_type_state</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">type_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 初始化NFT类型的全局状态变量</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">state_manager</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">NFTStateManager</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="n">state_manager</span><span class="p">.</span><span class="n">initialize_type_state</span><span class="p">(</span><span class="n">type_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="31x-nft">3.1.x NFT决策接口（抽象）</h3>
<div class="codehilite"><pre><span></span><code>1) 提案/会话创建（引用NFT类型全局参数配置，设置时间参数、范围与阈值）
2) 偏好投票提交（承诺）
3) 隐私保护（比特承诺：commit/opening/salt）
4) 揭示与计票（单/多目标、竞/非竞）
5) 决策执行（按NFT类型：抽奖/彩票/分配/治理）
</code></pre></div>

<h4 id="312">3.1.2 应用场景控制</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ApplicationScenarioController</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_type_manager</span>: <span class="nc">NFTTypeManager</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">scenario_registry</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">ApplicationScenario</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">ApplicationScenario</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">scenario_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">scenario_config</span>: <span class="nc">ScenarioConfig</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">is_active</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">created_at</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">ApplicationScenarioController</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">create_scenario</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">config</span>: <span class="nc">ScenarioConfig</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 验证NFT类型是否存在</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">nft_type_manager</span><span class="p">.</span><span class="n">get_nft_type_config</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nft_type</span><span class="p">).</span><span class="n">is_none</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;NFT type not found&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">scenario_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_scenario_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">nft_type</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">scenario</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">ApplicationScenario</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">scenario_id</span>: <span class="nc">scenario_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">nft_type</span><span class="p">,</span>
<span class="w">            </span><span class="n">scenario_config</span>: <span class="nc">config</span><span class="p">,</span>
<span class="w">            </span><span class="n">is_active</span>: <span class="nc">true</span><span class="p">,</span>
<span class="w">            </span><span class="n">created_at</span>: <span class="nc">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">(),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">scenario_registry</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">scenario_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">scenario</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">scenario_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_scenario_by_nft_type</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="kp">&amp;</span><span class="kt">str</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">ApplicationScenario</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">scenario_registry</span><span class="p">.</span><span class="n">values</span><span class="p">()</span>
<span class="w">            </span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="o">|</span><span class="n">s</span><span class="o">|</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">nft_type</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">nft_type</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">s</span><span class="p">.</span><span class="n">is_active</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="32-nft">3.2 NFT分发管理模块</h3>
<h4 id="321-nft">3.2.1 NFT分发替代用户注册</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTDistributionManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">distribution_strategies</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">DistributionStrategy</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_factory</span>: <span class="nc">NFTFactory</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">eligibility_checker</span>: <span class="nc">EligibilityChecker</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">DistributionStrategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Direct</span><span class="p">,</span><span class="w">         </span><span class="c1">// 直接分发</span>
<span class="w">    </span><span class="n">Batch</span><span class="p">,</span><span class="w">          </span><span class="c1">// 批量分发</span>
<span class="w">    </span><span class="n">Conditional</span><span class="p">,</span><span class="w">    </span><span class="c1">// 条件分发</span>
<span class="w">    </span><span class="n">Lottery</span><span class="p">,</span><span class="w">        </span><span class="c1">// 抽奖分发</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">NFTDistributionManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">distribute_nft</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">user_address</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">strategy</span>: <span class="nc">DistributionStrategy</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 检查用户资格</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="bp">self</span><span class="p">.</span><span class="n">eligibility_checker</span><span class="p">.</span><span class="n">check_eligibility</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nft_type</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;User not eligible for this NFT type&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 根据策略分发NFT</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">nft_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">match</span><span class="w"> </span><span class="n">strategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">DistributionStrategy</span>::<span class="n">Direct</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">distribute_direct</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nft_type</span><span class="p">).</span><span class="k">await</span><span class="o">?</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">DistributionStrategy</span>::<span class="n">Batch</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">add_to_batch_distribution</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nft_type</span><span class="p">).</span><span class="k">await</span><span class="o">?</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">DistributionStrategy</span>::<span class="n">Conditional</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">distribute_conditional</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nft_type</span><span class="p">).</span><span class="k">await</span><span class="o">?</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">DistributionStrategy</span>::<span class="n">Lottery</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">distribute_lottery</span><span class="p">(</span><span class="o">&amp;</span><span class="n">user_address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">nft_type</span><span class="p">).</span><span class="k">await</span><span class="o">?</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">nft_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">distribute_direct</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">user_address</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="kp">&amp;</span><span class="kt">str</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 直接创建并分发NFT</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">nft</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">nft_factory</span><span class="p">.</span><span class="n">create_nft</span><span class="p">(</span><span class="n">user_address</span><span class="p">,</span><span class="w"> </span><span class="n">nft_type</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">nft</span><span class="p">.</span><span class="n">nft_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">add_to_batch_distribution</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">user_address</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="kp">&amp;</span><span class="kt">str</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 添加到批量分发队列</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">batch_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_or_create_batch</span><span class="p">(</span><span class="n">nft_type</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">add_user_to_batch</span><span class="p">(</span><span class="n">batch_id</span><span class="p">,</span><span class="w"> </span><span class="n">user_address</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">batch_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="322-nft">3.2.2 NFT资格验证</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">EligibilityChecker</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">token_verifier</span>: <span class="nc">TokenVerifier</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_ownership_checker</span>: <span class="nc">NFTOwnershipChecker</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">eligibility_rules</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">EligibilityRule</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">EligibilityRule</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">rule_type</span>: <span class="nc">RuleType</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">parameters</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">is_required</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">RuleType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">TokenHolding</span><span class="p">,</span><span class="w">       </span><span class="c1">// 代币持有量要求</span>
<span class="w">    </span><span class="n">NFTOwnership</span><span class="p">,</span><span class="w">       </span><span class="c1">// NFT所有权要求</span>
<span class="w">    </span><span class="n">TimeBased</span><span class="p">,</span><span class="w">          </span><span class="c1">// 时间要求</span>
<span class="w">    </span><span class="n">Geographic</span><span class="p">,</span><span class="w">          </span><span class="c1">// 地理要求</span>
<span class="w">    </span><span class="n">Custom</span><span class="p">,</span><span class="w">             </span><span class="c1">// 自定义要求</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">EligibilityChecker</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">check_eligibility</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">user_address</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="kp">&amp;</span><span class="kt">str</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">rules</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">eligibility_rules</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">nft_type</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="s">&quot;No eligibility rules found for NFT type&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">rule</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">rules</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">is_eligible</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">check_rule</span><span class="p">(</span><span class="n">user_address</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="n">rule</span><span class="p">.</span><span class="n">is_required</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">is_eligible</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="kc">false</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">check_rule</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">user_address</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">rule</span>: <span class="kp">&amp;</span><span class="nc">EligibilityRule</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">rule</span><span class="p">.</span><span class="n">rule_type</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">RuleType</span>::<span class="n">TokenHolding</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">check_token_holding_rule</span><span class="p">(</span><span class="n">user_address</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">).</span><span class="k">await</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">RuleType</span>::<span class="n">NFTOwnership</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">check_nft_ownership_rule</span><span class="p">(</span><span class="n">user_address</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">).</span><span class="k">await</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">RuleType</span>::<span class="n">TimeBased</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">check_time_based_rule</span><span class="p">(</span><span class="n">user_address</span><span class="p">,</span><span class="w"> </span><span class="n">rule</span><span class="p">).</span><span class="k">await</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="kc">true</span><span class="p">),</span><span class="w"> </span><span class="c1">// 其他规则类型</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="33-nft">3.3 NFT全局状态管理模块</h3>
<h4 id="331">3.3.1 全局状态变量管理</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTStateManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">global_states</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">GlobalState</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state_transitions</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">StateTransition</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state_validator</span>: <span class="nc">StateValidator</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">GlobalState</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state_variables</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">StateValue</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">current_state</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">last_updated</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">version</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">StateValue</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nb">String</span><span class="p">(</span><span class="nb">String</span><span class="p">),</span>
<span class="w">    </span><span class="n">Number</span><span class="p">(</span><span class="kt">i64</span><span class="p">),</span>
<span class="w">    </span><span class="n">Boolean</span><span class="p">(</span><span class="kt">bool</span><span class="p">),</span>
<span class="w">    </span><span class="n">Array</span><span class="p">(</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">StateValue</span><span class="o">&gt;</span><span class="p">),</span>
<span class="w">    </span><span class="n">Object</span><span class="p">(</span><span class="n">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">StateValue</span><span class="o">&gt;</span><span class="p">),</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">NFTStateManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">update_global_state</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">variable_name</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">new_value</span>: <span class="nc">StateValue</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">global_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">global_states</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="n">nft_type</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="s">&quot;Global state not found for NFT type&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 验证状态转换是否有效</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">transitions</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">state_transitions</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">nft_type</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">is_valid</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">validate_state_transition</span><span class="p">(</span>
<span class="w">                </span><span class="n">nft_type</span><span class="p">,</span>
<span class="w">                </span><span class="n">variable_name</span><span class="p">,</span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">global_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">variable_name</span><span class="p">),</span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">new_value</span><span class="p">,</span>
<span class="w">                </span><span class="n">transitions</span>
<span class="w">            </span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">is_valid</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;Invalid state transition&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 更新状态变量</span>
<span class="w">        </span><span class="n">global_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">variable_name</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span><span class="w"> </span><span class="n">new_value</span><span class="p">);</span>
<span class="w">        </span><span class="n">global_state</span><span class="p">.</span><span class="n">last_updated</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_current_timestamp</span><span class="p">();</span>
<span class="w">        </span><span class="n">global_state</span><span class="p">.</span><span class="n">version</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_global_state</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="kp">&amp;</span><span class="kt">str</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">GlobalState</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">global_states</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">nft_type</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">get_state_variable</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">variable_name</span>: <span class="kp">&amp;</span><span class="kt">str</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;&amp;</span><span class="n">StateValue</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">global_states</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">nft_type</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">and_then</span><span class="p">(</span><span class="o">|</span><span class="n">state</span><span class="o">|</span><span class="w"> </span><span class="n">state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">variable_name</span><span class="p">))</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="332">3.3.2 比特承诺状态控制</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">BitCommitmentStateController</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_state_manager</span>: <span class="nc">NFTStateManager</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_manager</span>: <span class="nc">BitCommitmentManager</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">state_hooks</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">StateHook</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">StateHook</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">hook_type</span>: <span class="nc">HookType</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">trigger_condition</span>: <span class="nc">TriggerCondition</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">action</span>: <span class="nc">HookAction</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">HookType</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">PreCommitment</span><span class="p">,</span><span class="w">      </span><span class="c1">// 承诺前钩子</span>
<span class="w">    </span><span class="n">PostCommitment</span><span class="p">,</span><span class="w">     </span><span class="c1">// 承诺后钩子</span>
<span class="w">    </span><span class="n">PreReveal</span><span class="p">,</span><span class="w">          </span><span class="c1">// 揭示前钩子</span>
<span class="w">    </span><span class="n">PostReveal</span><span class="p">,</span><span class="w">         </span><span class="c1">// 揭示后钩子</span>
<span class="w">    </span><span class="n">StateChange</span><span class="p">,</span><span class="w">        </span><span class="c1">// 状态变更钩子</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">BitCommitmentStateController</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_commitment_with_state_check</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">message</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">user_address</span>: <span class="kp">&amp;</span><span class="kt">str</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 检查NFT状态是否允许承诺</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">can_commit</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">check_commitment_state</span><span class="p">(</span><span class="n">nft_type</span><span class="p">,</span><span class="w"> </span><span class="n">user_address</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">can_commit</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="s">&quot;NFT state does not allow commitment&quot;</span><span class="p">.</span><span class="n">into</span><span class="p">());</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 执行承诺</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">commitment_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">commitment_manager</span><span class="p">.</span><span class="n">commit</span><span class="p">(</span><span class="n">message</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 更新NFT状态</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">update_commitment_state</span><span class="p">(</span><span class="n">nft_type</span><span class="p">,</span><span class="w"> </span><span class="n">user_address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">commitment_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 执行承诺后钩子</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">execute_hooks</span><span class="p">(</span><span class="n">nft_type</span><span class="p">,</span><span class="w"> </span><span class="n">HookType</span>::<span class="n">PostCommitment</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">commitment_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">commitment_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">check_commitment_state</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">user_address</span>: <span class="kp">&amp;</span><span class="kt">str</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">global_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">nft_state_manager</span><span class="p">.</span><span class="n">get_global_state</span><span class="p">(</span><span class="n">nft_type</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="s">&quot;Global state not found&quot;</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 检查承诺状态变量</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">commitment_state</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;commitment_enabled&quot;</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Boolean</span><span class="p">(</span><span class="n">enabled</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">commitment_state</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="o">*</span><span class="n">enabled</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="c1">// 检查用户特定状态</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">user_state</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">global_state</span><span class="p">.</span><span class="n">state_variables</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="o">&amp;</span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;user_{}_state&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user_address</span><span class="p">))</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">StateValue</span>::<span class="nb">String</span><span class="p">(</span><span class="n">state</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">user_state</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">return</span><span class="w"> </span><span class="nb">Ok</span><span class="p">(</span><span class="n">state</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="s">&quot;active&quot;</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="kc">true</span><span class="p">)</span><span class="w"> </span><span class="c1">// 默认允许</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">update_commitment_state</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_type</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">user_address</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span>
<span class="w">        </span><span class="n">commitment_id</span>: <span class="kp">&amp;</span><span class="kt">str</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 更新用户承诺状态</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">user_state_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="fm">format!</span><span class="p">(</span><span class="s">&quot;user_{}_commitment&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user_address</span><span class="p">);</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">user_state_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">StateValue</span>::<span class="nb">String</span><span class="p">(</span><span class="n">commitment_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">());</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">nft_state_manager</span><span class="p">.</span><span class="n">update_global_state</span><span class="p">(</span>
<span class="w">            </span><span class="n">nft_type</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">user_state_key</span><span class="p">,</span>
<span class="w">            </span><span class="n">user_state_value</span>
<span class="w">        </span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 更新全局承诺计数</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">count_key</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="s">&quot;total_commitments&quot;</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">current_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">nft_state_manager</span><span class="p">.</span><span class="n">get_state_variable</span><span class="p">(</span><span class="n">nft_type</span><span class="p">,</span><span class="w"> </span><span class="n">count_key</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">and_then</span><span class="p">(</span><span class="o">|</span><span class="n">v</span><span class="o">|</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="o">*</span><span class="n">n</span><span class="p">)</span><span class="w"> </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="nb">None</span><span class="w"> </span><span class="p">}</span>
<span class="w">            </span><span class="p">})</span>
<span class="w">            </span><span class="p">.</span><span class="n">unwrap_or</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">nft_state_manager</span><span class="p">.</span><span class="n">update_global_state</span><span class="p">(</span>
<span class="w">            </span><span class="n">nft_type</span><span class="p">,</span>
<span class="w">            </span><span class="n">count_key</span><span class="p">,</span>
<span class="w">            </span><span class="n">StateValue</span>::<span class="n">Number</span><span class="p">(</span><span class="n">current_count</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">        </span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="34">3.4 代币验证模块</h3>
<h3 id="35-iagent">3.5 iAgent自动化模块</h3>
<h4 id="351">3.5.1 自动化承诺管理</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">IAgentCommitmentManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">config</span>: <span class="nc">IAgentConfig</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">automation_enabled</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_strategy</span>: <span class="nc">CommitmentStrategy</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">reveal_conditions</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevealCondition</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">CommitmentStrategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Immediate</span><span class="p">,</span><span class="w">      </span><span class="c1">// 立即承诺</span>
<span class="w">    </span><span class="n">Scheduled</span><span class="p">,</span><span class="w">      </span><span class="c1">// 定时承诺</span>
<span class="w">    </span><span class="n">Conditional</span><span class="p">,</span><span class="w">    </span><span class="c1">// 条件触发承诺</span>
<span class="w">    </span><span class="n">Batch</span><span class="p">,</span><span class="w">          </span><span class="c1">// 批量承诺</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">IAgentCommitmentManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">setup_automated_commitment</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">message</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">strategy</span>: <span class="kp">&amp;</span><span class="nc">CommitmentStrategy</span><span class="p">,</span>
<span class="w">        </span><span class="n">conditions</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">RevealCondition</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 根据策略自动设置承诺和揭示流程</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">strategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">CommitmentStrategy</span>::<span class="n">Immediate</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">execute_immediate_commitment</span><span class="p">(</span><span class="n">message</span><span class="p">).</span><span class="k">await</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">CommitmentStrategy</span>::<span class="n">Scheduled</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">schedule_commitment</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">conditions</span><span class="p">).</span><span class="k">await</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">CommitmentStrategy</span>::<span class="n">Conditional</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">setup_conditional_commitment</span><span class="p">(</span><span class="n">message</span><span class="p">,</span><span class="w"> </span><span class="n">conditions</span><span class="p">).</span><span class="k">await</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">CommitmentStrategy</span>::<span class="n">Batch</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">add_to_batch_queue</span><span class="p">(</span><span class="n">message</span><span class="p">).</span><span class="k">await</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_automated_reveal</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">commitment_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 自动执行揭示操作</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">should_auto_reveal</span><span class="p">(</span><span class="n">commitment_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="bp">self</span><span class="p">.</span><span class="n">reveal_commitment</span><span class="p">(</span><span class="n">commitment_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="352">3.5.2 自动化投票管理</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">IAgentVotingManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment_manager</span>: <span class="nc">IAgentCommitmentManager</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">voting_automation</span>: <span class="nc">VotingAutomation</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">auto_reveal_service</span>: <span class="nc">AutoRevealService</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">IAgentVotingManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">setup_automated_voting</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">vote_config</span>: <span class="nc">AutomatedVoteConfig</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 设置自动化投票流程</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">vote_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_vote_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vote_config</span><span class="p">);</span>

<span class="w">        </span><span class="c1">// 配置自动承诺</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">commitment_manager</span><span class="p">.</span><span class="n">setup_automated_commitment</span><span class="p">(</span>
<span class="w">            </span><span class="n">vote_config</span><span class="p">.</span><span class="n">message</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">vote_config</span><span class="p">.</span><span class="n">commitment_strategy</span><span class="p">,</span>
<span class="w">            </span><span class="o">&amp;</span><span class="n">vote_config</span><span class="p">.</span><span class="n">reveal_conditions</span>
<span class="w">        </span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 配置自动揭示触发器</span>
<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">setup_reveal_triggers</span><span class="p">(</span><span class="o">&amp;</span><span class="n">vote_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">vote_config</span><span class="p">.</span><span class="n">reveal_triggers</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">vote_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">process_automated_voting_cycle</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">vote_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 自动处理投票生命周期</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">vote_status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">get_vote_status</span><span class="p">(</span><span class="n">vote_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="n">vote_status</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">DecisionVoteStatus</span>::<span class="n">Active</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">execute_automated_commitment</span><span class="p">(</span><span class="n">vote_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">DecisionVoteStatus</span>::<span class="n">Closed</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="k">if</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">should_auto_reveal</span><span class="p">(</span><span class="n">vote_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="bp">self</span><span class="p">.</span><span class="n">execute_automated_reveal</span><span class="p">(</span><span class="n">vote_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">_</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="353">3.5.3 智能合约自动化支持</h4>
<div class="codehilite"><pre><span></span><code><span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">ExecuteMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 现有消息类型...</span>
<span class="w">    </span><span class="n">SetupAutomatedVoting</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">automation_config</span>: <span class="nc">AutomationConfig</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">ExecuteAutomatedCommitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">commitment_batch</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">ExecuteAutomatedReveal</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">reveal_batch</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">RevealData</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">execute_setup_automated_voting</span><span class="p">(</span>
<span class="w">    </span><span class="n">deps</span>: <span class="nc">DepsMut</span><span class="p">,</span>
<span class="w">    </span><span class="n">env</span>: <span class="nc">Env</span><span class="p">,</span>
<span class="w">    </span><span class="n">info</span>: <span class="nc">MessageInfo</span><span class="p">,</span>
<span class="w">    </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">automation_config</span>: <span class="nc">AutomationConfig</span><span class="p">,</span>
<span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Response</span><span class="p">,</span><span class="w"> </span><span class="n">StdError</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="c1">// 设置自动化投票配置</span>
<span class="w">    </span><span class="kd">let</span><span class="w"> </span><span class="n">automation_state</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">AutomationState</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">is_automated</span>: <span class="nc">true</span><span class="p">,</span>
<span class="w">        </span><span class="n">config</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">automation_config</span><span class="p">.</span><span class="n">clone</span><span class="p">()),</span>
<span class="w">        </span><span class="n">last_automation_run</span>: <span class="nb">Some</span><span class="p">(</span><span class="n">env</span><span class="p">.</span><span class="n">block</span><span class="p">.</span><span class="n">time</span><span class="p">.</span><span class="n">seconds</span><span class="p">()),</span>
<span class="w">        </span><span class="n">automation_status</span>: <span class="s">&quot;active&quot;</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="n">batch_queue</span>: <span class="nb">Vec</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">        </span><span class="n">reveal_queue</span>: <span class="nb">Vec</span>::<span class="n">new</span><span class="p">(),</span>
<span class="w">    </span><span class="p">};</span>

<span class="w">    </span><span class="n">save_automation_state</span><span class="p">(</span><span class="n">deps</span><span class="p">.</span><span class="n">storage</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">decision_vote_id</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">automation_state</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">    </span><span class="nb">Ok</span><span class="p">(</span><span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;setup_automated_voting&quot;</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;decision_vote_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">decision_vote_id</span><span class="p">)</span>
<span class="w">        </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;agent_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">automation_config</span><span class="p">.</span><span class="n">agent_id</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="311">3.1.1 代币持有验证</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">TokenVerifier</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">contract_address</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">min_token_amount</span>: <span class="nc">Uint128</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">TokenVerifier</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">verify_token_holding</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">user_address</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 查询用户代币余额</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">balance</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">query_token_balance</span><span class="p">(</span><span class="n">user_address</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="c1">// 验证是否满足最小持有量要求</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">balance</span><span class="w"> </span><span class="o">&gt;=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">min_token_amount</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">query_token_balance</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">user_address</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">Uint128</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 调用代币合约查询余额</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">query_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">QueryMsg</span>::<span class="n">Balance</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">address</span>: <span class="nc">user_address</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">client</span>
<span class="w">            </span><span class="p">.</span><span class="n">query_contract</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">query_msg</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">balance</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="312_1">3.1.2 代币权限控制</h4>
<ul>
<li>只有持有足够$LUCKEE代币的用户才能创建/更新NFT类型全局参数配置</li>
<li>代币持有量决定用户权限等级</li>
<li>支持代币质押和锁定机制</li>
</ul>
<h3 id="36-nft">3.6 NFT管理模块</h3>
<h4 id="361-nft">3.6.1 NFT创建和管理</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">contract_address</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="n">nft_standard</span>: <span class="nc">NFTStandard</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">NFTStandard</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">CW721</span><span class="p">,</span>
<span class="w">    </span><span class="n">CW1155</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTMetadata</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">image</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">attributes</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">NFTAttribute</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">voting_project_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">lottery_tier</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">LotteryTier</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winning_number</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTAttribute</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">trait_type</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">value</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LotteryTier</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tier_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tier_name</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">prize_description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winner_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">NFTManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">create_voting_nft</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span>: <span class="nc">NFTMetadata</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 创建NFT</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">mint_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">MintMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">token_id</span>: <span class="nc">self</span><span class="p">.</span><span class="n">generate_token_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">metadata</span><span class="p">.</span><span class="n">voting_project_id</span><span class="p">),</span>
<span class="w">            </span><span class="n">owner</span>: <span class="nc">metadata</span><span class="p">.</span><span class="n">voting_project_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">token_uri</span>: <span class="nc">self</span><span class="p">.</span><span class="n">store_metadata</span><span class="p">(</span><span class="o">&amp;</span><span class="n">metadata</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">,</span>
<span class="w">            </span><span class="n">extension</span>: <span class="nb">None</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">response</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">client</span>
<span class="w">            </span><span class="p">.</span><span class="n">execute_contract</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">mint_msg</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">response</span><span class="p">.</span><span class="n">tx_hash</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">verify_nft_ownership</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">user_address</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">token_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 验证用户是否拥有指定NFT</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">owner</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">query_nft_owner</span><span class="p">(</span><span class="n">token_id</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">owner</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">user_address</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">assign_winning_number</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">token_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">winning_number</span>: <span class="kt">u64</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="c1">// 为NFT分配中奖序号</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">update_msg</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">UpdateMetadataMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">token_id</span>: <span class="nc">token_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">(),</span>
<span class="w">            </span><span class="n">token_uri</span>: <span class="nc">self</span><span class="p">.</span><span class="n">update_winning_number_metadata</span><span class="p">(</span><span class="n">token_id</span><span class="p">,</span><span class="w"> </span><span class="n">winning_number</span><span class="p">).</span><span class="k">await</span><span class="o">?</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">client</span>
<span class="w">            </span><span class="p">.</span><span class="n">execute_contract</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">.</span><span class="n">contract_address</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">update_msg</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="k">await</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="362">3.6.2 投票资格验证</h4>
<ul>
<li>只有拥有对应NFT的账户才具有投票资格</li>
<li>NFT包含NFT类型标识与投票相关属性（通过配置CID/版本引用NFT类型全局参数）</li>
<li>支持NFT的转移和交易</li>
</ul>
<h3 id="37">3.7 抽奖等级系统（基于抽奖/彩票的多目标选择模式）</h3>
<h4 id="371">3.7.1 等级配置管理</h4>
<div class="codehilite"><pre><span></span><code><span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LotteryTierConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tier_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tier_name</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">prize_description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winner_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">min_participants</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">probability</span>: <span class="kt">f64</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LotteryProject</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">project_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">title</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tiers</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">LotteryTierConfig</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">total_participants</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">status</span>: <span class="nc">LotteryStatus</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">creator</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">LotteryStatus</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Created</span><span class="p">,</span>
<span class="w">    </span><span class="n">Active</span><span class="p">,</span>
<span class="w">    </span><span class="n">Closed</span><span class="p">,</span>
<span class="w">    </span><span class="n">WinnersSelected</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">LotteryManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">projects</span>: <span class="nc">HashMap</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">LotteryProject</span><span class="o">&gt;</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">LotteryManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">create_lottery_project</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">config</span>: <span class="nc">LotteryProjectConfig</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">project_id</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">generate_project_id</span><span class="p">(</span><span class="o">&amp;</span><span class="n">config</span><span class="p">);</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LotteryProject</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">project_id</span>: <span class="nc">project_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span>
<span class="w">            </span><span class="n">title</span>: <span class="nc">config</span><span class="p">.</span><span class="n">title</span><span class="p">,</span>
<span class="w">            </span><span class="n">description</span>: <span class="nc">config</span><span class="p">.</span><span class="n">description</span><span class="p">,</span>
<span class="w">            </span><span class="n">tiers</span>: <span class="nc">config</span><span class="p">.</span><span class="n">tiers</span><span class="p">,</span>
<span class="w">            </span><span class="n">total_participants</span>: <span class="mi">0</span><span class="p">,</span>
<span class="w">            </span><span class="n">status</span>: <span class="nc">LotteryStatus</span>::<span class="n">Created</span><span class="p">,</span>
<span class="w">            </span><span class="n">creator</span>: <span class="nc">config</span><span class="p">.</span><span class="n">creator</span><span class="p">,</span>
<span class="w">        </span><span class="p">};</span>

<span class="w">        </span><span class="bp">self</span><span class="p">.</span><span class="n">projects</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">project_id</span><span class="p">.</span><span class="n">clone</span><span class="p">(),</span><span class="w"> </span><span class="n">project</span><span class="p">);</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">set_lottery_tiers</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">project_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">tiers</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">LotteryTierConfig</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="p">(),</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="kd">let</span><span class="w"> </span><span class="nb">Some</span><span class="p">(</span><span class="n">project</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">projects</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">project</span><span class="p">.</span><span class="n">tiers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tiers</span><span class="p">;</span>
<span class="w">            </span><span class="nb">Ok</span><span class="p">(())</span>
<span class="w">        </span><span class="p">}</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="nb">Err</span><span class="p">(</span><span class="n">Error</span>::<span class="n">ProjectNotFound</span><span class="p">)</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">calculate_winners</span><span class="p">(</span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">project_id</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">random_numbers</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">i64</span><span class="o">&gt;</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Winner</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">project</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">projects</span><span class="p">.</span><span class="n">get_mut</span><span class="p">(</span><span class="n">project_id</span><span class="p">)</span>
<span class="w">            </span><span class="p">.</span><span class="n">ok_or</span><span class="p">(</span><span class="n">Error</span>::<span class="n">ProjectNotFound</span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="n">project</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">LotteryStatus</span>::<span class="n">Closed</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="k">return</span><span class="w"> </span><span class="nb">Err</span><span class="p">(</span><span class="n">Error</span>::<span class="n">InvalidStatus</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">total_sum</span>: <span class="kt">i64</span> <span class="o">=</span><span class="w"> </span><span class="n">random_numbers</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">sum</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">participant_count</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">random_numbers</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="p">;</span>

<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">used_indices</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">HashSet</span>::<span class="n">new</span><span class="p">();</span>

<span class="w">        </span><span class="c1">// 为每个等级分配中奖者</span>
<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">tier</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="o">&amp;</span><span class="n">project</span><span class="p">.</span><span class="n">tiers</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">tier_winners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">select_tier_winners</span><span class="p">(</span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">random_numbers</span><span class="p">,</span>
<span class="w">                </span><span class="o">&amp;</span><span class="k">mut</span><span class="w"> </span><span class="n">used_indices</span><span class="p">,</span>
<span class="w">                </span><span class="n">tier</span><span class="p">.</span><span class="n">winner_count</span><span class="p">,</span>
<span class="w">                </span><span class="n">total_sum</span><span class="p">,</span>
<span class="w">                </span><span class="n">participant_count</span>
<span class="w">            </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="n">winner</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">tier_winners</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">winners</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">winner</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="n">project</span><span class="p">.</span><span class="n">status</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">LotteryStatus</span>::<span class="n">WinnersSelected</span><span class="p">;</span>
<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">select_tier_winners</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">random_numbers</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">i64</span><span class="p">],</span>
<span class="w">        </span><span class="n">used_indices</span>: <span class="kp">&amp;</span><span class="nc">mut</span><span class="w"> </span><span class="n">HashSet</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">winner_count</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="w">        </span><span class="n">total_sum</span>: <span class="kt">i64</span><span class="p">,</span>
<span class="w">        </span><span class="n">participant_count</span>: <span class="kt">u64</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">Winner</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">winners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">attempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">max_attempts</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">participant_count</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="c1">// 防止无限循环</span>

<span class="w">        </span><span class="k">while</span><span class="w"> </span><span class="n">winners</span><span class="p">.</span><span class="n">len</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">winner_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">attempts</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">max_attempts</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">attempts</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>

<span class="w">            </span><span class="c1">// 使用总和对参与者数量取余，然后加上随机偏移</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">base_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">total_sum</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">participant_count</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">i64</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">attempts</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">participant_count</span><span class="p">)</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">usize</span><span class="p">;</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">candidate_index</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">base_index</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">offset</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">random_numbers</span><span class="p">.</span><span class="n">len</span><span class="p">();</span>

<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="o">!</span><span class="n">used_indices</span><span class="p">.</span><span class="n">contains</span><span class="p">(</span><span class="o">&amp;</span><span class="n">candidate_index</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">used_indices</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">candidate_index</span><span class="p">);</span>
<span class="w">                </span><span class="n">winners</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">Winner</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">participant_index</span>: <span class="nc">candidate_index</span><span class="p">,</span>
<span class="w">                    </span><span class="n">random_number</span>: <span class="nc">random_numbers</span><span class="p">[</span><span class="n">candidate_index</span><span class="p">],</span>
<span class="w">                    </span><span class="n">tier_id</span>: <span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="c1">// 将在调用方设置</span>
<span class="w">                </span><span class="p">});</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">winners</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Winner</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_index</span>: <span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">random_number</span>: <span class="kt">i64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tier_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="372-n-k">3.7.2 中奖序号分配算法（与 n 选 k 的关系）</h4>
<blockquote>
<p>等价关系：
- 唯一中奖 ≈ n 选 1；
- 多等级 = 多个 n 选 k 并行/串行编排；
- 不同等级可独立配置 k、规则与偏好组。</p>
</blockquote>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">WinningNumberAllocator</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">allocation_strategy</span>: <span class="nc">AllocationStrategy</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">AllocationStrategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Sequential</span><span class="p">,</span><span class="w">      </span><span class="c1">// 顺序分配</span>
<span class="w">    </span><span class="n">Random</span><span class="p">,</span><span class="w">          </span><span class="c1">// 随机分配</span>
<span class="w">    </span><span class="n">Weighted</span><span class="p">,</span><span class="w">        </span><span class="c1">// 基于权重的分配</span>
<span class="w">    </span><span class="n">TierBased</span><span class="p">,</span><span class="w">       </span><span class="c1">// 基于等级的分配</span>
<span class="p">}</span>

<span class="k">impl</span><span class="w"> </span><span class="n">WinningNumberAllocator</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="k">fn</span> <span class="nf">allocate_winning_numbers</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participants</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Participant</span><span class="p">],</span>
<span class="w">        </span><span class="n">tiers</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">LotteryTierConfig</span><span class="p">],</span>
<span class="w">        </span><span class="n">random_seed</span>: <span class="kt">u64</span>
    <span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">WinningNumber</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="k">match</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">allocation_strategy</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="n">AllocationStrategy</span>::<span class="n">Sequential</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">allocate_sequential</span><span class="p">(</span><span class="n">participants</span><span class="p">,</span><span class="w"> </span><span class="n">tiers</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">AllocationStrategy</span>::<span class="n">Random</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">allocate_random</span><span class="p">(</span><span class="n">participants</span><span class="p">,</span><span class="w"> </span><span class="n">tiers</span><span class="p">,</span><span class="w"> </span><span class="n">random_seed</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">AllocationStrategy</span>::<span class="n">Weighted</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">allocate_weighted</span><span class="p">(</span><span class="n">participants</span><span class="p">,</span><span class="w"> </span><span class="n">tiers</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">            </span><span class="n">AllocationStrategy</span>::<span class="n">TierBased</span><span class="w"> </span><span class="o">=&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="bp">self</span><span class="p">.</span><span class="n">allocate_tier_based</span><span class="p">(</span><span class="n">participants</span><span class="p">,</span><span class="w"> </span><span class="n">tiers</span><span class="p">)</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">allocate_tier_based</span><span class="p">(</span>
<span class="w">        </span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span>
<span class="w">        </span><span class="n">participants</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">Participant</span><span class="p">],</span>
<span class="w">        </span><span class="n">tiers</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="n">LotteryTierConfig</span><span class="p">]</span>
<span class="w">    </span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">WinningNumber</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">winning_numbers</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">Vec</span>::<span class="n">new</span><span class="p">();</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="k">mut</span><span class="w"> </span><span class="n">available_participants</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">usize</span><span class="o">&gt;</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="mi">0</span><span class="o">..</span><span class="n">participants</span><span class="p">.</span><span class="n">len</span><span class="p">()).</span><span class="n">collect</span><span class="p">();</span>

<span class="w">        </span><span class="k">for</span><span class="w"> </span><span class="n">tier</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">tiers</span><span class="w"> </span><span class="p">{</span>
<span class="w">            </span><span class="kd">let</span><span class="w"> </span><span class="n">tier_winners</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="bp">self</span><span class="p">.</span><span class="n">select_tier_winners</span><span class="p">(</span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">available_participants</span><span class="p">,</span>
<span class="w">                </span><span class="n">tier</span><span class="p">.</span><span class="n">winner_count</span><span class="p">,</span>
<span class="w">                </span><span class="n">participants</span>
<span class="w">            </span><span class="p">)</span><span class="o">?</span><span class="p">;</span>

<span class="w">            </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">winner_index</span><span class="p">)</span><span class="w"> </span><span class="k">in</span><span class="w"> </span><span class="n">tier_winners</span><span class="p">.</span><span class="n">iter</span><span class="p">().</span><span class="n">enumerate</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<span class="w">                </span><span class="n">winning_numbers</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">WinningNumber</span><span class="w"> </span><span class="p">{</span>
<span class="w">                    </span><span class="n">participant_index</span>: <span class="o">*</span><span class="n">winner_index</span><span class="p">,</span>
<span class="w">                    </span><span class="n">winning_number</span>: <span class="nc">self</span><span class="p">.</span><span class="n">generate_winning_number</span><span class="p">(</span><span class="n">tier</span><span class="p">.</span><span class="n">tier_id</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u32</span><span class="p">),</span>
<span class="w">                    </span><span class="n">tier_id</span>: <span class="nc">tier</span><span class="p">.</span><span class="n">tier_id</span><span class="p">,</span>
<span class="w">                </span><span class="p">});</span>

<span class="w">                </span><span class="c1">// 从可用参与者中移除已中奖的</span>
<span class="w">                </span><span class="n">available_participants</span><span class="p">.</span><span class="n">retain</span><span class="p">(</span><span class="o">|&amp;</span><span class="n">x</span><span class="o">|</span><span class="w"> </span><span class="n">x</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="o">*</span><span class="n">winner_index</span><span class="p">);</span>
<span class="w">            </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">        </span><span class="nb">Ok</span><span class="p">(</span><span class="n">winning_numbers</span><span class="p">)</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">    </span><span class="k">fn</span> <span class="nf">generate_winning_number</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">tier_id</span>: <span class="kt">u32</span><span class="p">,</span><span class="w"> </span><span class="n">position</span>: <span class="kt">u32</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="kt">u64</span> <span class="p">{</span>
<span class="w">        </span><span class="c1">// 生成中奖序号：tier_id * 10000 + position * 100 + random_offset</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">base</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tier_id</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">10000</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">position</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="kt">u64</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">        </span><span class="kd">let</span><span class="w"> </span><span class="n">random_offset</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">rand</span>::<span class="n">random</span>::<span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">()</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="mi">100</span><span class="p">;</span>
<span class="w">        </span><span class="n">base</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">random_offset</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">WinningNumber</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_index</span>: <span class="kt">usize</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winning_number</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tier_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Debug, Clone)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">Participant</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">address</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">random_number</span>: <span class="kt">i64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_token_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="38">3.8 密码学核心模块</h3>
<h4 id="381">3.8.1 比特承诺协议</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">BitCommitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">commitment</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">opening</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">random_seed</span>: <span class="p">[</span><span class="kt">u8</span><span class="p">;</span><span class="w"> </span><span class="mi">32</span><span class="p">],</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">CommitmentScheme</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">commit</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">message</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">],</span><span class="w"> </span><span class="n">randomness</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nc">BitCommitment</span><span class="p">;</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">verify</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">commitment</span>: <span class="kp">&amp;</span><span class="nc">BitCommitment</span><span class="p">,</span><span class="w"> </span><span class="n">message</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="kt">bool</span><span class="p">;</span>
<span class="w">    </span><span class="k">fn</span> <span class="nf">reveal</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">commitment</span>: <span class="kp">&amp;</span><span class="nc">BitCommitment</span><span class="p">,</span><span class="w"> </span><span class="n">randomness</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="382">3.8.2 中奖序号生成</h4>
<ul>
<li>基于投票数据的确定性中奖序号生成</li>
<li>支持多等级中奖序号分配</li>
<li>确保中奖序号的唯一性和公平性</li>
</ul>
<h3 id="39-webassembly">3.9 WebAssembly服务器模块</h3>
<h4 id="391">3.9.1 决策投票生命周期管理</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">DecisionVoteStatus</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Created</span><span class="p">,</span>
<span class="w">    </span><span class="n">Active</span><span class="p">,</span>
<span class="w">    </span><span class="n">Paused</span><span class="p">,</span>
<span class="w">    </span><span class="n">Closed</span><span class="p">,</span>
<span class="w">    </span><span class="n">Tallied</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">DecisionVoteLifecycle</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">status</span>: <span class="nc">DecisionVoteStatus</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">created_at</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">start_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">end_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">total_preference_votes</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">preference_range</span>: <span class="p">(</span><span class="kt">i32</span><span class="p">,</span><span class="w"> </span><span class="kt">i32</span><span class="p">),</span><span class="w"> </span><span class="c1">// 偏好值范围</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_contract_address</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// NFT合约地址</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">lottery_tiers</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">LotteryTierConfig</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 抽奖等级配置</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="392">3.9.2 区块链交互接口</h4>
<ul>
<li>智能合约调用封装</li>
<li>偏好投票交易状态监控</li>
<li>决策结果事件监听和处理</li>
<li>代币余额查询和验证</li>
<li>NFT所有权验证</li>
<li>错误处理和重试机制</li>
</ul>
<h4 id="393">3.9.3 存储适配器抽象层</h4>
<div class="codehilite"><pre><span></span><code><span class="k">pub</span><span class="w"> </span><span class="k">trait</span><span class="w"> </span><span class="n">StorageAdapter</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">store</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">value</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">retrieve</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="kt">u8</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">verify</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">key</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">,</span><span class="w"> </span><span class="n">hash</span>: <span class="kp">&amp;</span><span class="p">[</span><span class="kt">u8</span><span class="p">])</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">store_nft_metadata</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">metadata</span>: <span class="kp">&amp;</span><span class="nc">NFTMetadata</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="nb">String</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="k">fn</span> <span class="nf">retrieve_nft_metadata</span><span class="p">(</span><span class="o">&amp;</span><span class="bp">self</span><span class="p">,</span><span class="w"> </span><span class="n">uri</span>: <span class="kp">&amp;</span><span class="kt">str</span><span class="p">)</span><span class="w"> </span>-&gt; <span class="nb">Result</span><span class="o">&lt;</span><span class="n">NFTMetadata</span><span class="p">,</span><span class="w"> </span><span class="n">Error</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="310">3.10 区块链智能合约</h3>
<h4 id="3101">3.10.1 代币合约接口</h4>
<div class="codehilite"><pre><span></span><code><span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">TokenBalance</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">address</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">balance</span>: <span class="nc">Uint128</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">TokenQueryMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Balance</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">address</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">TokenInfo</span><span class="w"> </span><span class="p">{},</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">TokenInfoResponse</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">name</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">symbol</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">decimals</span>: <span class="kt">u8</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">total_supply</span>: <span class="nc">Uint128</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="3102-nft">3.10.2 NFT合约接口</h4>
<div class="codehilite"><pre><span></span><code><span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">NFTExecuteMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">Mint</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">token_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">owner</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">token_uri</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">extension</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="n">Extension</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">TransferNft</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">recipient</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">token_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">UpdateMetadata</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">token_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">token_uri</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">NFTQueryMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">OwnerOf</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">token_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">TokenInfo</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">token_id</span>: <span class="nb">String</span> <span class="p">},</span>
<span class="w">    </span><span class="n">NumTokens</span><span class="w"> </span><span class="p">{},</span>
<span class="w">    </span><span class="n">AllTokens</span><span class="w"> </span><span class="p">{</span><span class="w"> </span><span class="n">start_after</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="n">limit</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u32</span><span class="o">&gt;</span><span class="w"> </span><span class="p">},</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="3103">3.10.3 投票合约扩展</h4>
<div class="codehilite"><pre><span></span><code><span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">DecisionVote</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">title</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">min_preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">max_preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">start_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">end_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">is_active</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">result_hash</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">creator</span>: <span class="nc">Addr</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">is_lottery</span>: <span class="kt">bool</span><span class="p">,</span><span class="w"> </span><span class="c1">// 标识是否为抽奖活动</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_contract_address</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// NFT合约地址</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">lottery_tiers</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">LotteryTierConfig</span><span class="o">&gt;&gt;</span><span class="p">,</span><span class="w"> </span><span class="c1">// 抽奖等级配置</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">min_token_requirement</span>: <span class="nc">Uint128</span><span class="p">,</span><span class="w"> </span><span class="c1">// 创建投票项目所需的最小代币数量</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="cp">#[serde(rename_all = </span><span class="s">&quot;snake_case&quot;</span><span class="cp">)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">enum</span> <span class="nc">ExecuteMsg</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="n">CreateDecisionVote</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">title</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">description</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">min_preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">        </span><span class="n">max_preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">        </span><span class="n">start_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">        </span><span class="n">end_time</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">        </span><span class="n">max_votes</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">min_votes</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="kt">u64</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">is_lottery</span>: <span class="kt">bool</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_contract_address</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">String</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">lottery_tiers</span>: <span class="nb">Option</span><span class="o">&lt;</span><span class="nb">Vec</span><span class="o">&lt;</span><span class="n">LotteryTierConfig</span><span class="o">&gt;&gt;</span><span class="p">,</span>
<span class="w">        </span><span class="n">min_token_requirement</span>: <span class="nc">Uint128</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">SubmitPreferenceCommitment</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">commitment</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">nft_proof</span>: <span class="nc">NFTProof</span><span class="p">,</span><span class="w"> </span><span class="c1">// NFT所有权证明</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">RevealPreferenceVote</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">preference</span>: <span class="kt">i32</span><span class="p">,</span>
<span class="w">        </span><span class="n">randomness</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">SetLotteryTiers</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">tiers</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">LotteryTierConfig</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="w">    </span><span class="n">AssignWinningNumbers</span><span class="w"> </span><span class="p">{</span>
<span class="w">        </span><span class="n">decision_vote_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">        </span><span class="n">winning_numbers</span>: <span class="nb">Vec</span><span class="o">&lt;</span><span class="n">WinningNumber</span><span class="o">&gt;</span><span class="p">,</span>
<span class="w">    </span><span class="p">},</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">NFTProof</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">token_id</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">nft_contract_address</span>: <span class="nb">String</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">owner_signature</span>: <span class="nb">String</span><span class="p">,</span>
<span class="p">}</span>

<span class="cp">#[derive(Serialize, Deserialize, Clone, Debug, PartialEq, JsonSchema)]</span>
<span class="k">pub</span><span class="w"> </span><span class="k">struct</span> <span class="nc">WinningNumber</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">participant_index</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">winning_number</span>: <span class="kt">u64</span><span class="p">,</span>
<span class="w">    </span><span class="k">pub</span><span class="w"> </span><span class="n">tier_id</span>: <span class="kt">u32</span><span class="p">,</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="311-sdk">3.11 客户端SDK</h3>
<h4 id="3111-nft">3.11.1 投票项目管理（作为NFT属性接口）</h4>
<div class="codehilite"><pre><span></span><code><span class="c1">// 投票项目相关接口作为 NFT 管理的一部分暴露，仅配置 NFT 类型的全局参数</span>
<span class="kd">class</span><span class="w"> </span><span class="nx">VotingProjectInterface</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">configureForNftType</span><span class="p">(</span><span class="nx">nftType</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">params</span><span class="o">:</span><span class="w"> </span><span class="kt">NftGlobalVotingParams</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="p">;</span><span class="w"> </span><span class="c1">// 返回配置版本/CID</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">getConfigByNftType</span><span class="p">(</span><span class="nx">nftType</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">NftGlobalVotingParams</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">NftGlobalVotingParams</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">title?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">              </span><span class="c1">// 可选，展示用</span>
<span class="w">    </span><span class="nx">description?</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span><span class="w">        </span><span class="c1">// 可选，展示用</span>
<span class="w">    </span><span class="nx">minPreference</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">maxPreference</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">commitStartTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">commitEndTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">revealStartTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">revealEndTime</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">isLottery?</span><span class="o">:</span><span class="w"> </span><span class="kt">boolean</span><span class="p">;</span>
<span class="w">    </span><span class="nx">lotteryTiers?</span><span class="o">:</span><span class="w"> </span><span class="kt">LotteryTierConfig</span><span class="p">[];</span><span class="w"> </span><span class="c1">// 明细入IPFS，链上仅存CID/摘要</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">LotteryTierConfig</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">tierId</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">tierName</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">prizeDescription</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">winnerCount</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="3112-nft">3.11.2 NFT管理接口</h4>
<div class="codehilite"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">NFTManager</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">createVotingNFT</span><span class="p">(</span><span class="nx">metadata</span><span class="o">:</span><span class="w"> </span><span class="kt">NFTMetadata</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">verifyOwnership</span><span class="p">(</span><span class="nx">userAddress</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">tokenId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">boolean</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">assignWinningNumber</span><span class="p">(</span><span class="nx">tokenId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">winningNumber</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="ow">void</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">getNFTMetadata</span><span class="p">(</span><span class="nx">tokenId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">NFTMetadata</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">NFTMetadata</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">description</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">image</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">attributes</span><span class="o">:</span><span class="w"> </span><span class="kt">NFTAttribute</span><span class="p">[];</span>
<span class="w">    </span><span class="nx">votingProjectId</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">lotteryTier?</span><span class="o">:</span><span class="w"> </span><span class="kt">LotteryTier</span><span class="p">;</span>
<span class="w">    </span><span class="nx">winningNumber?</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h4 id="3113">3.11.3 代币验证接口</h4>
<div class="codehilite"><pre><span></span><code><span class="kd">class</span><span class="w"> </span><span class="nx">TokenVerifier</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">verifyTokenHolding</span><span class="p">(</span><span class="nx">userAddress</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">,</span><span class="w"> </span><span class="nx">minAmount</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">boolean</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">getTokenBalance</span><span class="p">(</span><span class="nx">userAddress</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">)</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="kt">string</span><span class="o">&gt;</span><span class="p">;</span>
<span class="w">    </span><span class="k">async</span><span class="w"> </span><span class="nx">getTokenInfo</span><span class="p">()</span><span class="o">:</span><span class="w"> </span><span class="nb">Promise</span><span class="o">&lt;</span><span class="nx">TokenInfo</span><span class="o">&gt;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">interface</span><span class="w"> </span><span class="nx">TokenInfo</span><span class="w"> </span><span class="p">{</span>
<span class="w">    </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">symbol</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="w">    </span><span class="nx">decimals</span><span class="o">:</span><span class="w"> </span><span class="kt">number</span><span class="p">;</span>
<span class="w">    </span><span class="nx">totalSupply</span><span class="o">:</span><span class="w"> </span><span class="kt">string</span><span class="p">;</span>
<span class="p">}</span>
</code></pre></div>

<h3 id="312_2">3.12 存储策略模块</h3>
<h4 id="3121">3.12.1 存储边界澄清</h4>
<ul>
<li>主要存储：IPFS。存放投票决策的详细数据（承诺/揭示明细、参与者、计算过程与证明、完整配置版本等）。</li>
<li>链上最小化：仅记录账户与NFT的关联信息、结果摘要/哈希/CID、必要索引与审计事件。</li>
<li>单一真实源（Single Source of Truth）：以 IPFS 的 <code>CID/版本</code> 作为配置与明细的唯一真实源；链上仅做完整性校验与可验证引用，避免状态膨胀与重复来源。</li>
</ul>
<h4 id="3122-nft">3.12.2 NFT元数据与配置</h4>
<ul>
<li>IPFS存储NFT元数据与投票相关配置版本；链上保存其CID/哈希用于完整性验证与检索。</li>
</ul>
<h2 id="4">4. 数据流设计</h2>
<h3 id="41-nft">4.1 NFT类型创建和应用场景控制流程</h3>
<ol>
<li>用户验证$LUCKEE代币持有量</li>
<li>创建NFT类型定义，包括应用场景配置</li>
<li>设置NFT类型的全局状态变量</li>
<li>配置比特承诺状态控制规则</li>
<li>存储NFT类型信息到区块链</li>
<li>返回NFT类型ID和配置信息</li>
</ol>
<h3 id="42-nft">4.2 NFT分发替代用户注册流程</h3>
<ol>
<li>用户请求参与特定应用场景</li>
<li>系统验证用户资格（代币持有量、地理位置等）</li>
<li>根据NFT类型分发相应的NFT</li>
<li>更新NFT全局状态变量</li>
<li>记录NFT分发信息到区块链</li>
<li>返回NFT ID和参与确认</li>
</ol>
<h3 id="43-nft">4.3 基于NFT状态的比特承诺控制流程</h3>
<ol>
<li>用户提交偏好投票承诺</li>
<li>系统查询NFT全局状态变量</li>
<li>验证NFT状态是否允许承诺操作</li>
<li>执行承诺操作并更新NFT状态</li>
<li>触发状态变更钩子</li>
<li>记录状态变更到区块链</li>
</ol>
<h3 id="44">4.4 投票参与流程</h3>
<ol>
<li>用户验证NFT类型和所有权</li>
<li>系统检查NFT状态是否允许投票</li>
<li>提交偏好投票承诺</li>
<li>验证投票资格和NFT状态</li>
<li>记录投票参与信息</li>
<li>更新NFT状态和投票统计</li>
</ol>
<h3 id="45">4.5 抽奖结果计算流程</h3>
<ol>
<li>收集所有参与者的随机数</li>
<li>根据NFT类型配置分配中奖者</li>
<li>为每个中奖者分配中奖序号</li>
<li>更新NFT元数据中的中奖信息</li>
<li>更新NFT全局状态变量</li>
<li>生成抽奖结果证明</li>
</ol>
<h3 id="46">4.6 多目标选择流程</h3>
<ol>
<li><strong>会话创建</strong>：创建多目标选择会话，设置参与者数量和目标数量</li>
<li><strong>NFT分发</strong>：参与者通过NFT类型验证身份，获得参与NFT</li>
<li><strong>值选择阶段</strong>：每个参与者选择k个值，反映对中奖序号的偏好</li>
<li><strong>承诺阶段</strong>：iAgent基于NFT状态自动生成承诺并存储到IPFS和区块链</li>
<li><strong>揭示阶段</strong>：iAgent基于NFT状态自动揭示所有参与者的真实值</li>
<li><strong>中奖计算</strong>：基于所有参与者的值计算k个不同的中奖序号</li>
<li><strong>结果验证</strong>：验证计算过程的正确性和结果的唯一性</li>
<li><strong>状态更新</strong>：更新NFT全局状态变量</li>
</ol>
<h4 id="461">4.6.1 多目标选择算法</h4>
<ul>
<li><strong>基准序号计算</strong>：A1 = (∑v_{i1}) mod n + 1</li>
<li><strong>偏移序号计算</strong>：Aj = (A_{j-1} + Δj) mod n，确保唯一性</li>
<li><strong>防冲突机制</strong>：通过循环递增确保所有中奖序号互不相同</li>
<li><strong>支持策略选择</strong>：参与者可根据策略选择不同的值组合</li>
<li><strong>NFT状态集成</strong>：算法执行过程中实时更新NFT状态变量</li>
</ul>
<h2 id="5">5. 接口设计</h2>
<h3 id="51-restful-api">5.1 RESTful API扩展</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// NFT类型管理</span>
<span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nft</span><span class="o">-</span><span class="nx">types</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">创建NFT类型</span>
<span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nft</span><span class="o">-</span><span class="nx">types</span><span class="o">/:</span><span class="nx">id</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">获取NFT类型信息</span>
<span class="nx">PUT</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nft</span><span class="o">-</span><span class="nx">types</span><span class="o">/:</span><span class="nx">id</span><span class="o">/</span><span class="nx">config</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">更新NFT类型配置</span>
<span class="nx">DELETE</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nft</span><span class="o">-</span><span class="nx">types</span><span class="o">/:</span><span class="nx">id</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">删除NFT类型</span>

<span class="c1">// NFT分发管理</span>
<span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nft</span><span class="o">-</span><span class="nx">distribution</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">分发NFT</span>
<span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nft</span><span class="o">-</span><span class="nx">distribution</span><span class="o">/:</span><span class="nx">nftType</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">获取NFT分发状态</span>
<span class="nx">PUT</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nft</span><span class="o">-</span><span class="nx">distribution</span><span class="o">/:</span><span class="nx">id</span><span class="o">/</span><span class="nx">status</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">更新分发状态</span>
<span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nft</span><span class="o">-</span><span class="nx">distribution</span><span class="o">/</span><span class="nx">batch</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">批量分发NFT</span>

<span class="c1">// NFT状态管理</span>
<span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nft</span><span class="o">-</span><span class="nx">states</span><span class="o">/:</span><span class="nx">nftType</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">获取NFT全局状态</span>
<span class="nx">PUT</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nft</span><span class="o">-</span><span class="nx">states</span><span class="o">/:</span><span class="nx">nftType</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">更新NFT状态</span>
<span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nft</span><span class="o">-</span><span class="nx">states</span><span class="o">/:</span><span class="nx">nftType</span><span class="o">/</span><span class="nx">transitions</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">执行状态转换</span>
<span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nft</span><span class="o">-</span><span class="nx">states</span><span class="o">/:</span><span class="nx">nftType</span><span class="o">/</span><span class="nx">history</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">获取状态变更历史</span>

<span class="c1">// NFT类型投票配置（投票项目属性接口）</span>
<span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nft</span><span class="o">-</span><span class="nx">voting</span><span class="o">-</span><span class="nx">config</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">创建</span><span class="o">/</span><span class="nx">更新NFT类型全局参数配置</span><span class="err">（</span><span class="nx">返回CID</span><span class="o">/</span><span class="nx">版本</span><span class="err">）</span>
<span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nft</span><span class="o">-</span><span class="nx">voting</span><span class="o">-</span><span class="nx">config</span><span class="o">/:</span><span class="nx">nftType</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">获取NFT类型全局参数配置</span>
<span class="nx">PUT</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nft</span><span class="o">-</span><span class="nx">voting</span><span class="o">-</span><span class="nx">config</span><span class="o">/:</span><span class="nx">nftType</span><span class="o">/</span><span class="nx">tiers</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">设置抽奖等级</span><span class="err">（</span><span class="nx">配置写入IPFS</span><span class="err">，</span><span class="nx">链上仅存CID</span><span class="err">）</span>
<span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nft</span><span class="o">-</span><span class="nx">voting</span><span class="o">-</span><span class="nx">config</span><span class="o">/:</span><span class="nx">nftType</span><span class="o">/</span><span class="nx">winning</span><span class="o">-</span><span class="nx">numbers</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">分配中奖序号</span><span class="err">（</span><span class="nx">结果摘要上链</span><span class="err">）</span>

<span class="c1">// NFT管理</span>
<span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nfts</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">创建投票NFT</span>
<span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nfts</span><span class="o">/:</span><span class="nx">tokenId</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">获取NFT信息</span>
<span class="nx">PUT</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nfts</span><span class="o">/:</span><span class="nx">tokenId</span><span class="o">/</span><span class="nx">winning</span><span class="o">-</span><span class="kt">number</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">更新中奖序号</span>
<span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">nfts</span><span class="o">/</span><span class="nx">verify</span><span class="o">/:</span><span class="nx">tokenId</span><span class="o">/:</span><span class="nx">owner</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">验证NFT所有权</span>

<span class="c1">// 代币验证</span>
<span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">tokens</span><span class="o">/</span><span class="nx">balance</span><span class="o">/:</span><span class="nx">address</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">查询代币余额</span>
<span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">tokens</span><span class="o">/</span><span class="nx">verify</span><span class="o">/:</span><span class="nx">address</span><span class="o">/:</span><span class="nx">amount</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">验证代币持有量</span>

<span class="c1">// 多目标选择管理</span>
<span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">multi</span><span class="o">-</span><span class="nx">target</span><span class="o">/</span><span class="nx">sessions</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">创建多目标选择会话</span>
<span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">multi</span><span class="o">-</span><span class="nx">target</span><span class="o">/</span><span class="nx">sessions</span><span class="o">/:</span><span class="nx">id</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">获取会话信息</span>
<span class="nx">PUT</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">multi</span><span class="o">-</span><span class="nx">target</span><span class="o">/</span><span class="nx">sessions</span><span class="o">/:</span><span class="nx">id</span><span class="o">/</span><span class="nx">status</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">更新会话状态</span>
<span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">multi</span><span class="o">-</span><span class="nx">target</span><span class="o">/</span><span class="nx">sessions</span><span class="o">/:</span><span class="nx">id</span><span class="o">/</span><span class="nx">participants</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">添加参与者</span>
<span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">multi</span><span class="o">-</span><span class="nx">target</span><span class="o">/</span><span class="nx">sessions</span><span class="o">/:</span><span class="nx">id</span><span class="o">/</span><span class="nx">commitments</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">提交承诺</span>
<span class="nx">POST</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">multi</span><span class="o">-</span><span class="nx">target</span><span class="o">/</span><span class="nx">sessions</span><span class="o">/:</span><span class="nx">id</span><span class="o">/</span><span class="nx">reveals</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">提交揭示</span>
<span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">multi</span><span class="o">-</span><span class="nx">target</span><span class="o">/</span><span class="nx">sessions</span><span class="o">/:</span><span class="nx">id</span><span class="o">/</span><span class="nx">winners</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">获取中奖结果</span>
<span class="nx">GET</span><span class="w"> </span><span class="o">/</span><span class="nx">api</span><span class="o">/</span><span class="nx">multi</span><span class="o">-</span><span class="nx">target</span><span class="o">/</span><span class="nx">sessions</span><span class="o">/:</span><span class="nx">id</span><span class="o">/</span><span class="nx">verification</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nx">验证会话完整性</span>
</code></pre></div>

<h3 id="52">5.2 智能合约事件扩展</h3>
<div class="codehilite"><pre><span></span><code><span class="c1">// NFT类型相关事件</span>
<span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;nft_type_created&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;nft_type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nft_type</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;creator&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">creator</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;application_category&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">category</span><span class="p">)</span>

<span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;nft_type_config_updated&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;nft_type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nft_type</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;config_version&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span>

<span class="c1">// NFT分发相关事件</span>
<span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;nft_distributed&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;nft_type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nft_type</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;recipient&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">recipient</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;distribution_strategy&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">strategy</span><span class="p">)</span>

<span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;batch_nft_distribution&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;nft_type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nft_type</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;batch_size&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">batch_size</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;distribution_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">distribution_id</span><span class="p">)</span>

<span class="c1">// NFT状态相关事件</span>
<span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;nft_state_updated&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;nft_type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nft_type</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;variable_name&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">variable_name</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;new_value&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">new_value</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;state_version&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">version</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span>

<span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;nft_state_transition&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;nft_type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nft_type</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;from_state&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">from_state</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;to_state&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">to_state</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;transition_trigger&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">trigger</span><span class="p">)</span>

<span class="c1">// 比特承诺状态控制事件</span>
<span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;commitment_state_checked&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;nft_type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nft_type</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;user_address&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user_address</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;commitment_allowed&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">allowed</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span>

<span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;commitment_state_updated&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;nft_type&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">nft_type</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;user_address&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user_address</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;commitment_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">commitment_id</span><span class="p">)</span>

<span class="c1">// 代币相关事件</span>
<span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;token_balance_verified&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;user_address&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">user_address</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;balance&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">balance</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;min_requirement&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">min_requirement</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span>

<span class="c1">// NFT相关事件</span>
<span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;voting_nft_created&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;token_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">token_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;voting_project_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">voting_project_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;owner&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">owner</span><span class="p">)</span>

<span class="c1">// 抽奖等级事件</span>
<span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;lottery_tiers_set&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;project_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">project_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;tier_count&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">tier_count</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span>

<span class="c1">// 中奖序号事件</span>
<span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;winning_numbers_assigned&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;project_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">project_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;winner_count&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">winner_count</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span>

<span class="c1">// 多目标选择事件</span>
<span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;multi_target_session_created&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;session_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">session_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;participant_count&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">participant_count</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;target_count&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">target_count</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span>

<span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;multi_target_commitment_submitted&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;session_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">session_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;participant_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">participant_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;commitment_hash&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">commitment_hash</span><span class="p">)</span>

<span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;multi_target_reveal_submitted&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;session_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">session_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;participant_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">participant_id</span><span class="p">.</span><span class="n">to_string</span><span class="p">())</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;reveal_hash&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">reveal_hash</span><span class="p">)</span>

<span class="n">Response</span>::<span class="n">new</span><span class="p">()</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;action&quot;</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;multi_target_winners_calculated&quot;</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;session_id&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">session_id</span><span class="p">)</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;winners&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">winners</span><span class="p">.</span><span class="n">join</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">))</span>
<span class="w">    </span><span class="p">.</span><span class="n">add_attribute</span><span class="p">(</span><span class="s">&quot;calculation_proof&quot;</span><span class="p">,</span><span class="w"> </span><span class="n">calculation_proof</span><span class="p">)</span>
</code></pre></div>

<h2 id="6">6. 安全设计</h2>
<h3 id="61-nft">6.1 NFT类型安全机制</h3>
<ul>
<li>验证NFT类型创建者权限</li>
<li>防止NFT类型配置被恶意修改</li>
<li>确保NFT类型之间的隔离性</li>
</ul>
<h3 id="62-nft">6.2 NFT分发安全机制</h3>
<ul>
<li>验证用户分发资格</li>
<li>防止NFT重复分发</li>
<li>确保分发过程的公平性</li>
</ul>
<h3 id="63-nft">6.3 NFT状态安全机制</h3>
<ul>
<li>验证状态变更权限</li>
<li>防止状态变量被恶意修改</li>
<li>确保状态转换的原子性</li>
</ul>
<h3 id="64">6.4 代币权限控制</h3>
<ul>
<li>验证用户代币持有量</li>
<li>防止代币余额操纵</li>
<li>支持代币锁定机制</li>
</ul>
<h3 id="65-nft">6.5 NFT安全机制</h3>
<ul>
<li>验证NFT所有权</li>
<li>防止NFT重复使用</li>
<li>确保NFT与投票项目的关联性</li>
</ul>
<h3 id="66">6.6 抽奖公平性保障</h3>
<ul>
<li>中奖序号生成算法透明</li>
<li>防止中奖结果操纵</li>
<li>支持结果验证和审计</li>
</ul>
<h3 id="67">6.7 多目标选择安全机制</h3>
<ul>
<li><strong>比特承诺保护</strong>：确保参与者选择值在揭示前不可见</li>
<li><strong>NFT状态验证</strong>：基于NFT状态变量验证操作权限</li>
<li><strong>AI代理授权</strong>：验证AI代理的操作权限和身份</li>
<li><strong>防重放攻击</strong>：使用时间戳和唯一标识防止重复操作</li>
<li><strong>数据完整性</strong>：IPFS和区块链双重验证确保数据不被篡改</li>
<li><strong>计算验证</strong>：提供完整的计算过程证明，支持第三方验证</li>
<li><strong>状态一致性</strong>：确保NFT状态在所有操作中保持一致</li>
</ul>
<h2 id="7">7. 性能优化</h2>
<h3 id="71-nft">7.1 NFT类型性能优化</h3>
<ul>
<li><strong>NFT类型缓存</strong>：缓存NFT类型定义和配置，减少重复查询</li>
<li><strong>类型预加载</strong>：预加载常用NFT类型，提高响应速度</li>
<li><strong>类型索引优化</strong>：为NFT类型建立高效索引，支持快速查找</li>
</ul>
<h3 id="72-nft">7.2 NFT分发性能优化</h3>
<ul>
<li><strong>批量分发处理</strong>：支持批量NFT分发，提高处理效率</li>
<li><strong>分发队列优化</strong>：优化分发队列管理，支持高并发分发</li>
<li><strong>资格验证缓存</strong>：缓存用户资格验证结果，减少重复验证</li>
</ul>
<h3 id="73-nft">7.3 NFT状态管理性能优化</h3>
<ul>
<li><strong>状态变更批处理</strong>：支持批量状态变更，减少网络往返</li>
<li><strong>状态缓存策略</strong>：实现多层状态缓存，提高状态查询性能</li>
<li><strong>状态同步优化</strong>：优化状态同步机制，确保状态一致性</li>
</ul>
<h3 id="74-nft">7.4 NFT批量操作</h3>
<ul>
<li>支持批量NFT创建</li>
<li>批量中奖序号分配</li>
<li>优化存储和查询性能</li>
</ul>
<h3 id="75">7.5 代币查询优化</h3>
<ul>
<li>缓存代币余额信息</li>
<li>批量代币验证</li>
<li>减少区块链查询次数</li>
</ul>
<h3 id="76">7.6 多目标选择性能优化</h3>
<ul>
<li><strong>并行处理</strong>：支持批量承诺和揭示操作，提高处理效率</li>
<li><strong>智能缓存</strong>：缓存会话状态和参与者信息，减少重复查询</li>
<li><strong>异步计算</strong>：中奖序号计算异步执行，不阻塞其他操作</li>
<li><strong>批量验证</strong>：支持批量承诺验证，减少网络往返次数</li>
<li><strong>连接池管理</strong>：优化IPFS和区块链连接，提高并发性能</li>
<li><strong>NFT状态优化</strong>：基于NFT状态变量优化计算流程</li>
</ul>
<h2 id="8">8. 部署架构</h2>
<h3 id="81">8.1 智能合约部署</h3>
<ul>
<li>代币合约部署</li>
<li>NFT合约部署</li>
<li>投票合约部署</li>
<li><strong>NFT类型管理合约部署</strong></li>
<li><strong>NFT状态管理合约部署</strong></li>
<li>合约间交互配置</li>
</ul>
<h3 id="82">8.2 前端集成</h3>
<ul>
<li>NFT钱包集成</li>
<li>代币余额显示</li>
<li><strong>NFT类型管理界面</strong></li>
<li><strong>NFT分发管理界面</strong></li>
<li><strong>NFT状态监控界面</strong></li>
<li>投票资格验证界面</li>
<li>抽奖等级管理界面</li>
</ul>
<h3 id="83">8.3 监控和维护</h3>
<ul>
<li><strong>NFT类型监控</strong>：监控NFT类型的创建、配置和状态</li>
<li><strong>NFT分发监控</strong>：监控NFT分发过程和成功率</li>
<li><strong>NFT状态监控</strong>：监控NFT状态变更和一致性</li>
<li>系统性能监控</li>
<li>安全事件监控</li>
</ul>
<p>这个概要设计说明书描述了完整的系统架构，包含NFT类型管理、NFT分发管理、NFT状态管理等核心功能模块，为系统的完整实现提供了技术指导。系统通过NFT类型控制不同应用场景，使用NFT分发替代用户注册功能，并通过NFT全局状态变量控制比特承诺功能，完全符合新的架构设计理念。</p>
</body>
</html>